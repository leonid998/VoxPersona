"""
–ú–æ–¥—É–ª—å –≤—ã–±–æ—Ä–∞ –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ü–µ–Ω–æ–∫ –æ—Ç—á–µ—Ç–æ–≤.

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —è–≤–ª—è–µ—Ç—Å—è –≤—Ç–æ—Ä–æ–π —á–∞—Å—Ç—å—é Router Agent –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞:
1. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É 22 –æ—Ç—á–µ—Ç–æ–≤ –≤ 7 –∏–Ω–¥–µ–∫—Å–æ–≤
2. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–æ–≤–æ–∫—É–ø–Ω–æ–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
3. –í—ã–±–æ—Ä –∏–Ω–¥–µ–∫—Å–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
- –ü–æ–ª—É—á–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–µ–π –æ—Ç—á–µ—Ç–æ–≤ –æ—Ç relevance_evaluator
- –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –æ—Ü–µ–Ω–∫–∏ –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º (—Å—Ä–µ–¥–Ω–µ–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ)
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
    from relevance_evaluator import evaluate_report_relevance
    from index_selector import select_most_relevant_index

    # –ü–æ–ª—É—á–∞–µ–º –æ—Ü–µ–Ω–∫–∏ –æ—Ç—á–µ—Ç–æ–≤
    report_relevance = evaluate_report_relevance(user_query)

    # –í—ã–±–∏—Ä–∞–µ–º –∏–Ω–¥–µ–∫—Å
    best_index = select_most_relevant_index(report_relevance)
    print(f"–í—ã–±—Ä–∞–Ω –∏–Ω–¥–µ–∫—Å: {best_index}")
"""

import logging
from typing import Dict, List, Optional, Tuple

logger = logging.getLogger(__name__)

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
RECOMMENDATIONS_HEADER = "üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –≤–∞—à–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞:\n"
RECOMMENDATIONS_FOOTER = "\n–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–π."
RECOMMENDATIONS_EMPTY_MESSAGE = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –≤–∞—à–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞."
DEFAULT_INDEX_EMOJI = "üìÅ"


# –ú–∞–ø–ø–∏–Ω–≥ –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ –æ—Ç—á–µ—Ç—ã (—Å–æ–≥–ª–∞—Å–Ω–æ files_list.md –∏ impl_plan.md)
# –í–ê–ñ–ù–û: –ò–º–µ–Ω–∞ –æ—Ç—á–µ—Ç–æ–≤ –î–û–õ–ñ–ù–´ —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥—É load_report_descriptions()
# –∏–∑ relevance_evaluator.py (–∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤).
# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å REPORT_TO_INDEX_MAPPING –≤ relevance_evaluator.py
INDEX_MAPPING: Dict[str, List[str]] = {
    # Dizayn (1 –æ—Ç—á–µ—Ç) - –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ_–î–∏–∑–∞–π–Ω
    "Dizayn": [
        "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π_–æ—Ç—á–µ—Ç_–∞—É–¥–∏—Ç–∞"
    ],
    # Intervyu (3 –æ—Ç—á–µ—Ç–∞) - –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ_–ò–Ω—Ç–µ—Ä–≤—å—é
    "Intervyu": [
        "–û–±—â–∏–µ_—Ñ–∞–∫—Ç–æ—Ä—ã",
        "–û—Ç—á–µ—Ç_–æ_—Å–≤—è–∑–∫–∞—Ö",
        "–§–∞–∫—Ç–æ—Ä—ã_–≤_—ç—Ç–æ–º_–∑–∞–≤–µ–¥–µ–Ω–∏–∏"
    ],
    # Iskhodniki_dizayn (1 –æ—Ç—á–µ—Ç) - –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ_–ò—Å—Ö–æ–¥–Ω–∏–∫–∏_–ê—É–¥–∏—Ç_–î–∏–∑–∞–π–Ω–∞
    "Iskhodniki_dizayn": [
        "–ê—É–¥–∏—Ç_–î–∏–∑–∞–π–Ω–∞"
    ],
    # Iskhodniki_obsledovanie (1 –æ—Ç—á–µ—Ç) - –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ_–ò—Å—Ö–æ–¥–Ω–∏–∫–∏_–û–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
    "Iskhodniki_obsledovanie": [
        "–û–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ"
    ],
    # Itogovye_otchety (6 –æ—Ç—á–µ—Ç–æ–≤) - –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ_–ò—Ç–æ–≥–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã
    "Itogovye_otchety": [
        "–ì–ª–∞–≤–Ω–∞—è",
        "–ó–∞–ø–æ–ª–Ω—è–µ–º–æ—Å—Ç—å_–∏_–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ",
        "–ò—Ç–æ–≥–æ–≤—ã–π_–æ—Ç—á–µ—Ç",
        "–û—Ç–¥—ã—Ö_–∏_–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ",
        "–û—â—É—â–µ–Ω–∏—è_–æ—Ç_–æ—Ç–µ–ª—è",
        "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏_–ø–æ_—É–ª—É—á—à–µ–Ω–∏—é"
    ],
    # Otchety_po_dizaynu (5 –æ—Ç—á–µ—Ç–æ–≤) - –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ_–î–∏–∑–∞–π–Ω –æ—Ç—á–µ—Ç—ã
    "Otchety_po_dizaynu": [
        "–î–∏–∑–∞–π–Ω_–∏_–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞",
        "–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏_–¥–∏–∑–∞–π–Ω–∞",
        "–û–∂–∏–¥–∞–Ω–∏—è_–∏_—Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å",
        "–ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è_–∫–æ–Ω—Ü–µ–ø—Ü–∏–∏_–∏_–¥–∏–∑–∞–π–Ω–∞",
        "–°–∏–ª—å–Ω—ã–µ_—Å—Ç–æ—Ä–æ–Ω—ã_–¥–∏–∑–∞–π–Ω–∞"
    ],
    # Otchety_po_obsledovaniyu (5 –æ—Ç—á–µ—Ç–æ–≤) - –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ_–û–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç—ã
    "Otchety_po_obsledovaniyu": [
        "–í–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω–æ—Å—Ç—å_–≥–æ—Å—Ç–∏–Ω–∏—á–Ω–æ–≥–æ_—Ö–æ–∑—è–π—Å—Ç–≤–∞",
        "–ö–∞—á–µ—Å—Ç–≤–æ_–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã",
        "–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π_–æ–ø—ã—Ç",
        "–ú–∞—Ä—à—Ä—É—Ç—ã_–∏_–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
        "–û–±—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ_–≥–æ—Å—Ç–∏–Ω–∏—á–Ω–æ–≥–æ_—Ö–æ–∑—è–π—Å—Ç–≤–∞"
    ]
}

# –ò–Ω–¥–µ–∫—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π)
DEFAULT_INDEX = "Dizayn"

# –ú–∞–ø–ø–∏–Ω–≥ –∫–æ—Ä–æ—Ç–∫–∏—Ö –∏–º–µ–Ω –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
# –§–ê–ó–ê 3: Router Agent - UI –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ handlers.py –∏ run_analysis.py
INDEX_DISPLAY_NAMES: Dict[str, str] = {
    "Dizayn": "–î–∏–∑–∞–π–Ω (–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—É–¥–∏—Ç—ã)",
    "Intervyu": "–ò–Ω—Ç–µ—Ä–≤—å—é (–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏)",
    "Otchety_po_dizaynu": "–û—Ç—á–µ—Ç—ã –ø–æ –¥–∏–∑–∞–π–Ω—É (60 –æ—Ç–µ–ª–µ–π –†–§)",
    "Otchety_po_obsledovaniyu": "–û—Ç—á–µ—Ç—ã –ø–æ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é (–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)",
    "Itogovye_otchety": "–ò—Ç–æ–≥–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã (–°–≤–æ–¥–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞)",
    "Iskhodniki_dizayn": "–ò—Å—Ö–æ–¥–Ω–∏–∫–∏ (–î–∏–∑–∞–π–Ω)",
    "Iskhodniki_obsledovanie": "–ò—Å—Ö–æ–¥–Ω–∏–∫–∏ (–û–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ)"
}

# –≠–º–æ–¥–∑–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ format_index_recommendations() –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≤ Telegram
INDEX_EMOJIS: Dict[str, str] = {
    "Dizayn": "üé®",
    "Intervyu": "üé§",
    "Otchety_po_dizaynu": "üìä",
    "Otchety_po_obsledovaniyu": "üîç",
    "Itogovye_otchety": "üè®",
    "Iskhodniki_dizayn": "üìê",
    "Iskhodniki_obsledovanie": "üìã"
}

# –ö—Ä–∞—Ç–∫–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ format_index_recommendations() –¥–ª—è –ø–æ—è—Å–Ω–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
INDEX_SHORT_DESCRIPTIONS: Dict[str, str] = {
    "Dizayn": "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—É–¥–∏—Ç—ã",
    "Intervyu": "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∏–Ω—Ç–µ—Ä–≤—å—é",
    "Otchety_po_dizaynu": "–ê–Ω–∞–ª–∏–∑ –¥–∏–∑–∞–π–Ω–∞ 60 –æ—Ç–µ–ª–µ–π",
    "Otchety_po_obsledovaniyu": "–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑",
    "Itogovye_otchety": "–°–≤–æ–¥–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞",
    "Iskhodniki_dizayn": "–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–∏–∑–∞–π–Ω–∞",
    "Iskhodniki_obsledovanie": "–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è"
}


def select_most_relevant_index(
    report_relevance: Dict[str, float],
    index_mapping: Optional[Dict[str, List[str]]] = None
) -> str:
    """
    –í—ã–±–∏—Ä–∞–µ—Ç –∏–Ω–¥–µ–∫—Å —Å –Ω–∞–∏–≤—ã—Å—à–µ–π —Å–æ–≤–æ–∫—É–ø–Ω–æ–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é.

    –ê–ª–≥–æ—Ä–∏—Ç–º:
    1. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞—Ö–æ–¥–∏–º –≤—Å–µ –µ–≥–æ –æ—Ç—á–µ—Ç—ã
    2. –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–µ–π –æ—Ç—á–µ—Ç–æ–≤ –∏–Ω–¥–µ–∫—Å–∞
    3. –í—ã–±–∏—Ä–∞–µ–º –∏–Ω–¥–µ–∫—Å —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–Ω–µ–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é
    4. –ü—Ä–∏ —Ä–∞–≤–Ω—ã—Ö –æ—Ü–µ–Ω–∫–∞—Ö –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É

    Args:
        report_relevance: –°–ª–æ–≤–∞—Ä—å {report_name: relevance_score} –æ—Ç relevance_evaluator.
                         –í—Å–µ –æ—Ü–µ–Ω–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [0, 1].
        index_mapping: –°–ª–æ–≤–∞—Ä—å {index_name: [report_names]} - –º–∞–ø–ø–∏–Ω–≥ –æ—Ç—á–µ—Ç–æ–≤ –Ω–∞ –∏–Ω–¥–µ–∫—Å—ã.
                      –ï—Å–ª–∏ None - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç INDEX_MAPPING –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

    Returns:
        str: –ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ —Å –Ω–∞–∏–≤—ã—Å—à–µ–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é.

    Raises:
        ValueError: –ï—Å–ª–∏ report_relevance –ø—É—Å—Ç–æ–π –∏–ª–∏ None.

    Examples:
        >>> report_rel = {
        ...     "–î–∏–∑–∞–π–Ω_–∏_–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞": 0.95,
        ...     "–°–∏–ª—å–Ω—ã–µ_—Å—Ç–æ—Ä–æ–Ω—ã_–¥–∏–∑–∞–π–Ω–∞": 0.90,
        ...     "–û–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ": 0.30
        ... }
        >>> select_most_relevant_index(report_rel)
        'Otchety_po_dizaynu'

        >>> # –ü—Ä–∏ —Ä–∞–≤–Ω—ã—Ö –æ—Ü–µ–Ω–∫–∞—Ö –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
        >>> report_rel = {
        ...     "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π_–æ—Ç—á–µ—Ç_–∞—É–¥–∏—Ç–∞": 0.5,
        ...     "–û–±—â–∏–µ_—Ñ–∞–∫—Ç–æ—Ä—ã": 0.5
        ... }
        >>> select_most_relevant_index(report_rel)
        'Dizayn'
    """
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    if not report_relevance:
        logger.error("–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–µ–π –æ—Ç—á–µ—Ç–æ–≤")
        raise ValueError("report_relevance –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–ø–ø–∏–Ω–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω
    mapping = index_mapping if index_mapping is not None else INDEX_MAPPING

    logger.info(f"–ù–∞—á–∏–Ω–∞–µ–º –≤—ã–±–æ—Ä –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ {len(report_relevance)} –æ—Ü–µ–Ω–æ–∫ –æ—Ç—á–µ—Ç–æ–≤")
    logger.debug(f"–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –æ—Ç—á–µ—Ç–æ–≤: {report_relevance}")

    # –í—ã—á–∏—Å–ª—è–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é)
    index_scores = _calculate_index_scores(report_relevance, mapping)

    # –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
    for index_name, score in index_scores.items():
        if score > 0:
            logger.debug(f"–ò–Ω–¥–µ–∫—Å '{index_name}': avg —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å = {score:.2f}")
        else:
            logger.warning(f"–ò–Ω–¥–µ–∫—Å '{index_name}': –Ω–∏ –æ–¥–∏–Ω –æ—Ç—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ report_relevance")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã –∏–º–µ—é—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å 0
    # –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ abs() –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è float –≤–º–µ—Å—Ç–æ ==
    # —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–æ–π
    if all(abs(score) < 1e-9 for score in index_scores.values()):
        logger.warning(
            "–í—Å–µ –∏–Ω–¥–µ–∫—Å—ã –∏–º–µ—é—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å 0.0, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω–¥–µ–∫—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
        )
        return DEFAULT_INDEX

    # –í—ã–±–∏—Ä–∞–µ–º –∏–Ω–¥–µ–∫—Å —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é
    # –ü—Ä–∏ —Ä–∞–≤–Ω—ã—Ö –æ—Ü–µ–Ω–∫–∞—Ö –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É (sorted –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º)
    best_index = max(
        sorted(index_scores.keys()),  # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–µ
        key=lambda idx: index_scores[idx]
    )
    best_score = index_scores[best_index]

    # –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ø-3 –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    top_3_indices = sorted(
        index_scores.items(),
        key=lambda x: (-x[1], x[0])  # –ü–æ —É–±—ã–≤–∞–Ω–∏—é score, –∑–∞—Ç–µ–º –ø–æ –∏–º–µ–Ω–∏
    )[:3]

    logger.info(f"–¢–æ–ø-3 –∏–Ω–¥–µ–∫—Å–∞:")
    for i, (idx, score) in enumerate(top_3_indices, 1):
        logger.info(f"  {i}. {idx}: {score:.4f}")

    logger.info(f"–í—ã–±—Ä–∞–Ω –∏–Ω–¥–µ–∫—Å: '{best_index}' —Å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é {best_score:.4f}")

    return best_index


def _calculate_index_scores(
    report_relevance: Dict[str, float],
    mapping: Dict[str, List[str]]
) -> Dict[str, float]:
    """
    –í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥–Ω—é—é —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞.

    –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ select_most_relevant_index
    –∏ get_top_relevant_indices –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞.

    Args:
        report_relevance: –°–ª–æ–≤–∞—Ä—å {report_name: relevance_score}.
        mapping: –°–ª–æ–≤–∞—Ä—å {index_name: [report_names]}.

    Returns:
        Dict[str, float]: –°–ª–æ–≤–∞—Ä—å {index_name: avg_score}.
    """
    index_scores: Dict[str, float] = {}

    for index_name, report_names in mapping.items():
        relevant_scores = [
            report_relevance[report_name]
            for report_name in report_names
            if report_name in report_relevance
        ]

        if relevant_scores:
            avg_score = sum(relevant_scores) / len(relevant_scores)
            index_scores[index_name] = avg_score
        else:
            index_scores[index_name] = 0.0

    return index_scores


def get_top_relevant_indices(
    report_relevance: Dict[str, float],
    index_mapping: Optional[Dict[str, List[str]]] = None,
    top_k: int = 3,
    min_score: float = 0.0
) -> List[tuple]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ø-K –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ —Å –∏—Ö scores.

    –†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –≤–º–µ—Å—Ç–æ –≤—ã–±–æ—Ä–∞ –æ–¥–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞,
    –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–æ–ø-K –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

    Args:
        report_relevance: –°–ª–æ–≤–∞—Ä—å {report_name: relevance_score} –æ—Ç relevance_evaluator.
        index_mapping: –°–ª–æ–≤–∞—Ä—å {index_name: [report_names]}.
        top_k: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3).
        min_score: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π score –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

    Returns:
        List[tuple]: –°–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π (index_name, score), –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ —É–±—ã–≤–∞–Ω–∏—é score.

    Example:
        >>> relevance = {"–î–∏–∑–∞–π–Ω_–∏_–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞": 95.0, "–û–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ": 30.0}
        >>> top = get_top_relevant_indices(relevance, top_k=3)
        >>> top[0]
        ('Otchety_po_dizaynu', 95.0)
    """
    if not report_relevance:
        logger.warning("–ü—É—Å—Ç–æ–π report_relevance, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫")
        return []

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–ø–ø–∏–Ω–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω
    mapping = index_mapping if index_mapping is not None else INDEX_MAPPING

    # –í—ã—á–∏—Å–ª—è–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ (AVG)
    index_scores = _calculate_index_scores(report_relevance, mapping)

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é score, –∑–∞—Ç–µ–º –ø–æ –∏–º–µ–Ω–∏ –¥–ª—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏
    sorted_indices = sorted(
        index_scores.items(),
        key=lambda x: (-x[1], x[0])
    )

    # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É score
    if min_score > 0:
        sorted_indices = [(idx, score) for idx, score in sorted_indices if score >= min_score]

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ø-K
    result = sorted_indices[:top_k]

    logger.info(f"–¢–æ–ø-{len(result)} —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤:")
    for i, (idx, score) in enumerate(result, 1):
        logger.info(f"  {i}. {idx}: {score:.2f}%")

    return result


def format_index_recommendations(
    top_indices: List[Tuple[str, float]],
    index_display_names: Optional[Dict[str, str]] = None
) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Telegram.

    –°–æ–∑–¥–∞–µ—Ç –∫—Ä–∞—Å–∏–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏,
    –∏—Ö —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö, —ç–º–æ–¥–∑–∏ –∏ –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ.

    –ê–ª–≥–æ—Ä–∏—Ç–º:
    1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ -> —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ)
    2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –ø–æ–ª—É—á–∞–µ—Ç:
       - –≠–º–æ–¥–∑–∏ –∏–∑ INDEX_EMOJIS
       - –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –∏–∑ index_display_names –∏–ª–∏ INDEX_DISPLAY_NAMES
       - –ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑ INDEX_SHORT_DESCRIPTIONS
    3. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É —Å –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏

    Args:
        top_indices: –°–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π (index_name, score) –æ—Ç get_top_relevant_indices().
                    Score –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [0, 1] –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã.
        index_display_names: –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –∏–º–µ–Ω –∏–Ω–¥–µ–∫—Å–æ–≤.
                            –ï—Å–ª–∏ None - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç INDEX_DISPLAY_NAMES –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

    Returns:
        str: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram.
             –ü—Ä–∏ –ø—É—Å—Ç–æ–º —Å–ø–∏—Å–∫–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.

    Examples:
        >>> top = [("Otchety_po_dizaynu", 0.853), ("Itogovye_otchety", 0.721)]
        >>> result = format_index_recommendations(top)
        >>> print(result)
        üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –≤–∞—à–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞:

        1. üìä –û—Ç—á–µ—Ç—ã –ø–æ –¥–∏–∑–∞–π–Ω—É (60 –æ—Ç–µ–ª–µ–π –†–§) (85.3%) - –ê–Ω–∞–ª–∏–∑ –¥–∏–∑–∞–π–Ω–∞ 60 –æ—Ç–µ–ª–µ–π
        2. üè® –ò—Ç–æ–≥–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã (–°–≤–æ–¥–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞) (72.1%) - –°–≤–æ–¥–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

        –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–π.

        >>> # –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
        >>> format_index_recommendations([])
        '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –≤–∞—à–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.'

        >>> # –û–¥–∏–Ω –∏–Ω–¥–µ–∫—Å
        >>> format_index_recommendations([("Dizayn", 0.95)])
        'üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –≤–∞—à–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞:...'
    """
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞
    if not top_indices:
        logger.warning("–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
        return RECOMMENDATIONS_EMPTY_MESSAGE

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∏–º–µ–Ω–∞ –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
    display_names = index_display_names if index_display_names is not None else INDEX_DISPLAY_NAMES

    logger.info(f"–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è {len(top_indices)} –∏–Ω–¥–µ–∫—Å–æ–≤")

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
    recommendation_lines = []

    for i, (index_name, score) in enumerate(top_indices, 1):
        # –ü–æ–ª—É—á–∞–µ–º —ç–º–æ–¥–∑–∏ –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞ (–∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π)
        emoji = INDEX_EMOJIS.get(index_name, DEFAULT_INDEX_EMOJI)

        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –∏–Ω–¥–µ–∫—Å–∞
        display_name = display_names.get(index_name, index_name)

        # –ü–æ–ª—É—á–∞–µ–º –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
        description = INDEX_SHORT_DESCRIPTIONS.get(index_name, "")

        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º score –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã (–µ—Å–ª–∏ score <= 1, —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ 100)
        # –ï—Å–ª–∏ score —É–∂–µ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (> 1), –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
        percent = score * 100 if score <= 1 else score

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        # –§–æ—Ä–º–∞—Ç: "1. üìä –û—Ç—á–µ—Ç—ã –ø–æ –¥–∏–∑–∞–π–Ω—É (60 –æ—Ç–µ–ª–µ–π –†–§) (85.3%) - –ê–Ω–∞–ª–∏–∑ –¥–∏–∑–∞–π–Ω–∞ 60 –æ—Ç–µ–ª–µ–π"
        line = f"{i}. {emoji} {display_name} ({percent:.1f}%)"

        # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
        if description:
            line += f" - {description}"

        recommendation_lines.append(line)

        logger.debug(f"–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è {i}: {index_name} = {percent:.1f}%")

    # –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    recommendations = "\n".join(recommendation_lines)
    result = f"{RECOMMENDATIONS_HEADER}\n{recommendations}\n{RECOMMENDATIONS_FOOTER}"

    logger.info("–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω—ã")

    return result


def validate_index_mapping(
    index_mapping: Dict[str, List[str]],
    available_rags: Optional[List[str]] = None
) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –º–∞–ø–ø–∏–Ω–≥–∞ –∏–Ω–¥–µ–∫—Å–æ–≤.

    –ü—Ä–æ–≤–µ—Ä–∫–∏:
    1. –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã –∏–∑ –º–∞–ø–ø–∏–Ω–≥–∞ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ available_rags (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω)
    2. –ù–µ—Ç –ø—É—Å—Ç—ã—Ö —Å–ø–∏—Å–∫–æ–≤ –æ—Ç—á–µ—Ç–æ–≤
    3. –ù–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –æ—Ç—á–µ—Ç–æ–≤ –º–µ–∂–¥—É –∏–Ω–¥–µ–∫—Å–∞–º–∏

    Args:
        index_mapping: –°–ª–æ–≤–∞—Ä—å {index_name: [report_names]} –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
        available_rags: –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö RAG –∏–Ω–¥–µ–∫—Å–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).
                       –ï—Å–ª–∏ None - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è.

    Returns:
        bool: True –µ—Å–ª–∏ –º–∞–ø–ø–∏–Ω–≥ –≤–∞–ª–∏–¥–Ω—ã–π, False –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ.

    Examples:
        >>> mapping = {
        ...     "Index1": ["Report1", "Report2"],
        ...     "Index2": ["Report3"]
        ... }
        >>> validate_index_mapping(mapping)
        True

        >>> # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ RAG
        >>> validate_index_mapping(mapping, available_rags=["Index1", "Index2"])
        True

        >>> # –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ - –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
        >>> mapping = {"Index1": []}
        >>> validate_index_mapping(mapping)
        False
    """
    if not index_mapping:
        logger.error("–ú–∞–ø–ø–∏–Ω–≥ –∏–Ω–¥–µ–∫—Å–æ–≤ –ø—É—Å—Ç")
        return False

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –°—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ available_rags
    if available_rags is not None:
        missing_indices = set(index_mapping.keys()) - set(available_rags)
        if missing_indices:
            logger.error(
                f"–ò–Ω–¥–µ–∫—Å—ã –∏–∑ –º–∞–ø–ø–∏–Ω–≥–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ available_rags: {missing_indices}"
            )
            return False

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ù–µ—Ç –ø—É—Å—Ç—ã—Ö —Å–ø–∏—Å–∫–æ–≤ –æ—Ç—á–µ—Ç–æ–≤
    for index_name, report_names in index_mapping.items():
        if not report_names:
            logger.error(f"–ò–Ω–¥–µ–∫—Å '{index_name}' –∏–º–µ–µ—Ç –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –æ—Ç—á–µ—Ç–æ–≤")
            return False

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ù–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –æ—Ç—á–µ—Ç–æ–≤ –º–µ–∂–¥—É –∏–Ω–¥–µ–∫—Å–∞–º–∏
    all_reports = []
    for report_names in index_mapping.values():
        all_reports.extend(report_names)

    if len(all_reports) != len(set(all_reports)):
        duplicates = [
            report for report in set(all_reports)
            if all_reports.count(report) > 1
        ]
        logger.error(f"–î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –æ—Ç—á–µ—Ç—ã –º–µ–∂–¥—É –∏–Ω–¥–µ–∫—Å–∞–º–∏: {duplicates}")
        return False

    logger.info(f"–ú–∞–ø–ø–∏–Ω–≥ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤–∞–ª–∏–¥–µ–Ω: {len(index_mapping)} –∏–Ω–¥–µ–∫—Å–æ–≤, "
                f"{len(all_reports)} –æ—Ç—á–µ—Ç–æ–≤")
    return True


def load_index_mapping_from_file(filepath: str = "Description/files_list.md") -> Dict[str, List[str]]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–∞–ø–ø–∏–Ω–≥ –∏–Ω–¥–µ–∫—Å–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞ files_list.md.

    –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ —è–≤–ª—è–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–æ–π –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è.
    –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π INDEX_MAPPING.

    –ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
    1. –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–æ–≤ –∏–∑ files_list.md
    2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ –æ—Ç—á–µ—Ç—ã
    3. –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ–∂–∏–¥–∞–µ–º–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É

    Args:
        filepath: –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É files_list.md –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞.

    Returns:
        Dict[str, List[str]]: –ú–∞–ø–ø–∏–Ω–≥ –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ –æ—Ç—á–µ—Ç—ã.

    Raises:
        NotImplementedError: –§—É–Ω–∫—Ü–∏—è –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏.

    TODO:
        - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ Markdown —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        - –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
        - –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    """
    raise NotImplementedError(
        "–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–ø–ø–∏–Ω–≥–∞ –∏–∑ —Ñ–∞–π–ª–∞ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞. "
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ INDEX_MAPPING –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é."
    )


def get_index_statistics(index_mapping: Optional[Dict[str, List[str]]] = None) -> Dict[str, int]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –º–∞–ø–ø–∏–Ω–≥—É –∏–Ω–¥–µ–∫—Å–æ–≤.

    –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –æ—Ç—á–µ—Ç–æ–≤.

    Args:
        index_mapping: –°–ª–æ–≤–∞—Ä—å {index_name: [report_names]}.
                      –ï—Å–ª–∏ None - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç INDEX_MAPPING –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

    Returns:
        Dict[str, int]: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∏–¥–∞ {index_name: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_–æ—Ç—á–µ—Ç–æ–≤}.

    Examples:
        >>> get_index_statistics()
        {
            'Dizayn': 1,
            'Intervyu': 3,
            'Iskhodniki_dizayn': 1,
            'Iskhodniki_obsledovanie': 1,
            'Itogovye_otchety': 6,
            'Otchety_po_dizaynu': 5,
            'Otchety_po_obsledovaniyu': 5
        }
    """
    mapping = index_mapping if index_mapping is not None else INDEX_MAPPING

    stats = {
        index_name: len(report_names)
        for index_name, report_names in mapping.items()
    }

    total_reports = sum(stats.values())
    logger.debug(f"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤: {stats}, –≤—Å–µ–≥–æ –æ—Ç—á–µ—Ç–æ–≤: {total_reports}")

    return stats


if __name__ == "__main__":
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    logging.basicConfig(
        level=logging.INFO,
        format='%(levelname)s - %(name)s - %(message)s'
    )

    # –ü—Ä–∏–º–µ—Ä 1: –ë–∞–∑–æ–≤—ã–π –≤—ã–±–æ—Ä –∏–Ω–¥–µ–∫—Å–∞
    print("=== –ü—Ä–∏–º–µ—Ä 1: –ë–∞–∑–æ–≤—ã–π –≤—ã–±–æ—Ä –∏–Ω–¥–µ–∫—Å–∞ ===")
    report_rel = {
        "–î–∏–∑–∞–π–Ω_–∏_–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞": 0.95,
        "–°–∏–ª—å–Ω—ã–µ_—Å—Ç–æ—Ä–æ–Ω—ã_–¥–∏–∑–∞–π–Ω–∞": 0.90,
        "–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏_–¥–∏–∑–∞–π–Ω–∞": 0.85,
        "–û–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ": 0.30
    }
    result = select_most_relevant_index(report_rel)
    print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {result}\n")

    # –ü—Ä–∏–º–µ—Ä 2: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤
    print("=== –ü—Ä–∏–º–µ—Ä 2: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ ===")
    stats = get_index_statistics()
    for idx, count in sorted(stats.items()):
        print(f"{idx}: {count} –æ—Ç—á–µ—Ç–æ–≤")
    print(f"–í—Å–µ–≥–æ –æ—Ç—á–µ—Ç–æ–≤: {sum(stats.values())}\n")

    # –ü—Ä–∏–º–µ—Ä 3: –í–∞–ª–∏–¥–∞—Ü–∏—è –º–∞–ø–ø–∏–Ω–≥–∞
    print("=== –ü—Ä–∏–º–µ—Ä 3: –í–∞–ª–∏–¥–∞—Ü–∏—è –º–∞–ø–ø–∏–Ω–≥–∞ ===")
    is_valid = validate_index_mapping(INDEX_MAPPING)
    print(f"–ú–∞–ø–ø–∏–Ω–≥ –≤–∞–ª–∏–¥–µ–Ω: {is_valid}\n")

    # –ü—Ä–∏–º–µ—Ä 4: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
    print("=== –ü—Ä–∏–º–µ—Ä 4: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π ===")
    top_indices = get_top_relevant_indices(report_rel, top_k=3)
    formatted = format_index_recommendations(top_indices)
    print(formatted)
