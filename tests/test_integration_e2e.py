"""
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ E2E —Ç–µ—Å—Ç—ã –¥–ª—è Router Agent —Å–∏—Å—Ç–µ–º—ã VoxPersona.

–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π workflow Router Agent:
1. –û—Ü–µ–Ω–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ 22 –æ—Ç—á–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ Claude Haiku 4.5 API (1 batch –∑–∞–ø—Ä–æ—Å)
2. –í—ã–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –∏–∑ 7 –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
3. –£–ª—É—á—à–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
4. Fallback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

–¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ API –≤—ã–∑–æ–≤—ã (–æ—Ç–º–µ—á–µ–Ω—ã @pytest.mark.slow).
–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –±–µ–∑ API: pytest -m "not slow"

–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤:
    pytest tests/test_integration_e2e.py -v

–ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä—ã—Ö —Ç–µ—Å—Ç–æ–≤:
    pytest tests/test_integration_e2e.py -v -m "not slow"

–ó–∞–ø—É—Å–∫ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –≤—ã–≤–æ–¥–æ–º:
    pytest tests/test_integration_e2e.py -v -s

–ê–≤—Ç–æ—Ä: fullstack-developer
–î–∞—Ç–∞: 20 –Ω–æ—è–±—Ä—è 2025
–û–±–Ω–æ–≤–ª–µ–Ω–æ: 21 –Ω–æ—è–±—Ä—è 2025 (batch –º–µ—Ö–∞–Ω–∏–∑–º)
–ü—Ä–æ–µ–∫—Ç: VoxPersona Router Agent E2E Tests
"""

import asyncio
import json
import sys
import time
from pathlib import Path
from typing import Dict, List, Any
from unittest.mock import patch, AsyncMock, MagicMock

import pytest

# –î–æ–±–∞–≤–∏—Ç—å src –≤ PYTHONPATH –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

# –ò–º–ø–æ—Ä—Ç —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π Router Agent
from relevance_evaluator import (
    evaluate_report_relevance,
    load_report_descriptions,
    # –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤ batch-–º–µ—Ö–∞–Ω–∏–∑–º–∞
    build_json_container,
    parse_batch_response,
    validate_batch_evaluations,
    convert_evaluations_to_dict,
    evaluate_batch_relevance,
    REPORT_TO_INDEX_MAPPING
)
from index_selector import (
    select_most_relevant_index,
    get_top_relevant_indices,
    validate_index_mapping,
    get_index_statistics,
    INDEX_MAPPING,
    INDEX_DISPLAY_NAMES,
    DEFAULT_INDEX
)
from question_enhancer import enhance_question_for_index

# –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–∏—Å–∞–Ω–∏–π –∏–∑ run_analysis
from run_analysis import load_all_report_descriptions


# ============================================================================
# –§–∏–∫—Å—Ç—É—Ä—ã
# ============================================================================

@pytest.fixture
def golden_dataset() -> List[Dict[str, Any]]:
    """
    –ó–∞–≥—Ä—É–∑–∫–∞ golden dataset –∏–∑ —Ñ–∞–π–ª–∞ tests/golden_dataset.json.

    –°–æ–¥–µ—Ä–∂–∏—Ç 21 –≤–æ–ø—Ä–æ—Å —Å –æ–∂–∏–¥–∞–µ–º—ã–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏ Router Agent.

    Returns:
        List[Dict]: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –ø–æ–ª—è–º–∏:
            - question: –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            - expected_index: –æ–∂–∏–¥–∞–µ–º—ã–π –∏–Ω–¥–µ–∫—Å
            - reasoning: –ø–æ—è—Å–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞

    Example:
        >>> dataset = golden_dataset()
        >>> len(dataset)
        21
        >>> dataset[0]["expected_index"] in INDEX_MAPPING
        True
    """
    golden_path = Path(__file__).parent / "golden_dataset.json"

    if not golden_path.exists():
        pytest.skip(f"Golden dataset –Ω–µ –Ω–∞–π–¥–µ–Ω: {golden_path}")

    with open(golden_path, "r", encoding="utf-8") as f:
        data = json.load(f)

    return data


@pytest.fixture
def mock_report_descriptions() -> Dict[str, str]:
    """
    –ú–æ–∫–æ–≤—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è 22 –æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –±–µ–∑ API –≤—ã–∑–æ–≤–æ–≤.

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è unit-—Ç–µ—Å—Ç–æ–≤ –∏ –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–∏–∫–∏ –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ.

    Returns:
        Dict[str, str]: –°–ª–æ–≤–∞—Ä—å {–∏–º—è_–æ—Ç—á–µ—Ç–∞: –æ–ø–∏—Å–∞–Ω–∏–µ}
    """
    return {
        # Dizayn (1 –æ—Ç—á–µ—Ç)
        "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π_–æ—Ç—á–µ—Ç_–∞—É–¥–∏—Ç–∞": "–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∏–∑–∞–π–Ω–∞ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ –æ—Ç–µ–ª—è...",

        # Intervyu (3 –æ—Ç—á–µ—Ç–∞)
        "–û–±—â–∏–µ_—Ñ–∞–∫—Ç–æ—Ä—ã": "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–ª—É–±–∏–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤—å—é —Å –≥–æ—Å—Ç—è–º–∏ –æ—Ç–µ–ª—è...",
        "–û—Ç—á–µ—Ç_–æ_—Å–≤—è–∑–∫–∞—Ö": "–ê–Ω–∞–ª–∏–∑ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–µ–π –º–µ–∂–¥—É —Ñ–∞–∫—Ç–æ—Ä–∞–º–∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏...",
        "–§–∞–∫—Ç–æ—Ä—ã_–≤_—ç—Ç–æ–º_–∑–∞–≤–µ–¥–µ–Ω–∏–∏": "–°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è...",

        # Iskhodniki_dizayn (1 –æ—Ç—á–µ—Ç)
        "–ê—É–¥–∏—Ç_–î–∏–∑–∞–π–Ω–∞": "–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞—É–¥–∏—Ç–∞ –¥–∏–∑–∞–π–Ω–∞, –∑–∞–º–µ—Ä—ã, —Ñ–æ—Ç–æ...",

        # Iskhodniki_obsledovanie (1 –æ—Ç—á–µ—Ç)
        "–û–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ": "–ü–µ—Ä–≤–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã...",

        # Itogovye_otchety (6 –æ—Ç—á–µ—Ç–æ–≤)
        "–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ": "–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –æ—Ç–µ–ª—è...",
        "–û—â—É—â–µ–Ω–∏—è –æ—Ç –æ—Ç–µ–ª—è": "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ—â—É—â–µ–Ω–∏—è –∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è –æ—Ç –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è...",
        "–ó–∞–ø–æ–ª–Ω—è–µ–º–æ—Å—Ç—å_–∏_–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "–ê–Ω–∞–ª–∏–∑ –∑–∞–ø–æ–ª–Ω—è–µ–º–æ—Å—Ç–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–µ–ª—è...",
        "–ò—Ç–æ–≥–æ–≤—ã–π": "–ò—Ç–æ–≥–æ–≤—ã–π —Å–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –≤—Å–µ–º –∞—Å–ø–µ–∫—Ç–∞–º...",
        "–û—Ç–¥—ã—Ö_–∏_–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ": "–ê–Ω–∞–ª–∏–∑ –∑–æ–Ω –æ—Ç–¥—ã—Ö–∞ –∏ —Ä–µ–ª–∞–∫—Å–∞—Ü–∏–∏...",
        "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏": "–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é...",

        # Otchety_po_dizaynu (5 –æ—Ç—á–µ—Ç–æ–≤)
        "–î–∏–∑–∞–π–Ω –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞": "–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∏–∑–∞–π–Ω–∞ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π...",
        "–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã": "–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –¥–∏–∑–∞–π–Ω–∞ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞...",
        "–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏": "–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ –∏ –ø—Ä–æ–±–ª–µ–º—ã –¥–∏–∑–∞–π–Ω–∞...",
        "–û–∂–∏–¥–∞–Ω–∏—è": "–ê–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –æ–∂–∏–¥–∞–Ω–∏—è–º –≥–æ—Å—Ç–µ–π...",
        "–ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è": "–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è...",

        # Otchety_po_obsledovaniyu (5 –æ—Ç—á–µ—Ç–æ–≤)
        "–í–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω–æ—Å—Ç—å_–≥–æ—Å—Ç–∏–Ω–∏—á–Ω–æ–≥–æ_—Ö–æ–∑—è–π—Å—Ç–≤–∞": "–ê–Ω–∞–ª–∏–∑ –≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —É—Å–ª—É–≥ –∏ —Å–µ—Ä–≤–∏—Å–æ–≤...",
        "–ö–∞—á–µ—Å—Ç–≤–æ_–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã": "–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∏–Ω–∂–µ–Ω–µ—Ä–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã...",
        "–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π_–æ–ø—ã—Ç": "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞ –∏ UX...",
        "–ú–∞—Ä—à—Ä—É—Ç—ã_–∏_–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å": "–ê–Ω–∞–ª–∏–∑ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –¥–≤–∏–∂–µ–Ω–∏—è –≥–æ—Å—Ç–µ–π –ø–æ –æ—Ç–µ–ª—é...",
        "–û–±—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ_–≥–æ—Å—Ç–∏–Ω–∏—á–Ω–æ–≥–æ_—Ö–æ–∑—è–π—Å—Ç–≤–∞": "–û—Ü–µ–Ω–∫–∞ –æ–±—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ —ç—Ä–≥–æ–Ω–æ–º–∏–∫–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤..."
    }


@pytest.fixture
def mock_rags() -> Dict[str, Any]:
    """
    –ú–æ–∫–æ–≤—ã–π —Å–ª–æ–≤–∞—Ä—å –∏–∑ 7 RAG –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–æ–≤.

    –ò–º–∏—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–µ–∞–ª—å–Ω—ã—Ö RAG –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ.

    Returns:
        Dict[str, Any]: –°–ª–æ–≤–∞—Ä—å —Å 7 –∏–Ω–¥–µ–∫—Å–∞–º–∏
    """
    return {
        "–î–∏–∑–∞–π–Ω": {"name": "Dizayn", "count": 100},
        "–ò–Ω—Ç–µ—Ä–≤—å—é": {"name": "Intervyu", "count": 150},
        "–ò—Å—Ö–æ–¥–Ω–∏–∫–∏ –¥–∏–∑–∞–π–Ω": {"name": "Iskhodniki_dizayn", "count": 50},
        "–ò—Å—Ö–æ–¥–Ω–∏–∫–∏ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ": {"name": "Iskhodniki_obsledovanie", "count": 75},
        "–ò—Ç–æ–≥–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã": {"name": "Itogovye_otchety", "count": 200},
        "–û—Ç—á–µ—Ç—ã –ø–æ –¥–∏–∑–∞–π–Ω—É": {"name": "Otchety_po_dizaynu", "count": 180},
        "–û—Ç—á–µ—Ç—ã –ø–æ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é": {"name": "Otchety_po_obsledovaniyu", "count": 160}
    }


@pytest.fixture
def expected_indices() -> List[str]:
    """
    –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–∂–∏–¥–∞–µ–º—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –∏–Ω–¥–µ–∫—Å–æ–≤.

    Returns:
        List[str]: 7 –Ω–∞–∑–≤–∞–Ω–∏–π –∏–Ω–¥–µ–∫—Å–æ–≤ Router Agent
    """
    return [
        "Dizayn",
        "Intervyu",
        "Iskhodniki_dizayn",
        "Iskhodniki_obsledovanie",
        "Itogovye_otchety",
        "Otchety_po_dizaynu",
        "Otchety_po_obsledovaniyu"
    ]


# ============================================================================
# Test 1: –ü–æ–ª–Ω—ã–π workflow Router Agent (—Å —Ä–µ–∞–ª—å–Ω—ã–º API)
# ============================================================================

@pytest.mark.asyncio
@pytest.mark.slow
async def test_full_router_workflow():
    """
    –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ Router Agent: –≤–æ–ø—Ä–æ—Å -> –æ—Ü–µ–Ω–∫–∞ -> –≤—ã–±–æ—Ä -> —É–ª—É—á—à–µ–Ω–∏–µ.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö 22 –æ–ø–∏—Å–∞–Ω–∏–π –æ—Ç—á–µ—Ç–æ–≤
    - –û—Ü–µ–Ω–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ Claude Haiku API (1 batch –∑–∞–ø—Ä–æ—Å)
    - –í—ã–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
    - –£–ª—É—á—à–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞

    –¢—Ä–µ–±—É–µ—Ç:
    - ANTHROPIC_API_KEY –≤ .env
    - –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—é Description/Report content/ —Å —Ñ–∞–π–ª–∞–º–∏ –æ–ø–∏—Å–∞–Ω–∏–π

    Note:
        –¢–µ—Å—Ç –ø–æ–º–µ—á–µ–Ω @pytest.mark.slow - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Å -m "not slow"
    """
    question = "–ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Å–≤–µ—â–µ–Ω–∏–µ–º –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ"

    # –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–∏—Å–∞–Ω–∏–π –æ—Ç—á–µ—Ç–æ–≤
    try:
        report_descriptions = load_all_report_descriptions()
    except FileNotFoundError:
        pytest.skip("–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –æ—Ç—á–µ—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")

    assert len(report_descriptions) == 22, \
        f"–û–∂–∏–¥–∞–ª–æ—Å—å 22 –æ–ø–∏—Å–∞–Ω–∏—è, –∑–∞–≥—Ä—É–∂–µ–Ω–æ {len(report_descriptions)}"

    # –®–∞–≥ 2: –û—Ü–µ–Ω–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –æ—Ç—á–µ—Ç–æ–≤ (1 batch API –∑–∞–ø—Ä–æ—Å)
    relevance = await evaluate_report_relevance(question, report_descriptions)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ü–µ–Ω–∫–∏
    assert len(relevance) == 22, \
        f"–û–∂–∏–¥–∞–ª–æ—Å—å 22 –æ—Ü–µ–Ω–∫–∏, –ø–æ–ª—É—á–µ–Ω–æ {len(relevance)}"
    assert all(0 <= score <= 100 for score in relevance.values()), \
        "–í—Å–µ –æ—Ü–µ–Ω–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [0, 100]"

    # –í—ã–≤–æ–¥ —Ç–æ–ø-5 –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤
    top_5 = sorted(relevance.items(), key=lambda x: x[1], reverse=True)[:5]
    print(f"\nüìä –¢–æ–ø-5 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ '{question}':")
    for rank, (name, score) in enumerate(top_5, 1):
        print(f"  {rank}. {name}: {score:.1f}%")

    # –®–∞–≥ 3: –í—ã–±–æ—Ä –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
    index = select_most_relevant_index(relevance, INDEX_MAPPING)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—ã–±—Ä–∞–Ω –≤–∞–ª–∏–¥–Ω—ã–π –∏–Ω–¥–µ–∫—Å
    assert index in INDEX_MAPPING, \
        f"–í—ã–±—Ä–∞–Ω –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å: {index}"
    print(f"\n‚úÖ –í—ã–±—Ä–∞–Ω –∏–Ω–¥–µ–∫—Å: {index}")

    # –®–∞–≥ 4: –£–ª—É—á—à–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
    enhanced = enhance_question_for_index(question, index, report_descriptions)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    assert len(enhanced) > len(question), \
        f"–£–ª—É—á—à–µ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ: {len(enhanced)} <= {len(question)}"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
    question_lower = question.lower()
    enhanced_lower = enhanced.lower()

    # –•–æ—Ç—è –±—ã –æ–¥–Ω–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å
    keywords_found = any(
        keyword in enhanced_lower
        for keyword in ["–æ—Å–≤–µ—â", "—Å–≤–µ—Ç", "—Ä–µ—Å—Ç–æ—Ä–∞–Ω", "–ø—Ä–æ–±–ª–µ–º"]
    )
    assert keywords_found, \
        f"–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —É–ª—É—á—à–µ–Ω–Ω–æ–º –≤–æ–ø—Ä–æ—Å–µ: {enhanced}"

    print(f"\nüìù –ò—Å—Ö–æ–¥–Ω—ã–π –≤–æ–ø—Ä–æ—Å ({len(question)} —Å–∏–º–≤.): {question}")
    print(f"üìù –£–ª—É—á—à–µ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å ({len(enhanced)} —Å–∏–º–≤.): {enhanced}")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã (–æ–∂–∏–¥–∞–µ—Ç—Å—è 150-300 —Å–∏–º–≤–æ–ª–æ–≤)
    assert 50 <= len(enhanced) <= 500, \
        f"–î–ª–∏–Ω–∞ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –≤–Ω–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞: {len(enhanced)}"


# ============================================================================
# Test 2: –¢–µ—Å—Ç –Ω–∞ golden dataset (>=80% —Ç–æ—á–Ω–æ—Å—Ç–∏)
# ============================================================================

@pytest.mark.asyncio
@pytest.mark.slow
async def test_router_on_golden_dataset(golden_dataset):
    """
    –¢–µ—Å—Ç Router Agent –Ω–∞ —ç—Ç–∞–ª–æ–Ω–Ω–æ–º –Ω–∞–±–æ—Ä–µ –∏–∑ 21 –≤–æ–ø—Ä–æ—Å–∞.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - Recall@3: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤ —Ç–æ–ø-3 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö >= 80%
    - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    - –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

    Args:
        golden_dataset: –§–∏–∫—Å—Ç—É—Ä–∞ —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –æ–∂–∏–¥–∞–µ–º—ã–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏

    Note:
        –¢–µ—Å—Ç –ø–æ–º–µ—á–µ–Ω @pytest.mark.slow - –∑–∞–Ω–∏–º–∞–µ—Ç ~60-90 —Å–µ–∫—É–Ω–¥
        –ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç 1 batch API –∑–∞–ø—Ä–æ—Å –∫ Claude Haiku
    """
    # –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–∏—Å–∞–Ω–∏–π –æ—Ç—á–µ—Ç–æ–≤
    try:
        report_descriptions = load_all_report_descriptions()
    except FileNotFoundError:
        pytest.skip("–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –æ—Ç—á–µ—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")

    correct_at_1 = 0  # Accuracy@1 - —Ç–æ—á–Ω—ã–π –≤—ã–±–æ—Ä
    correct_at_3 = 0  # Recall@3 - –≤ —Ç–æ–ø-3
    total = len(golden_dataset)
    results = []

    print(f"\nüîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Router Agent (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º) –Ω–∞ {total} –≤–æ–ø—Ä–æ—Å–∞—Ö...")

    for i, item in enumerate(golden_dataset, 1):
        question = item["question"]
        expected_index = item["expected_index"]

        # –ó–∞–ø—É—Å–∫–∞–µ–º Router Agent - –ø–æ–ª—É—á–∞–µ–º —Ç–æ–ø-3 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (1 batch –∑–∞–ø—Ä–æ—Å)
        relevance = await evaluate_report_relevance(question, report_descriptions)
        top_indices = get_top_relevant_indices(relevance, INDEX_MAPPING, top_k=3)

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –∏–∑ —Ç–æ–ø-3
        top_3_names = [idx for idx, score in top_indices]
        selected_index = top_3_names[0] if top_3_names else DEFAULT_INDEX

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º accuracy@1 –∏ recall@3
        is_correct_at_1 = selected_index == expected_index
        is_correct_at_3 = expected_index in top_3_names

        if is_correct_at_1:
            correct_at_1 += 1
        if is_correct_at_3:
            correct_at_3 += 1

        results.append({
            "question": question,
            "expected": expected_index,
            "selected": selected_index,
            "top_3": top_3_names,
            "correct_at_1": is_correct_at_1,
            "correct_at_3": is_correct_at_3,
            "top_scores": top_indices
        })

        # –ü—Ä–æ–≥—Ä–µ—Å—Å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º recall@3
        status = "‚úÖ" if is_correct_at_3 else "‚ùå"
        at_1_mark = "üéØ" if is_correct_at_1 else ""
        print(f"  [{i}/{total}] {status}{at_1_mark} {question[:45]}...")

    accuracy_at_1 = correct_at_1 / total * 100
    recall_at_3 = correct_at_3 / total * 100

    # –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
    print(f"\n" + "="*60)
    print(f"üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø ROUTER AGENT")
    print(f"="*60)
    print(f"\nüìà –ú–µ—Ç—Ä–∏–∫–∏:")
    print(f"  ‚Ä¢ Accuracy@1: {accuracy_at_1:.1f}% ({correct_at_1}/{total})")
    print(f"  ‚Ä¢ Recall@3:   {recall_at_3:.1f}% ({correct_at_3}/{total})")

    # –û—Ç—á–µ—Ç –ø–æ –æ—à–∏–±–∫–∞–º (–≥–¥–µ –Ω–µ –ø–æ–ø–∞–ª–∏ –≤ —Ç–æ–ø-3)
    errors = [r for r in results if not r["correct_at_3"]]
    if errors:
        print(f"\n‚ùå –ù–µ –ø–æ–ø–∞–ª–∏ –≤ —Ç–æ–ø-3 ({len(errors)}):")
        for e in errors:
            print(f"\n  Q: {e['question']}")
            print(f"    –û–∂–∏–¥–∞–ª–∏: {e['expected']}")
            print(f"    –¢–æ–ø-3: {', '.join(e['top_3'])}")
    else:
        print(f"\nüéâ –í—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –≤ —Ç–æ–ø-3!")

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º
    print(f"\nüìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º (recall@3):")
    index_stats = {}
    for r in results:
        exp = r["expected"]
        if exp not in index_stats:
            index_stats[exp] = {"total": 0, "in_top3": 0}
        index_stats[exp]["total"] += 1
        if r["correct_at_3"]:
            index_stats[exp]["in_top3"] += 1

    for idx, stats in sorted(index_stats.items()):
        idx_recall = stats["in_top3"] / stats["total"] * 100 if stats["total"] > 0 else 0
        print(f"  {idx}: {idx_recall:.0f}% ({stats['in_top3']}/{stats['total']})")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä–æ–≥–∞ recall@3
    assert recall_at_3 >= 80, \
        f"Recall@3 Router Agent {recall_at_3:.1f}% –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞ 80%"


# ============================================================================
# Test 3: Fallback –ø—Ä–∏ –æ—à–∏–±–∫–µ Router (–æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è batch –º–µ—Ö–∞–Ω–∏–∑–º–∞)
# ============================================================================

@pytest.mark.asyncio
async def test_router_fallback_on_error(mock_report_descriptions):
    """
    –¢–µ—Å—Ç —á—Ç–æ –ø—Ä–∏ –æ—à–∏–±–∫–µ Router –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback –ø–æ–≤–µ–¥–µ–Ω–∏–µ.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - Graceful handling –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö batch API –∑–∞–ø—Ä–æ—Å–∞
    - –í–æ–∑–≤—Ä–∞—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ —É–ª—É—á—à–µ–Ω–∏—è
    - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DEFAULT_INDEX –ø—Ä–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—ã–±–æ—Ä–∞

    Args:
        mock_report_descriptions: –§–∏–∫—Å—Ç—É—Ä–∞ —Å –º–æ–∫–æ–≤—ã–º–∏ –æ–ø–∏—Å–∞–Ω–∏—è–º–∏

    Note:
        –¢–µ—Å—Ç –ù–ï –ø–æ–º–µ—á–µ–Ω @pytest.mark.slow - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ–∫–∏
        –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è batch –º–µ—Ö–∞–Ω–∏–∑–º–∞ (–ø–∞—Ç—á–∏—Ç evaluate_batch_relevance –≤–º–µ—Å—Ç–æ evaluate_single_report)
    """
    question = "–ø—Ä–æ–±–ª–µ–º—ã —Å –¥–∏–∑–∞–π–Ω–æ–º –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞"

    # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û—à–∏–±–∫–∞ –≤ evaluate_batch_relevance (batch API –∑–∞–ø—Ä–æ—Å)
    # –ü—Ä–∏ –æ—à–∏–±–∫–µ batch-–∑–∞–ø—Ä–æ—Å–∞ evaluate_batch_relevance –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å {}
    # –§—É–Ω–∫—Ü–∏—è evaluate_report_relevance –ø–µ—Ä–µ–¥–∞–µ—Ç —ç—Ç–æ—Ç –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å –¥–∞–ª—å—à–µ
    with patch('relevance_evaluator.evaluate_batch_relevance',
               side_effect=Exception("API Error: Connection timeout")):

        # –ü—Ä–∏ –æ—à–∏–±–∫–µ batch API –≤—Å–µ –æ—Ç—á–µ—Ç—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è –±–µ–∑ –æ—Ü–µ–Ω–æ–∫
        # evaluate_report_relevance –ª–æ–≤–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å
        try:
            relevance = await evaluate_report_relevance(question, mock_report_descriptions)
            # –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞ - —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å (graceful fallback)
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ª–∏–±–æ –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å, –ª–∏–±–æ –≤—Å–µ –æ—Ü–µ–Ω–∫–∏ = 0.0
            if relevance:
                assert all(score == 0.0 for score in relevance.values()), \
                    "–ü—Ä–∏ –æ—à–∏–±–∫–µ API –≤—Å–µ –æ—Ü–µ–Ω–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 0.0"
            print(f"‚úÖ –û—à–∏–±–∫–∞ batch API –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞, –ø–æ–ª—É—á–µ–Ω–æ {len(relevance)} –æ—Ü–µ–Ω–æ–∫")
        except Exception as e:
            # –î–æ–ø—É—Å—Ç–∏–º–æ –µ—Å–ª–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–±—Ä–æ—Å–∏–ª–æ—Å—å - —Ç–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞—é—â–∏–π –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
            print(f"‚úÖ –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–±—Ä–æ—à–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ: {type(e).__name__}")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û—à–∏–±–∫–∞ –≤ enhance_question_for_index
    with patch('question_enhancer.send_msg_to_model',
               side_effect=Exception("API Error")):

        # –ü—Ä–∏ –æ—à–∏–±–∫–µ —É–ª—É—á—à–µ–Ω–∏—è –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å
        result = enhance_question_for_index(
            original_question=question,
            selected_index="Dizayn",
            report_descriptions=mock_report_descriptions
        )

        # Fallback: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å
        assert result == question, \
            f"–ü—Ä–∏ –æ—à–∏–±–∫–µ –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å, –ø–æ–ª—É—á–µ–Ω–æ: {result}"
        print(f"‚úÖ Fallback –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü—É—Å—Ç—ã–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ DEFAULT_INDEX
    empty_relevance = {
        "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π_–æ—Ç—á–µ—Ç_1": 50.0,
        "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π_–æ—Ç—á–µ—Ç_2": 60.0
    }

    result_index = select_most_relevant_index(empty_relevance, INDEX_MAPPING)

    # –ö–æ–≥–¥–∞ –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã –∏–º–µ—é—Ç 0 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è DEFAULT_INDEX
    assert result_index == DEFAULT_INDEX, \
        f"–ü—Ä–∏ –Ω—É–ª–µ–≤–æ–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è DEFAULT_INDEX, –ø–æ–ª—É—á–µ–Ω–æ: {result_index}"
    print(f"‚úÖ DEFAULT_INDEX ({DEFAULT_INDEX}) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –Ω—É–ª–µ–≤–æ–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏")


# ============================================================================
# Test 4: –†—É—á–Ω–æ–π –≤—ã–±–æ—Ä –∏–Ω–¥–µ–∫—Å–∞
# ============================================================================

@pytest.mark.asyncio
async def test_manual_index_selection(expected_indices):
    """
    –¢–µ—Å—Ç —á—Ç–æ –≤—Å–µ 7 –∏–Ω–¥–µ–∫—Å–æ–≤ –≤–∞–ª–∏–¥–Ω—ã –∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ INDEX_MAPPING
    - –ö–∞–∂–¥—ã–π –∏–Ω–¥–µ–∫—Å –∏–º–µ–µ—Ç –Ω–µ–ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –æ—Ç—á–µ—Ç–æ–≤
    - INDEX_DISPLAY_NAMES —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã

    Args:
        expected_indices: –§–∏–∫—Å—Ç—É—Ä–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º –æ–∂–∏–¥–∞–µ–º—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
    """
    print(f"\nüìã –ü—Ä–æ–≤–µ—Ä–∫–∞ {len(expected_indices)} –∏–Ω–¥–µ–∫—Å–æ–≤...")

    for index in expected_indices:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤ INDEX_MAPPING
        assert index in INDEX_MAPPING, \
            f"–ò–Ω–¥–µ–∫—Å '{index}' –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ INDEX_MAPPING"

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–ø–∏—Å–æ–∫ –æ—Ç—á–µ—Ç–æ–≤ –Ω–µ–ø—É—Å—Ç–æ–π
        reports = INDEX_MAPPING[index]
        assert len(reports) > 0, \
            f"–ò–Ω–¥–µ–∫—Å '{index}' –∏–º–µ–µ—Ç –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –æ—Ç—á–µ—Ç–æ–≤"

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤ INDEX_DISPLAY_NAMES
        assert index in INDEX_DISPLAY_NAMES, \
            f"–ò–Ω–¥–µ–∫—Å '{index}' –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ INDEX_DISPLAY_NAMES"

        display_name = INDEX_DISPLAY_NAMES[index]
        print(f"  ‚úÖ {index}: {len(reports)} –æ—Ç—á–µ—Ç–æ–≤ - {display_name}")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–Ω–¥–µ–∫—Å–æ–≤
    assert len(INDEX_MAPPING) == 7, \
        f"–û–∂–∏–¥–∞–ª–æ—Å—å 7 –∏–Ω–¥–µ–∫—Å–æ–≤, –Ω–∞–π–¥–µ–Ω–æ {len(INDEX_MAPPING)}"

    print(f"\n‚úÖ –í—Å–µ {len(expected_indices)} –∏–Ω–¥–µ–∫—Å–æ–≤ –≤–∞–ª–∏–¥–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –¥–ª—è –≤—ã–±–æ—Ä–∞")


# ============================================================================
# Test 5: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å Router (–æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è batch –º–µ—Ö–∞–Ω–∏–∑–º–∞)
# ============================================================================

@pytest.mark.asyncio
@pytest.mark.slow
async def test_router_performance():
    """
    –¢–µ—Å—Ç —á—Ç–æ Router –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞ <= 5 —Å–µ–∫—É–Ω–¥.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - –û–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ Router
    - Batch-–æ—Ü–µ–Ω–∫–∞ 22 –æ—Ç—á–µ—Ç–æ–≤ –∑–∞ 1 API –∑–∞–ø—Ä–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ

    Note:
        –¢–µ—Å—Ç –ø–æ–º–µ—á–µ–Ω @pytest.mark.slow - –¥–µ–ª–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ API –≤—ã–∑–æ–≤—ã
        –í—Ä–µ–º—è –º–æ–∂–µ—Ç –≤–∞—Ä—å–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç latency API
    """
    question = "–ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Å–≤–µ—â–µ–Ω–∏–µ–º –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ"

    # –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø–∏—Å–∞–Ω–∏–π –æ—Ç—á–µ—Ç–æ–≤
    try:
        report_descriptions = load_all_report_descriptions()
    except FileNotFoundError:
        pytest.skip("–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –æ—Ç—á–µ—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")

    print(f"\n‚è±Ô∏è –ó–∞–º–µ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ Router Agent...")

    start = time.time()

    # –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª Router Agent
    # –≠—Ç–∞–ø 1: –û—Ü–µ–Ω–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (1 batch –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö 22 –æ—Ç—á–µ—Ç–æ–≤)
    relevance = await evaluate_report_relevance(question, report_descriptions)

    # –≠—Ç–∞–ø 2: –í—ã–±–æ—Ä –∏–Ω–¥–µ–∫—Å–∞ (–ª–æ–∫–∞–ª—å–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è, –º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
    index = select_most_relevant_index(relevance, INDEX_MAPPING)

    # –≠—Ç–∞–ø 3: –£–ª—É—á—à–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ (1 –∑–∞–ø—Ä–æ—Å –∫ API)
    enhanced = enhance_question_for_index(question, index, report_descriptions)

    elapsed = time.time() - start

    print(f"\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:")
    print(f"  –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {elapsed:.2f} —Å–µ–∫")
    print(f"  –û—Ü–µ–Ω–µ–Ω–æ –æ—Ç—á–µ—Ç–æ–≤: {len(relevance)}")
    print(f"  –í—ã–±—Ä–∞–Ω –∏–Ω–¥–µ–∫—Å: {index}")
    print(f"  –î–ª–∏–Ω–∞ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞: {len(enhanced)} —Å–∏–º–≤–æ–ª–æ–≤")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (<=5 —Å–µ–∫—É–Ω–¥)
    # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –Ω–∞ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Å–µ—Ç—è—Ö –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏
    # –ü–æ—Ä–æ–≥ 5 —Å–µ–∫—É–Ω–¥ - –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π, –¥–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 10 —Å–µ–∫—É–Ω–¥
    if elapsed > 5.0:
        print(f"\n‚ö†Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è {elapsed:.2f}s –ø—Ä–µ–≤—ã—à–∞–µ—Ç —Ü–µ–ª–µ–≤–æ–µ 5.0s")
        print("   –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω–æ –≤—ã—Å–æ–∫–æ–π latency API")

    # –ú—è–≥–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (warning –≤–º–µ—Å—Ç–æ fail –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏)
    assert elapsed <= 10.0, \
        f"Router –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–π: {elapsed:.2f} —Å–µ–∫ > 10.0 —Å–µ–∫"

    if elapsed <= 5.0:
        print(f"\n‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –Ω–æ—Ä–º–µ: {elapsed:.2f}s <= 5.0s")


# ============================================================================
# Test 6: –í—Å–µ –æ—Ç—á–µ—Ç—ã –ø–æ–∫—Ä—ã—Ç—ã –º–∞–ø–ø–∏–Ω–≥–æ–º
# ============================================================================

def test_all_reports_mapped():
    """
    –¢–µ—Å—Ç —á—Ç–æ –≤—Å–µ 22 –æ—Ç—á–µ—Ç–∞ –ø–æ–∫—Ä—ã—Ç—ã –º–∞–ø–ø–∏–Ω–≥–æ–º INDEX_MAPPING.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤ = 22
    - –ù–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –æ—Ç—á–µ—Ç–æ–≤ –º–µ–∂–¥—É –∏–Ω–¥–µ–∫—Å–∞–º–∏
    - –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É
    """
    all_reports = set()
    report_list = []

    for index_name, reports in INDEX_MAPPING.items():
        for report in reports:
            report_list.append(report)
            all_reports.add(report)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    assert len(all_reports) == 22, \
        f"–û–∂–∏–¥–∞–ª–æ—Å—å 22 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞, –ø–æ–ª—É—á–µ–Ω–æ {len(all_reports)}"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
    duplicates = [r for r in report_list if report_list.count(r) > 1]
    assert len(duplicates) == 0, \
        f"–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –æ—Ç—á–µ—Ç—ã: {set(duplicates)}"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º
    expected_distribution = {
        "Dizayn": 1,
        "Intervyu": 3,
        "Iskhodniki_dizayn": 1,
        "Iskhodniki_obsledovanie": 1,
        "Itogovye_otchety": 6,
        "Otchety_po_dizaynu": 5,
        "Otchety_po_obsledovaniyu": 5
    }

    actual_distribution = get_index_statistics()

    assert actual_distribution == expected_distribution, \
        f"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É:\n" \
        f"–û–∂–∏–¥–∞–ª–æ—Å—å: {expected_distribution}\n" \
        f"–ü–æ–ª—É—á–µ–Ω–æ: {actual_distribution}"

    print(f"\n‚úÖ –í—Å–µ 22 –æ—Ç—á–µ—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ 7 –∏–Ω–¥–µ–∫—Å–∞–º:")
    for idx, count in sorted(actual_distribution.items()):
        print(f"  {idx}: {count} –æ—Ç—á–µ—Ç–æ–≤")


# ============================================================================
# Test 7: INDEX_DISPLAY_NAMES —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç INDEX_MAPPING
# ============================================================================

def test_display_names_consistency():
    """
    –¢–µ—Å—Ç —á—Ç–æ INDEX_DISPLAY_NAMES —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã –∏–∑ INDEX_MAPPING.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã –∏–∑ INDEX_MAPPING –∏–º–µ—é—Ç display name
    - –ù–µ—Ç –ª–∏—à–Ω–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ INDEX_DISPLAY_NAMES
    - –í—Å–µ display names –Ω–µ–ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
    """
    mapping_indices = set(INDEX_MAPPING.keys())
    display_indices = set(INDEX_DISPLAY_NAMES.keys())

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã –∏–∑ MAPPING –µ—Å—Ç—å –≤ DISPLAY_NAMES
    missing_in_display = mapping_indices - display_indices
    assert len(missing_in_display) == 0, \
        f"–ò–Ω–¥–µ–∫—Å—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ INDEX_DISPLAY_NAMES: {missing_in_display}"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ DISPLAY_NAMES
    extra_in_display = display_indices - mapping_indices
    assert len(extra_in_display) == 0, \
        f"–õ–∏—à–Ω–∏–µ –∏–Ω–¥–µ–∫—Å—ã –≤ INDEX_DISPLAY_NAMES: {extra_in_display}"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ display names –Ω–µ–ø—É—Å—Ç—ã–µ
    for index, display_name in INDEX_DISPLAY_NAMES.items():
        assert isinstance(display_name, str), \
            f"Display name –¥–ª—è '{index}' –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π: {type(display_name)}"
        assert len(display_name.strip()) > 0, \
            f"Display name –¥–ª—è '{index}' —è–≤–ª—è–µ—Ç—Å—è –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π"

    print(f"\n‚úÖ INDEX_DISPLAY_NAMES –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç INDEX_MAPPING:")
    for index in sorted(INDEX_MAPPING.keys()):
        print(f"  {index} -> {INDEX_DISPLAY_NAMES[index]}")


# ============================================================================
# Test 8: –í–∞–ª–∏–¥–∞—Ü–∏—è INDEX_MAPPING
# ============================================================================

def test_index_mapping_validation():
    """
    –¢–µ—Å—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã INDEX_MAPPING.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - INDEX_MAPPING –ø—Ä–æ—Ö–æ–¥–∏—Ç validate_index_mapping()
    - –ù–µ—Ç –ø—É—Å—Ç—ã—Ö —Å–ø–∏—Å–∫–æ–≤ –æ—Ç—á–µ—Ç–æ–≤
    - –ù–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –æ—Ç—á–µ—Ç–æ–≤
    """
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    is_valid = validate_index_mapping(INDEX_MAPPING)

    assert is_valid, "INDEX_MAPPING –Ω–µ –ø—Ä–æ—à–µ–ª –≤–∞–ª–∏–¥–∞—Ü–∏—é validate_index_mapping()"

    print(f"\n‚úÖ INDEX_MAPPING –ø—Ä–æ—à–µ–ª –≤–∞–ª–∏–¥–∞—Ü–∏—é —Å—Ç—Ä—É–∫—Ç—É—Ä—ã")


# ============================================================================
# Test 9: –¢–µ—Å—Ç —Å –º–æ–∫–∞–º–∏ (–±–µ–∑ API –≤—ã–∑–æ–≤–æ–≤)
# ============================================================================

@pytest.mark.asyncio
async def test_router_workflow_mocked(mock_report_descriptions):
    """
    –¢–µ—Å—Ç workflow Router Agent —Å –º–æ–∫–∞–º–∏ (–±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö API –≤—ã–∑–æ–≤–æ–≤).

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ª–æ–≥–∏–∫–∏ –≤—ã–±–æ—Ä–∞ –∏–Ω–¥–µ–∫—Å–∞
    - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ü–µ–Ω–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏

    Args:
        mock_report_descriptions: –§–∏–∫—Å—Ç—É—Ä–∞ —Å –º–æ–∫–æ–≤—ã–º–∏ –æ–ø–∏—Å–∞–Ω–∏—è–º–∏

    Note:
        –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç - –Ω–µ –¥–µ–ª–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö API –≤—ã–∑–æ–≤–æ–≤
    """
    question = "–ø—Ä–æ–±–ª–µ–º—ã —Å –¥–∏–∑–∞–π–Ω–æ–º –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞"

    # –ú–æ–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–µ–π (–≤—ã—Å–æ–∫–∏–µ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –¥–∏–∑–∞–π–Ω—É)
    mock_relevance = {
        # Otchety_po_dizaynu - –≤—ã—Å–æ–∫–∏–µ –æ—Ü–µ–Ω–∫–∏
        "–î–∏–∑–∞–π–Ω –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞": 95.0,
        "–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã": 90.0,
        "–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏": 88.0,
        "–û–∂–∏–¥–∞–Ω–∏—è": 85.0,
        "–ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è": 83.0,

        # Dizayn - —Å—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞
        "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π_–æ—Ç—á–µ—Ç_–∞—É–¥–∏—Ç–∞": 70.0,

        # –û—Å—Ç–∞–ª—å–Ω—ã–µ - –Ω–∏–∑–∫–∏–µ –æ—Ü–µ–Ω–∫–∏
        "–û–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ": 25.0,
        "–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ": 30.0,
        "–û–±—â–∏–µ_—Ñ–∞–∫—Ç–æ—Ä—ã": 20.0
    }

    # –í–º–µ—Å—Ç–æ –º–æ–∫–∞ API –Ω–∞–ø—Ä—è–º—É—é –≤—ã–∑—ã–≤–∞–µ–º select_most_relevant_index
    # —Å –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    selected_index = select_most_relevant_index(mock_relevance, INDEX_MAPPING)

    # Otchety_po_dizaynu –∏–º–µ–µ—Ç 5 –æ—Ç—á–µ—Ç–æ–≤ —Å–æ —Å—Ä–µ–¥–Ω–µ–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é:
    # (95 + 90 + 88 + 85 + 83) / 5 = 88.2
    # Dizayn –∏–º–µ–µ—Ç 1 –æ—Ç—á–µ—Ç: 70.0
    # –û—Å—Ç–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –∏–º–µ—é—Ç 0 (–Ω–µ—Ç –æ—Ç—á–µ—Ç–æ–≤ –≤ mock_relevance)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—ã–±—Ä–∞–Ω Otchety_po_dizaynu (–Ω–∞–∏–≤—ã—Å—à–∞—è —Å—Ä–µ–¥–Ω—è—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å)
    assert selected_index == "Otchety_po_dizaynu", \
        f"–û–∂–∏–¥–∞–ª—Å—è Otchety_po_dizaynu, –ø–æ–ª—É—á–µ–Ω–æ {selected_index}"

    print(f"\n‚úÖ –ú–æ–∫ —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω: –≤—ã–±—Ä–∞–Ω –∏–Ω–¥–µ–∫—Å {selected_index}")


# ============================================================================
# Test 10: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
# ============================================================================

def test_edge_cases():
    """
    –¢–µ—Å—Ç –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –∏ edge cases.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–µ–π (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å)
    - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ —Å –æ—Ü–µ–Ω–∫–æ–π
    - –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö/–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
    """
    # –°–ª—É—á–∞–π 1: –†–∞–≤–Ω—ã–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ - –¥–æ–ª–∂–µ–Ω –≤—ã–±—Ä–∞—Ç—å—Å—è –ø–µ—Ä–≤—ã–π –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
    equal_relevance = {
        "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π_–æ—Ç—á–µ—Ç_–∞—É–¥–∏—Ç–∞": 50.0,  # Dizayn
        "–û–±—â–∏–µ_—Ñ–∞–∫—Ç–æ—Ä—ã": 50.0,  # Intervyu
        "–û—Ç—á–µ—Ç_–æ_—Å–≤—è–∑–∫–∞—Ö": 50.0,  # Intervyu
        "–§–∞–∫—Ç–æ—Ä—ã_–≤_—ç—Ç–æ–º_–∑–∞–≤–µ–¥–µ–Ω–∏–∏": 50.0  # Intervyu
    }

    result1 = select_most_relevant_index(equal_relevance, INDEX_MAPPING)
    # Dizayn: 50.0 (1 –æ—Ç—á–µ—Ç), Intervyu: 50.0 (3 –æ—Ç—á–µ—Ç–∞)
    # –ü—Ä–∏ —Ä–∞–≤–µ–Ω—Å—Ç–≤–µ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
    assert result1 in ["Dizayn", "Intervyu"], \
        f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏ —Ä–∞–≤–Ω—ã—Ö —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—è—Ö: {result1}"
    print(f"‚úÖ –°–ª—É—á–∞–π 1 (—Ä–∞–≤–Ω—ã–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏): {result1}")

    # –°–ª—É—á–∞–π 2: –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –æ—Ç—á–µ—Ç
    single_report = {"–û–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ": 80.0}
    result2 = select_most_relevant_index(single_report, INDEX_MAPPING)
    assert result2 == "Iskhodniki_obsledovanie"
    print(f"‚úÖ –°–ª—É—á–∞–π 2 (–æ–¥–∏–Ω –æ—Ç—á–µ—Ç): {result2}")

    # –°–ª—É—á–∞–π 3: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–æ –Ω–µ –Ω—É–ª–µ–≤—ã–µ)
    minimal_relevance = {
        "–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ": 0.1,
        "–ò—Ç–æ–≥–æ–≤—ã–π": 0.1,
        "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏": 0.1
    }
    result3 = select_most_relevant_index(minimal_relevance, INDEX_MAPPING)
    assert result3 == "Itogovye_otchety"
    print(f"‚úÖ –°–ª—É—á–∞–π 3 (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è): {result3}")

    # –°–ª—É—á–∞–π 4: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    max_relevance = {
        "–î–∏–∑–∞–π–Ω –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞": 100.0,
        "–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã": 100.0
    }
    result4 = select_most_relevant_index(max_relevance, INDEX_MAPPING)
    assert result4 == "Otchety_po_dizaynu"
    print(f"‚úÖ –°–ª—É—á–∞–π 4 (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è): {result4}")

    print(f"\n‚úÖ –í—Å–µ –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")


# ============================================================================
# Test 11: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è batch –æ—Ü–µ–Ω–∫–∏
# ============================================================================

def test_json_container_structure(mock_report_descriptions):
    """
    –¢–µ—Å—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã JSON –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å 22 –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –æ—Ç—á–µ—Ç–æ–≤.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã JSON –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    - –ù–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
    - –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤ –∏ –∏–Ω–¥–µ–∫—Å–æ–≤
    - –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Å–≤—è–∑–µ–π –º–µ–∂–¥—É –æ—Ç—á–µ—Ç–∞–º–∏ –∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏

    Args:
        mock_report_descriptions: –§–∏–∫—Å—Ç—É—Ä–∞ —Å –º–æ–∫–æ–≤—ã–º–∏ –æ–ø–∏—Å–∞–Ω–∏—è–º–∏

    Note:
        –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è batch-–æ—Ü–µ–Ω–∫–∏
    """
    # –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    container = build_json_container(mock_report_descriptions)

    # –ü–∞—Ä—Å–∏–Ω–≥ JSON
    data = json.loads(container)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–ª—é—á–µ–π –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è
    assert "reports" in data, "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á 'reports'"
    assert "indices" in data, "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á 'indices'"
    assert "total_reports" in data, "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á 'total_reports'"
    assert "total_indices" in data, "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á 'total_indices'"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç—á–µ—Ç–æ–≤ (22 –≤ –º–æ–∫–µ)
    assert len(data["reports"]) == len(mock_report_descriptions), \
        f"–û–∂–∏–¥–∞–ª–æ—Å—å {len(mock_report_descriptions)} –æ—Ç—á–µ—Ç–æ–≤, –ø–æ–ª—É—á–µ–Ω–æ {len(data['reports'])}"
    assert data["total_reports"] == len(mock_report_descriptions), \
        f"total_reports={data['total_reports']} –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ—Ç—á–µ—Ç–æ–≤"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–∞–∂–¥–æ–≥–æ –æ—Ç—á–µ—Ç–∞
    for i, report in enumerate(data["reports"]):
        # –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        assert "id" in report, f"–û—Ç—á–µ—Ç #{i}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç 'id'"
        assert "name" in report, f"–û—Ç—á–µ—Ç #{i}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç 'name'"
        assert "index" in report, f"–û—Ç—á–µ—Ç #{i}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç 'index'"
        assert "description" in report, f"–û—Ç—á–µ—Ç #{i}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç 'description'"

        # –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
        assert isinstance(report["id"], int), f"–û—Ç—á–µ—Ç #{i}: 'id' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å int"
        assert isinstance(report["name"], str), f"–û—Ç—á–µ—Ç #{i}: 'name' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å str"
        assert isinstance(report["index"], str), f"–û—Ç—á–µ—Ç #{i}: 'index' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å str"
        assert isinstance(report["description"], str), f"–û—Ç—á–µ—Ç #{i}: 'description' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å str"

        # ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º
        assert report["id"] > 0, f"–û—Ç—á–µ—Ç #{i}: 'id' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å > 0"

        # –ò–º—è –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏
        assert len(report["name"]) > 0, f"–û—Ç—á–µ—Ç #{i}: 'name' –ø—É—Å—Ç–æ–µ"
        assert len(report["description"]) > 0, f"–û—Ç—á–µ—Ç #{i}: 'description' –ø—É—Å—Ç–æ–µ"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏–Ω–¥–µ–∫—Å–æ–≤
    for i, index in enumerate(data["indices"]):
        assert "name" in index, f"–ò–Ω–¥–µ–∫—Å #{i}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç 'name'"
        assert "display_name" in index, f"–ò–Ω–¥–µ–∫—Å #{i}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç 'display_name'"
        assert "report_ids" in index, f"–ò–Ω–¥–µ–∫—Å #{i}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç 'report_ids'"

        # report_ids –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–ø–∏—Å–∫–æ–º
        assert isinstance(index["report_ids"], list), \
            f"–ò–Ω–¥–µ–∫—Å #{i}: 'report_ids' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å list"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ ID –æ—Ç—á–µ—Ç–æ–≤
    report_ids = [r["id"] for r in data["reports"]]
    assert len(report_ids) == len(set(report_ids)), \
        "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è ID –æ—Ç—á–µ—Ç–æ–≤"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω –æ—Ç—á–µ—Ç–æ–≤
    report_names = [r["name"] for r in data["reports"]]
    assert len(report_names) == len(set(report_names)), \
        "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –∏–º–µ–Ω–∞ –æ—Ç—á–µ—Ç–æ–≤"

    print(f"\n‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤–∞–ª–∏–¥–Ω–∞:")
    print(f"  ‚Ä¢ –û—Ç—á–µ—Ç–æ–≤: {data['total_reports']}")
    print(f"  ‚Ä¢ –ò–Ω–¥–µ–∫—Å–æ–≤: {data['total_indices']}")
    print(f"  ‚Ä¢ –†–∞–∑–º–µ—Ä JSON: {len(container):,} —Å–∏–º–≤–æ–ª–æ–≤")


# ============================================================================
# Test 12: –ü–∞—Ä—Å–∏–Ω–≥ batch –æ—Ç–≤–µ—Ç–∞ –æ—Ç Claude API
# ============================================================================

def test_batch_response_parsing():
    """
    –¢–µ—Å—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç–≤–µ—Ç–∞ –æ—Ç Claude API.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —á–∏—Å—Ç–æ–≥–æ JSON
    - –ü–∞—Ä—Å–∏–Ω–≥ JSON –≤ markdown –±–ª–æ–∫–µ
    - –ü–∞—Ä—Å–∏–Ω–≥ JSON —Å —Ç–µ–∫—Å—Ç–æ–º –¥–æ/–ø–æ—Å–ª–µ
    - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º JSON

    Note:
        –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é parse_batch_response() —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–∞
    """
    # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ß–∏—Å—Ç—ã–π JSON
    clean_json = json.dumps({
        "evaluations": [
            {"id": 1, "name": "Report1", "relevance": 85, "reason": "–í—ã—Å–æ–∫–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å"},
            {"id": 2, "name": "Report2", "relevance": 30, "reason": "–ù–∏–∑–∫–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å"}
        ]
    })

    result1 = parse_batch_response(clean_json)
    assert "evaluations" in result1
    assert len(result1["evaluations"]) == 2
    assert result1["evaluations"][0]["relevance"] == 85
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ß–∏—Å—Ç—ã–π JSON —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 2: JSON –≤ markdown –±–ª–æ–∫–µ
    markdown_json = """–í–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ü–µ–Ω–∫–∏:

```json
{
  "evaluations": [
    {"id": 1, "name": "TestReport", "relevance": 75, "reason": "–°—Ä–µ–¥–Ω—è—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å"}
  ]
}
```

–ù–∞–¥–µ—é—Å—å, —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç!"""

    result2 = parse_batch_response(markdown_json)
    assert "evaluations" in result2
    assert len(result2["evaluations"]) == 1
    assert result2["evaluations"][0]["name"] == "TestReport"
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 2: JSON –≤ markdown –±–ª–æ–∫–µ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 3: JSON —Å —Ç–µ–∫—Å—Ç–æ–º –¥–æ –∏ –ø–æ—Å–ª–µ (–±–µ–∑ markdown)
    text_with_json = """–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
{"evaluations": [{"id": 1, "name": "–û—Ç—á–µ—Ç", "relevance": 50, "reason": "–¢–µ—Å—Ç"}]}
–ö–æ–Ω–µ—Ü –æ—Ç–≤–µ—Ç–∞."""

    result3 = parse_batch_response(text_with_json)
    assert "evaluations" in result3
    assert result3["evaluations"][0]["relevance"] == 50
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 3: JSON —Å –æ–∫—Ä—É–∂–∞—é—â–∏–º —Ç–µ–∫—Å—Ç–æ–º —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û—à–∏–±–∫–∞ - –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
    with pytest.raises(ValueError, match="–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç"):
        parse_batch_response("")
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç ValueError")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 5: –û—à–∏–±–∫–∞ - –Ω–µ—Ç JSON –≤ —Ç–µ–∫—Å—Ç–µ
    with pytest.raises(ValueError, match="–ù–µ –Ω–∞–π–¥–µ–Ω JSON"):
        parse_batch_response("–≠—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç –±–µ–∑ JSON")
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 5: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ JSON –≤—ã–∑—ã–≤–∞–µ—Ç ValueError")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 6: –û—à–∏–±–∫–∞ - –Ω–µ—Ç –∫–ª—é—á–∞ 'evaluations'
    invalid_structure = '{"results": [{"id": 1}]}'
    with pytest.raises(ValueError, match="–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á 'evaluations'"):
        parse_batch_response(invalid_structure)
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 6: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ 'evaluations' –≤—ã–∑—ã–≤–∞–µ—Ç ValueError")

    print(f"\n‚úÖ –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ batch –æ—Ç–≤–µ—Ç–∞ –ø—Ä–æ–π–¥–µ–Ω—ã")


# ============================================================================
# Test 13: –í–∞–ª–∏–¥–∞—Ü–∏—è batch –æ—Ü–µ–Ω–æ–∫
# ============================================================================

def test_batch_evaluations_validation():
    """
    –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –æ—Ü–µ–Ω–æ–∫ –∏–∑ batch-–æ—Ç–≤–µ—Ç–∞.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    - –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª–µ–π
    - –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è ID/–∏–º–µ–Ω
    - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ relevance (0-100)

    Note:
        –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é validate_batch_evaluations()
    """
    # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    valid_evaluations = [
        {"id": 1, "name": "Report1", "relevance": 85, "reason": "Test"},
        {"id": 2, "name": "Report2", "relevance": 50, "reason": "Test"},
        {"id": 3, "name": "Report3", "relevance": 10, "reason": "Test"}
    ]

    is_valid, errors = validate_batch_evaluations(valid_evaluations, expected_count=3)
    assert is_valid, f"–û–∂–∏–¥–∞–ª–æ—Å—å –≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –æ—à–∏–±–∫–∏: {errors}"
    assert len(errors) == 0
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ü–µ–Ω–æ–∫
    is_valid, errors = validate_batch_evaluations(valid_evaluations, expected_count=5)
    assert not is_valid
    assert any("–û–∂–∏–¥–∞–ª–æ—Å—å 5 –æ—Ü–µ–Ω–æ–∫" in e for e in errors)
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 3: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ 'id'
    missing_id = [
        {"name": "Report1", "relevance": 85}
    ]
    is_valid, errors = validate_batch_evaluations(missing_id, expected_count=1)
    assert not is_valid
    assert any("–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ 'id'" in e for e in errors)
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ 'id' –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ 'relevance'
    missing_relevance = [
        {"id": 1, "name": "Report1"}
    ]
    is_valid, errors = validate_batch_evaluations(missing_relevance, expected_count=1)
    assert not is_valid
    assert any("–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ 'relevance'" in e for e in errors)
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ 'relevance' –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 5: –î—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è ID
    duplicate_id = [
        {"id": 1, "name": "Report1", "relevance": 85},
        {"id": 1, "name": "Report2", "relevance": 50}
    ]
    is_valid, errors = validate_batch_evaluations(duplicate_id, expected_count=2)
    assert not is_valid
    assert any("–¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è id" in e for e in errors)
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 5: –î—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è ID –æ–±–Ω–∞—Ä—É–∂–µ–Ω")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 6: Relevance –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
    out_of_range = [
        {"id": 1, "name": "Report1", "relevance": 150}
    ]
    is_valid, errors = validate_batch_evaluations(out_of_range, expected_count=1)
    assert not is_valid
    assert any("–≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 0-100" in e for e in errors)
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 6: Relevance –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 7: Relevance –Ω–µ —á–∏—Å–ª–æ
    not_a_number = [
        {"id": 1, "name": "Report1", "relevance": "high"}
    ]
    is_valid, errors = validate_batch_evaluations(not_a_number, expected_count=1)
    assert not is_valid
    assert any("–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º" in e for e in errors)
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 7: –ù–µ—á–∏—Å–ª–æ–≤–æ–π relevance –æ–±–Ω–∞—Ä—É–∂–µ–Ω")

    print(f"\n‚úÖ –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ batch –æ—Ü–µ–Ω–æ–∫ –ø—Ä–æ–π–¥–µ–Ω—ã")


# ============================================================================
# Test 14: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –æ—Ü–µ–Ω–æ–∫ –≤ —Å–ª–æ–≤–∞—Ä—å
# ============================================================================

def test_evaluations_to_dict_conversion():
    """
    –¢–µ—Å—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –æ—Ü–µ–Ω–æ–∫ –≤ —Å–ª–æ–≤–∞—Ä—å.

    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:
    - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç {name: relevance}
    - –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π relevance
    - Clamp –∑–Ω–∞—á–µ–Ω–∏–π –≤ –¥–∏–∞–ø–∞–∑–æ–Ω 0-100

    Note:
        –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é convert_evaluations_to_dict()
    """
    # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    evaluations = [
        {"id": 1, "name": "Report_A", "relevance": 85},
        {"id": 2, "name": "Report_B", "relevance": 30.5},
        {"id": 3, "name": "Report_C", "relevance": 0}
    ]

    result = convert_evaluations_to_dict(evaluations)

    assert len(result) == 3
    assert result["Report_A"] == 85.0
    assert result["Report_B"] == 30.5
    assert result["Report_C"] == 0.0
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ó–Ω–∞—á–µ–Ω–∏—è –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å clamp)
    out_of_range = [
        {"id": 1, "name": "High", "relevance": 150},
        {"id": 2, "name": "Low", "relevance": -10}
    ]

    result = convert_evaluations_to_dict(out_of_range)

    assert result["High"] == 100.0, "–ó–Ω–∞—á–µ–Ω–∏—è > 100 –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å clamp –∫ 100"
    assert result["Low"] == 0.0, "–ó–Ω–∞—á–µ–Ω–∏—è < 0 –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å clamp –∫ 0"
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ó–Ω–∞—á–µ–Ω–∏—è –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ clamped –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Ç–∏–ø—ã (—Å—Ç—Ä–æ–∫–∞ –≤–º–µ—Å—Ç–æ —á–∏—Å–ª–∞)
    invalid_types = [
        {"id": 1, "name": "Invalid", "relevance": "high"}
    ]

    result = convert_evaluations_to_dict(invalid_types)

    assert result["Invalid"] == 0.0, "–ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã —Å—Ç–∞—Ç—å 0.0"
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Ç–∏–ø—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã (fallback 0.0)")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ relevance
    missing_field = [
        {"id": 1, "name": "Missing"}
    ]

    result = convert_evaluations_to_dict(missing_field)

    assert result["Missing"] == 0.0, "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π relevance –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å 0.0"
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π relevance –æ–±—Ä–∞–±–æ—Ç–∞–Ω (fallback 0.0)")

    # –°—Ü–µ–Ω–∞—Ä–∏–π 5: Integer –∏ float —Å–º–µ—à–∞–Ω–Ω—ã–µ
    mixed_types = [
        {"id": 1, "name": "Int", "relevance": 50},
        {"id": 2, "name": "Float", "relevance": 75.5}
    ]

    result = convert_evaluations_to_dict(mixed_types)

    assert isinstance(result["Int"], float)
    assert isinstance(result["Float"], float)
    print(f"‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 5: –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ float")

    print(f"\n‚úÖ –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –æ—Ü–µ–Ω–æ–∫ –ø—Ä–æ–π–¥–µ–Ω—ã")


# ============================================================================
# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
# ============================================================================

if __name__ == "__main__":
    """
    –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Python.

    Example:
        python tests/test_integration_e2e.py
        python tests/test_integration_e2e.py -v
        python tests/test_integration_e2e.py -v -m "not slow"
    """
    pytest.main([__file__, "-v", "--tb=short", "-s"])
