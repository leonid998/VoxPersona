# VoxPersona: –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 4 –Ω–æ—è–±—Ä—è 2025  
**–£—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏:** –û–ß–ï–ù–¨ –¢–©–ê–¢–ï–õ–¨–ù–´–ô  
**–ü—Ä–æ–µ–∫—Ç:** VoxPersona (Telegram –±–æ—Ç –¥–ª—è –∏–Ω—Ç–µ—Ä–≤—å—é –∏ –∞—É–¥–∏—Ç–æ–≤)

---

## 1. –û–ë–©–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –î–ò–†–ï–ö–¢–û–†–ò–ô

```
C:\Users\l0934\Projects\VoxPersona\
‚îú‚îÄ‚îÄ src/                              # ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ main.py                        # –¢–û–ß–ö–ê –í–•–û–î–ê –±–æ—Ç–∞ (Pyrogram Client)
‚îÇ   ‚îú‚îÄ‚îÄ config.py                      # –ö–æ–Ω—Ñ–∏–≥ –∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ constants.py                   # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
‚îÇ   ‚îú‚îÄ‚îÄ bot.py                         # (—Å—Ç–∞—Ä—ã–π) Pyrogram init
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ handlers.py                    # üî• –®–ê–ì 2: –û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (callbacks, —Ç–µ–∫—Å—Ç—ã, –∞—É–¥–∏–æ)
‚îÇ   ‚îú‚îÄ‚îÄ handlers_my_reports_v2.py      # v2 —Å–∏—Å—Ç–µ–º–∞ –æ—Ç—á–µ—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ conversation_handlers.py       # FSM –¥–ª—è –º—É–ª—å—Ç–∏—á–∞—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ access_handlers.py             # üîê AUTH: –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)
‚îÇ   ‚îú‚îÄ‚îÄ conversation_handler.py        # –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ menus.py                       # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä –∏ –º–µ–Ω—é
‚îÇ   ‚îú‚îÄ‚îÄ markups.py                     # –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞–∑–º–µ—Ç–∫–∏ Telegram
‚îÇ   ‚îú‚îÄ‚îÄ menu_manager.py                # –ú–µ–Ω–µ–¥–∂–µ—Ä –º–µ–Ω—é (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MessageTracker)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ datamodels.py                  # –ú–∞–ø–ø–∏–Ω–≥–∏ (—Å—Ü–µ–Ω–∞—Ä–∏–∏, –∑–¥–∞–Ω–∏—è, –æ—Ç—á–µ—Ç—ã)
‚îÇ   ‚îú‚îÄ‚îÄ validators.py                  # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ parser.py                      # –ü–∞—Ä—Å–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ conversation_manager.py        # üéØ –ú–µ–Ω–µ–¥–∂–µ—Ä –º—É–ª—å—Ç–∏—á–∞—Ç–æ–≤ (KISS pattern)
‚îÇ   ‚îú‚îÄ‚îÄ conversations.py               # –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤ (Pydantic)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ auth_manager.py                # üîê AUTH: –ì–ª–∞–≤–Ω—ã–π API –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (15+ –º–µ—Ç–æ–¥–æ–≤)
‚îÇ   ‚îú‚îÄ‚îÄ auth_storage.py                # üîê AUTH: CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ (JSON —Ñ–∞–π–ª—ã)
‚îÇ   ‚îú‚îÄ‚îÄ auth_security.py               # üîê AUTH: bcrypt + security utils
‚îÇ   ‚îú‚îÄ‚îÄ auth_models.py                 # üîê AUTH: Pydantic –º–æ–¥–µ–ª–∏ (User, Session, etc)
‚îÇ   ‚îú‚îÄ‚îÄ auth_filters.py                # üîê AUTH: Pyrogram filter –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ storage.py                     # –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ –∏ –ë–î (FAISS, PostgreSQL)
‚îÇ   ‚îú‚îÄ‚îÄ utils.py                       # –£—Ç–∏–ª–∏—Ç—ã (embedding, text cleaning, UI)
‚îÇ   ‚îú‚îÄ‚îÄ analysis.py                    # –ê–Ω–∞–ª–∏–∑ –∞—É–¥–∏–æ/—Ç–µ–∫—Å—Ç–∞ (roles assignment)
‚îÇ   ‚îú‚îÄ‚îÄ audio_utils.py                 # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ
‚îÇ   ‚îú‚îÄ‚îÄ file_sender.py                 # üöÄ AUTO-SEND: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ message_tracker.py             # üìä MessageTracker: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏ —á–∏—Å—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ run_analysis.py                # –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ —Å RAG + spinner
‚îÇ   ‚îú‚îÄ‚îÄ rag_persistence.py             # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ RAG –∏–Ω–¥–µ–∫—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ md_storage.py                  # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ MD –æ—Ç—á–µ—Ç–∞–º–∏ (—Ñ–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ minio_manager.py               # ü™£ MinIO: –∑–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ –≤ –æ–±–ª–∞–∫–æ
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ managers/                      # –ú–æ–¥—É–ª—å–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ base_storage_manager.py    # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ —Ö—Ä–∞–Ω–µ–Ω–∏—è
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ db_handler/                    # üóÑÔ∏è Database layer (PostgreSQL)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db.py                      # SQL —Ñ—É–Ω–∫—Ü–∏–∏ (get_scenario, save_audit, etc)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fill_prompts_table.py      # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–æ–º–ø—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ formatters/                    # üìù –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base_formatter.py          # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å —Ñ–æ—Ä–º–∞—Ç–µ—Ä–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ history_formatter.py       # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ report_formatter.py        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ auth_data/                     # üîê AUTH: –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö (JSON)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sessions/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ invitations/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ roles.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ audit_log.json
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ migrations/                    # üîÑ Database migrations
‚îÇ   ‚îú‚îÄ‚îÄ tests/                         # üß™ Unit —Ç–µ—Å—Ç—ã (test_*.py)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ __pycache__/
‚îÇ
‚îú‚îÄ‚îÄ tests/                             # üß™ Integration —Ç–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ test_*.py                      # –†–∞–∑–ª–∏—á–Ω—ã–µ —Ç–µ—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îÇ
‚îú‚îÄ‚îÄ prompts/                           # üìù –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
‚îú‚îÄ‚îÄ prompts-by-scenario/               # üìù –°—Ü–µ–Ω–∞—Ä–∏–π-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ assign_roles/
‚îÇ   ‚îú‚îÄ‚îÄ design/
‚îÇ   ‚îú‚îÄ‚îÄ interview/
‚îÇ   ‚îî‚îÄ‚îÄ sql_prompts/
‚îÇ
‚îú‚îÄ‚îÄ menu_crawler/                      # ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫—Ä–∞—É–ª–µ—Ä –º–µ–Ω—é (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ
‚îú‚îÄ‚îÄ scripts/                           # üîß –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ auth_migration.py              # AUTH —Å–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ *.py
‚îÇ
‚îú‚îÄ‚îÄ docs/                              # üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ backups/                           # üíæ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏
‚îú‚îÄ‚îÄ chat_history/                      # üí¨ –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤ (JSON)
‚îú‚îÄ‚îÄ conversations/                     # üí¨ –ú—É–ª—å—Ç–∏—á–∞—Ç—ã (JSON —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
‚îú‚îÄ‚îÄ md_reports/                        # üìÑ –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ MD –æ—Ç—á–µ—Ç—ã
‚îÇ
‚îú‚îÄ‚îÄ docker-compose.yml                 # üê≥ Docker compose
‚îú‚îÄ‚îÄ Dockerfile                         # üê≥ Multi-stage Docker build
‚îú‚îÄ‚îÄ requirements.txt                   # üì¶ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ .env                               # üîë –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ .env.test                          # üîë Test –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ pyrightconfig.json                 # Pyright config
‚îú‚îÄ‚îÄ README.md                          # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îÇ
‚îî‚îÄ‚îÄ .git/                              # Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    ‚îî‚îÄ‚îÄ hooks/                         # Git hooks (–∞–≤—Ç–æ–¥–µ–ø–ª–æ–π)
```

---

## 2. –¢–û–ß–ö–ò –í–•–û–î–ê –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø

### 2.1 –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞

**–§–∞–π–ª:** `src/main.py`

```python
# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:
async def main():
    1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AuthManager (src/auth_manager.py)
       ‚îî‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ config.auth_manager —á–µ—Ä–µ–∑ set_auth_manager()
    
    2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Pyrogram Client
       ‚îî‚îÄ API_ID, API_HASH –∏–∑ config
       ‚îî‚îÄ TELEGRAM_BOT_TOKEN
       ‚îî‚îÄ SESSION_NAME –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–π
    
    3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è handlers —á–µ—Ä–µ–∑ handlers.register_handlers(app)
       ‚îî‚îÄ @app.on_message() - —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
       ‚îî‚îÄ @app.on_message() - –∞—É–¥–∏–æ—Å–æ–æ–±—â–µ–Ω–∏—è
       ‚îî‚îÄ @app.on_callback_query() - callback buttons
    
    4. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ RAG –º–æ–¥–µ–ª–µ–π
       ‚îî‚îÄ asyncio.create_task(load_rags())
       ‚îî‚îÄ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (periodic_save_rags)
    
    5. await app.start()
    6. await idle() - –æ–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
```

### 2.2 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `src/config.py` (475 —Å—Ç—Ä–æ–∫)

**–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:**
```python
# üîë API keys
OPENAI_API_KEY = "sk-proj-..."
ANTHROPIC_API_KEY = "sk-ant-..."
API_ID, API_HASH                          # Telegram API
TELEGRAM_BOT_TOKEN                        # Bot token

# üóÑÔ∏è Database
DB_CONFIG = {
    "dbname": os.getenv("DB_NAME"),
    "user": os.getenv("DB_USER"),
    "password": os.getenv("DB_PASSWORD"),
    "host": os.getenv("DB_HOST"),
    "port": os.getenv("DB_PORT")
}

# ü™£ MinIO (–æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
MINIO_ENDPOINT = "localhost:9000"
MINIO_ACCESS_KEY, MINIO_SECRET_KEY
MINIO_AUDIO_BUCKET_NAME = "voxpersona-audio"

# üí¨ –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è
CHAT_HISTORY_DIR = "/home/voxpersona_user/VoxPersona/chat_history"
MD_REPORTS_DIR = "/home/voxpersona_user/VoxPersona/md_reports"
CONVERSATIONS_DIR = "/home/voxpersona_user/VoxPersona/conversations"

# üåç –û–∫—Ä—É–∂–µ–Ω–∏–µ
IS_TESTING = is_testing_environment()    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
RUN_MODE = "TEST" | "PROD"

# üîê AUTH –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
auth_manager: Optional[AuthManager] = None
def set_auth_manager(manager) -> None    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
def get_auth_manager()                   # –ü–æ–ª—É—á–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä

# üíæ –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (FSM)
user_states: dict[int, dict] = {}        # {chat_id: {step, data, mode, ...}}
active_menus: dict[int, list] = {}       # –¢—Ä–µ–∫–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ–Ω—é
processed_texts: dict[int, str] = {}     # –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã
user_locks: Dict[int, asyncio.Lock] = {} # Race condition –∑–∞—â–∏—Ç–∞

# üéØ RAG –º–æ–¥–µ–ª–∏ (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ)
rags: dict = {}                          # –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ RAG –∏–Ω–¥–µ–∫—Å—ã
```

---

## 3. –ú–û–î–£–õ–¨–ù–ê–Ø –û–†–ì–ê–ù–ò–ó–ê–¶–ò–Ø –ò –ó–ê–í–ò–°–ò–ú–û–°–¢–ò

### 3.1 –û—Å–Ω–æ–≤–Ω–æ–π flow –æ–±—Ä–∞–±–æ—Ç–∫–∏ (FSM)

```
user_states[chat_id] = {
    "step": "dialog_mode" | "ask_employee" | "ask_date" | ... | "confirm_data",
    "mode": "interview" | "design",
    "conversation_id": "uuid",
    "data": {
        "employee": "–§–ò–û",
        "date": "YYYY-MM-DD",
        "place_name": "–ù–∞–∑–≤–∞–Ω–∏–µ",
        "building_type": "–û—Ç–µ–ª—å",
        "zone_name": "–ó–æ–Ω–∞ 1",
        "city": "–ú–æ—Å–∫–≤–∞",
        "client": "–§–ò–û –∫–ª–∏–µ–Ω—Ç–∞",
        "audio_number": "1",
        "audio_file_name": "file.wav"
    },
    "deep_search": True | False,
    "upload_category": "audio_files" | ...
}
```

### 3.2 –ì—Ä–∞—Ñ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         main.py (ENTRY)                          ‚îÇ
‚îÇ ‚Ä¢ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç AuthManager                                     ‚îÇ
‚îÇ ‚Ä¢ –°–æ–∑–¥–∞–µ—Ç Pyrogram Client                                        ‚îÇ
‚îÇ ‚Ä¢ –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏                                       ‚îÇ
‚îÇ ‚Ä¢ –ó–∞–ø—É—Å–∫–∞–µ—Ç RAG –∑–∞–≥—Ä—É–∑–∫—É                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº                  ‚ñº                  ‚ñº
    config.py         handlers.py      run_analysis.py
    (–∫–æ–Ω—Ñ–∏–≥)         (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏)     (RAG –∞–Ω–∞–ª–∏–∑)
        ‚îÇ                  ‚îÇ                 ‚îÇ
        ‚îÇ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ       ‚îÇ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç      ‚îÇ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç
        ‚îÇ —Å–æ—Å—Ç–æ—è–Ω–∏–µ        ‚îÇ                 ‚îÇ
        ‚îÇ                  ‚îú‚îÄ‚Üí menus.py     ‚îú‚îÄ‚Üí rag_persistence.py
        ‚îÇ                  ‚îÇ    (UI)        ‚îú‚îÄ‚Üí conversation_manager.py
        ‚îÇ                  ‚îÇ                ‚îÇ
        ‚îÇ                  ‚îú‚îÄ‚Üí storage.py   ‚îÇ
        ‚îÇ                  ‚îÇ    (—Ñ–∞–π–ª—ã)     ‚îÇ
        ‚îÇ                  ‚îÇ                ‚îÇ
        ‚îÇ                  ‚îú‚îÄ‚Üí utils.py     ‚îÇ
        ‚îÇ                  ‚îÇ    (text)      ‚îÇ
        ‚îÇ                  ‚îÇ                ‚îÇ
        ‚îÇ                  ‚îú‚îÄ‚Üí validators.py‚îÇ
        ‚îÇ                  ‚îÇ    (–ø—Ä–æ–≤–µ—Ä–∫–∏)  ‚îÇ
        ‚îÇ                  ‚îÇ                ‚îÇ
        ‚îÇ                  ‚îú‚îÄ‚Üí parser.py    ‚îÇ
        ‚îÇ                  ‚îÇ    (–ø–∞—Ä—Å–∏–Ω–≥)   ‚îÇ
        ‚îÇ                  ‚îÇ                ‚îÇ
        ‚îÇ                  ‚îú‚îÄ‚Üí auth_filters.py (üîê AUTH filter)
        ‚îÇ                  ‚îÇ    ‚îÇ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç get_auth_manager()
        ‚îÇ                  ‚îÇ    ‚îî‚îÄ‚Üí auth_manager.py
        ‚îÇ                  ‚îÇ
        ‚îÇ                  ‚îú‚îÄ‚Üí conversation_handlers.py
        ‚îÇ                  ‚îÇ    ‚îÇ —Ä–∞–±–æ—Ç–∞ —Å –º—É–ª—å—Ç–∏—á–∞—Ç–∞–º–∏
        ‚îÇ                  ‚îÇ    ‚îî‚îÄ‚Üí conversation_manager.py
        ‚îÇ                  ‚îÇ         ‚îÇ CRUD –¥–ª—è —á–∞—Ç–æ–≤
        ‚îÇ                  ‚îÇ         ‚îî‚îÄ‚Üí conversations.py (–º–æ–¥–µ–ª–∏)
        ‚îÇ                  ‚îÇ
        ‚îÇ                  ‚îú‚îÄ‚Üí access_handlers.py (üîê —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)
        ‚îÇ                  ‚îÇ    ‚îî‚îÄ‚Üí auth_manager.py
        ‚îÇ                  ‚îÇ         ‚îî‚îÄ‚Üí auth_storage.py
        ‚îÇ                  ‚îÇ
        ‚îÇ                  ‚îú‚îÄ‚Üí handlers_my_reports_v2.py (–æ—Ç—á–µ—Ç—ã)
        ‚îÇ                  ‚îÇ    ‚îî‚îÄ‚Üí md_storage.py
        ‚îÇ                  ‚îÇ
        ‚îÇ                  ‚îú‚îÄ‚Üí message_tracker.py (üìä –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ)
        ‚îÇ                  ‚îÇ    ‚îî‚îÄ‚Üí menu_manager.py
        ‚îÇ                  ‚îÇ
        ‚îÇ                  ‚îú‚îÄ‚Üí file_sender.py (üöÄ –∞–≤—Ç–æ–æ—Ç–ø—Ä–∞–≤–∫–∞)
        ‚îÇ                  ‚îÇ
        ‚îÇ                  ‚îú‚îÄ‚Üí minio_manager.py (ü™£ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
        ‚îÇ                  ‚îÇ
        ‚îÇ                  ‚îî‚îÄ‚Üí audio_utils.py (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ)
        ‚îÇ                       ‚îî‚îÄ‚Üí analysis.py (assign_roles)
        ‚îÇ
        ‚îú‚îÄ‚Üí auth_manager.py (üîê –≥–ª–∞–≤–Ω—ã–π API)
        ‚îÇ    ‚îú‚îÄ‚Üí auth_storage.py (CRUD –≤ JSON)
        ‚îÇ    ‚îÇ   ‚îî‚îÄ‚Üí auth_data/ (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
        ‚îÇ    ‚îú‚îÄ‚Üí auth_security.py (bcrypt)
        ‚îÇ    ‚îú‚îÄ‚Üí auth_models.py (Pydantic)
        ‚îÇ    ‚îî‚îÄ‚Üí auth_filters.py (Pyrogram filter)
        ‚îÇ
        ‚îú‚îÄ‚Üí conversation_manager.py (–º—É–ª—å—Ç–∏—á–∞—Ç—ã)
        ‚îÇ   ‚îî‚îÄ‚Üí conversations.py (–º–æ–¥–µ–ª–∏)
        ‚îÇ
        ‚îú‚îÄ‚Üí md_storage.py (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ç—á–µ—Ç–æ–≤)
        ‚îÇ
        ‚îî‚îÄ‚Üí db_handler/db.py (PostgreSQL)
             ‚îî‚îÄ‚Üí datamodels.py (–º–∞–ø–ø–∏–Ω–≥–∏)
```

---

## 4. –ö–õ–Æ–ß–ï–í–´–ï –ú–û–î–£–õ–ò –ò –ö–û–ú–ü–û–ù–ï–ù–¢–´

### 4.1 üîê AUTH —Å–∏—Å—Ç–µ–º–∞ (–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `auth_manager.py` - –ì–ª–∞–≤–Ω—ã–π API (15+ –º–µ—Ç–æ–¥–æ–≤)
- `auth_storage.py` - CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ (JSON —Ñ–∞–π–ª—ã –≤ auth_data/)
- `auth_security.py` - bcrypt —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ + security utilities
- `auth_models.py` - Pydantic –º–æ–¥–µ–ª–∏ (User, Session, Invitation, Role)
- `auth_filters.py` - Pyrogram —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–•—Ä–∞–Ω–∏–ª–∏—â–µ:**
```
auth_data/
‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îî‚îÄ‚îÄ {user_id}.json          # –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îú‚îÄ‚îÄ sessions/
‚îÇ   ‚îî‚îÄ‚îÄ {session_id}.json       # –°–µ—Å—Å–∏–∏ (TTL 24 —á–∞—Å–∞)
‚îú‚îÄ‚îÄ invitations/
‚îÇ   ‚îî‚îÄ‚îÄ {invite_code}.json      # –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è (TTL 48 —á–∞—Å–æ–≤)
‚îú‚îÄ‚îÄ roles.json                   # –†–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞
‚îî‚îÄ‚îÄ audit_log.json              # Log –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π
```

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã AuthManager:**
```python
# –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
async authenticate(telegram_id, password) -> Session
async logout(session_id) -> bool

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
async register_user(telegram_id, username, password, invite_code) -> User

# RBAC (Role Based Access Control)
async has_permission(user_id, permission) -> bool
async has_role(user_id, role) -> bool
async get_user_permissions(user_id) -> List[str]

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
async list_users() -> List[User]
async get_user(user_id) -> User
async block_user(user_id, blocked_by)
async change_role(user_id, new_role, changed_by)
async reset_password(user_id, new_password, reset_by)

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è–º–∏
async create_invitation(invite_type, created_by, target_role) -> Invitation
async validate_invitation(invite_code) -> bool
```

### 4.2 üí¨ –ú—É–ª—å—Ç–∏—á–∞—Ç—ã (Conversation Manager)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `conversation_manager.py` - –ú–µ–Ω–µ–¥–∂–µ—Ä —á–∞—Ç–æ–≤ (singleton)
- `conversations.py` - Pydantic –º–æ–¥–µ–ª–∏
- `conversation_handlers.py` - FSM –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º—É–ª—å—Ç–∏—á–∞—Ç–æ–≤

**–•—Ä–∞–Ω–∏–ª–∏—â–µ:**
```
conversations/
‚îî‚îÄ‚îÄ user_{user_id}/
    ‚îú‚îÄ‚îÄ index.json              # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    ‚îú‚îÄ‚îÄ {conversation_id}.json  # –ß–∞—Ç 1 (–≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è + –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)
    ‚îú‚îÄ‚îÄ {conversation_id}.json  # –ß–∞—Ç 2
    ‚îî‚îÄ‚îÄ ...
```

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
```python
create_conversation(user_id, username, first_question) -> str
load_conversation(user_id, conversation_id) -> Conversation
save_conversation(conversation) -> bool
delete_conversation(user_id, conversation_id) -> bool

get_active_conversation_id(user_id) -> str
set_active_conversation(user_id, conversation_id) -> bool

add_message(user_id, conversation_id, message) -> bool
get_messages(user_id, conversation_id, limit=20) -> List[Message]

get_user_stats(user_id, days_back=30) -> dict
format_user_stats_for_display(user_id) -> str
```

### 4.3 üìä Message Tracker (–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π)

**–§–∞–π–ª:** `src/message_tracker.py`

**–§—É–Ω–∫—Ü–∏—è:**
```python
async track_and_send(
    chat_id: int,
    app: Client,
    text: str,
    reply_markup: InlineKeyboardMarkup = None,
    message_type: str = "default"  # status_message, input_request, menu, info
) -> Message
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ ID –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ spam —ç—Ñ—Ñ–µ–∫—Ç–æ–≤

### 4.4 üöÄ Auto-Send —Å–∏—Å—Ç–µ–º–∞ (–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤)

**–§–∞–π–ª:** `src/file_sender.py`

**–§—É–Ω–∫—Ü–∏–∏:**
```python
auto_send_history_file(chat_id, conversation_id, app)  # –û—Ç–ø—Ä–∞–≤–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
auto_send_reports_file(chat_id, app)                   # –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–æ–≤
send_history_on_demand(chat_id, conversation_id, app)  # –†—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
```

**–ú–µ—Ö–∞–Ω–∏–∑–º:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞–∫ —Ñ–∞–π–ª (TXT) –µ—Å–ª–∏ > 1200 —Å–∏–º–≤–æ–ª–æ–≤
- Throttling –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ Telegram

### 4.5 ü™£ MinIO Manager (–û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)

**–§–∞–π–ª:** `src/minio_manager.py`

**–§—É–Ω–∫—Ü–∏–∏:**
```python
upload_audio_file(file_path, object_name, metadata)  # –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ
download_audio_file(object_name, file_path)          # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
delete_audio_file(object_name)                        # –£–¥–∞–ª–µ–Ω–∏–µ
list_audio_files(prefix)                              # –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
```

**Bucket:** `voxpersona-audio`

---

## 5. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–û–ù–ù–´–ï –§–ê–ô–õ–´

### 5.1 –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (`.env`)

```bash
# üîë API Keys
OPENAI_API_KEY=sk-proj-...
ANTHROPIC_API_KEY=sk-ant-...
API_ID=21738379
API_HASH=e7e76e237d77713b4dec8e5869f49552
TELEGRAM_BOT_TOKEN=7368149804:AAELma-...
SESSION_BOT_NAME=market_res_bot

# üóÑÔ∏è Database
DB_NAME=voxpersona
DB_USER=voxpersona_user
DB_PASSWORD=...
DB_HOST=localhost
DB_PORT=5432

# ü™£ MinIO
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_AUDIO_BUCKET_NAME=voxpersona-audio

# üìù –ú–æ–¥–µ–ª–∏
REPORT_MODEL_NAME=gpt-4o-mini
TRANSCRIBATION_MODEL_NAME=whisper-1

# üìä Smart Send
TELEGRAM_MESSAGE_THRESHOLD=1200
CHAT_HISTORY_DIR=/home/voxpersona_user/VoxPersona/chat_history
MD_REPORTS_DIR=/home/voxpersona_user/VoxPersona/md_reports
CONVERSATIONS_DIR=/home/voxpersona_user/VoxPersona/conversations

# üß™ Testing
IS_TESTING=false
TEST_USER_ID=123456789
```

### 5.2 Docker

**Dockerfile:** Multi-stage build
```dockerfile
Stage 1: system-base (ffmpeg, build tools)
Stage 2: python-deps (requirements.txt)
Stage 3: pytorch-stage (torch, sentence-transformers)
Stage 4: models-stage (pre-load embedding models)
Stage 5: final (app code)
```

---

## 6. –û–°–ù–û–í–ù–´–ï –ó–ê–í–ò–°–ò–ú–û–°–¢–ò

### 6.1 Python –ø–∞–∫–µ—Ç—ã (requirements.txt - 100+ –ø–∞–∫–µ—Ç–æ–≤)

**–ö–ª—é—á–µ–≤—ã–µ:**
```
# Framework & Bot
pyrogram==2.0.106           # Telegram Bot Framework
asyncio                     # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å

# LLM & RAG
anthropic==0.49.0          # Claude API
openai==1.77.0             # OpenAI API
langchain==0.3.25          # LLM orchestration
langchain-core==0.3.58
langchain-openai==0.3.16
langchain-community==0.3.23

# –í–µ–∫—Ç–æ—Ä–Ω–∞—è –ë–î
faiss-cpu==1.11.0          # FAISS (CPU)
sentence-transformers==4.1.0  # Embedding –º–æ–¥–µ–ª–∏
transformers==4.51.3       # HuggingFace

# –ë–î
psycopg2-binary==2.9.10    # PostgreSQL
asyncpg==0.30.0            # Async PostgreSQL

# –û–±–ª–∞–∫–æ & –•—Ä–∞–Ω–∏–ª–∏—â–µ
minio==7.2.15              # MinIO client

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
pydantic==2.10.6           # Data validation
pandas==2.2.3              # Data manipulation
numpy==2.2.4               # Numerical computing

# Audio
pydub==0.25.1              # Audio processing
librosa                    # Music analysis (implicit)

# Security & Crypto
bcrypt>=4.0.0              # Password hashing
cryptography               # Encryption
pycryptodome==3.22.0       # Additional crypto

# Utils
python-dotenv==1.0.1       # .env loading
requests==2.32.3           # HTTP
aiohttp==3.11.14           # Async HTTP
structlog==24.1.0          # Logging

# Text Processing
pymorphy2==0.9.1           # Russian morphology
regex==2024.11.6           # Advanced regex
```

### 6.2 –°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (Dockerfile)

```bash
build-essential             # –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –¥–ª—è C extensions
ffmpeg                      # Audio/Video processing
libpq-dev                   # PostgreSQL development
g++, gcc                    # C/C++ compilers
pkg-config                  # Package configuration
```

---

## 7. –ì–†–ê–§ –ò–ú–ü–û–†–¢–û–í –ò –ó–ê–í–ò–°–ò–ú–û–°–¢–ò

### 7.1 handlers.py (–≥–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫)

```python
import:
‚îú‚îÄ pyrogram (filters, Client, Message, CallbackQuery)
‚îú‚îÄ config (–≤—Å–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏)
‚îú‚îÄ handlers_my_reports_v2 (v2 –æ—Ç—á–µ—Ç—ã)
‚îú‚îÄ conversation_handlers (–º—É–ª—å—Ç–∏—á–∞—Ç—ã FSM)
‚îú‚îÄ conversation_manager (CRUD —á–∞—Ç–æ–≤)
‚îú‚îÄ access_handlers (üîê —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)
‚îú‚îÄ access_markups (üîê –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–æ—Å—Ç—É–ø–∞)
‚îú‚îÄ auth_filters (üîê –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è filter)
‚îú‚îÄ menus (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ–Ω—é)
‚îú‚îÄ menu_manager (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é)
‚îú‚îÄ message_tracker (–æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π)
‚îú‚îÄ file_sender (–∞–≤—Ç–æ–æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤)
‚îú‚îÄ minio_manager (–æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
‚îú‚îÄ storage (—Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏/–ë–î)
‚îú‚îÄ validators (–≤–∞–ª–∏–¥–∞—Ü–∏—è)
‚îú‚îÄ parser (–ø–∞—Ä—Å–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞)
‚îú‚îÄ analysis (assign_roles)
‚îú‚îÄ audio_utils (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ)
‚îú‚îÄ run_analysis (RAG –∞–Ω–∞–ª–∏–∑)
‚îú‚îÄ md_storage (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ç—á–µ—Ç–æ–≤)
‚îî‚îÄ datamodels (–º–∞–ø–ø–∏–Ω–≥–∏)
```

### 7.2 auth_manager.py (–≥–ª–∞–≤–Ω—ã–π API –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)

```python
import:
‚îú‚îÄ auth_storage (CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏)
‚îú‚îÄ auth_security (bcrypt)
‚îú‚îÄ auth_models (Pydantic –º–æ–¥–µ–ª–∏)
‚îî‚îÄ uuid, hashlib, secrets, datetime
```

### 7.3 conversation_manager.py (–º–µ–Ω–µ–¥–∂–µ—Ä –º—É–ª—å—Ç–∏—á–∞—Ç–æ–≤)

```python
import:
‚îú‚îÄ conversations (Pydantic –º–æ–¥–µ–ª–∏)
‚îú‚îÄ config.CONVERSATIONS_DIR (–ø—É—Ç—å)
‚îî‚îÄ json, pathlib, uuid, datetime
```

---

## 8. –¢–û–ß–ö–ò –í–•–û–î–ê –î–õ–Ø –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –û–ü–ï–†–ê–¶–ò–ô

### 8.1 –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

```
/start (–Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
    ‚Üì
cmd_start_login()
    ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ auth_storage
    ‚Üì
–ó–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è (FSM: "awaiting_password")
    ‚Üì
handle_password_input()
    ‚Üì
auth_manager.authenticate(telegram_id, password)
    ‚Üì
–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ + Audit log
    ‚Üì
‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
```

### 8.2 –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

```
@app.on_message(filters.text & auth_filter)
    ‚Üì
handle_auth_text()
    ‚Üì
handle_authorized_text()  [–æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞]
    ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞ FSM step –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
    ‚îú‚îÄ "dialog_mode"      ‚Üí run_dialog_mode() + RAG –∞–Ω–∞–ª–∏–∑
    ‚îú‚îÄ "ask_employee"     ‚Üí ask_employee() ‚Üí FSM "ask_date"
    ‚îú‚îÄ "ask_date"         ‚Üí ask_date() ‚Üí FSM "ask_employee"
    ‚îú‚îÄ "confirm_data"     ‚Üí show_confirmation_menu()
    ‚îú‚îÄ "edit_*"           ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    ‚îî‚îÄ "renaming_chat"    ‚Üí handle_rename_chat_input()
```

### 8.3 –û–±—Ä–∞–±–æ—Ç–∫–∞ callback

```
@app.on_callback_query()
    ‚Üì
callback_query_handler()
    ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞ TEST_USER_ID (Menu Crawler protection)
    ‚Üì
–†–æ—É—Ç–∏–Ω–≥ –ø–æ callback_data:
    ‚îú‚îÄ –ú—É–ª—å—Ç–∏—á–∞—Ç—ã         ‚Üí handle_new_chat, handle_switch_chat, etc
    ‚îú‚îÄ üîê AUTH           ‚Üí handle_access_menu, handle_users_menu, etc
    ‚îú‚îÄ –û—Ç—á–µ—Ç—ã             ‚Üí handle_report, handle_my_reports_v2
    ‚îú‚îÄ –ú–µ–Ω—é               ‚Üí handle_menu_* —Ñ—É–Ω–∫—Ü–∏–∏
    ‚îú‚îÄ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ     ‚Üí handle_edit_field, handle_back_to_confirm
    ‚îî‚îÄ –§–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏  ‚Üí handle_file_selection, handle_file_deletion
```

### 8.4 –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ—Å–æ–æ–±—â–µ–Ω–∏—è

```
@app.on_message((filters.voice | filters.audio) & auth_filter)
    ‚Üì
handle_audio_msg()
    ‚Üì
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–¥–æ 2GB)
2. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
3. –ó–∞–≥—Ä—É–∑–∫–∞ –≤ MinIO (metadata: user_id, timestamp, status)
4. –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è (OpenAI Whisper)
5. –ï—Å–ª–∏ mode="interview" ‚Üí assign_roles()
6. –ê–≤—Ç–æ–ø–∞—Ä—Å–∏–Ω–≥ –∏–∑ caption (–µ—Å–ª–∏ –µ—Å—Ç—å)
7. FSM "inputing_fields" –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
    ‚Üì
‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∞–Ω–∞–ª–∏–∑—É
```

---

## 9. –•–†–ê–ù–ò–õ–ò–©–ê –î–ê–ù–ù–´–•

### 9.1 –§–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (JSON)

**–î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:**
```
chat_history/                          # –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤
md_reports/                            # MD –æ—Ç—á–µ—Ç—ã (Markdown)
conversations/                         # –ú—É–ª—å—Ç–∏—á–∞—Ç—ã (JSON)
auth_data/                            # üîê AUTH —Å–∏—Å—Ç–µ–º–∞
‚îú‚îÄ‚îÄ users/
‚îú‚îÄ‚îÄ sessions/
‚îú‚îÄ‚îÄ invitations/
‚îú‚îÄ‚îÄ roles.json
‚îî‚îÄ‚îÄ audit_log.json
```

### 9.2 –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (MinIO)

**Bucket:** `voxpersona-audio`
```
s3://voxpersona-audio/
‚îî‚îÄ‚îÄ {user_id}/
    ‚îî‚îÄ‚îÄ {timestamp}_{filename}         # –ê—É–¥–∏–æ—Ñ–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

### 9.3 –†–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –ë–î (PostgreSQL)

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
```
audit                    # –û—Å–Ω–æ–≤–Ω—ã–µ –∞—É–¥–∏—Ç—ã
transcription           # –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã –∞—É–¥–∏–æ
scenario                # –¢–∏–ø—ã —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
report_type             # –¢–∏–ø—ã –æ—Ç—á–µ—Ç–æ–≤
employee                # –§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
client                  # –§–ò–û –∫–ª–∏–µ–Ω—Ç–æ–≤
place                   # –ù–∞–∑–≤–∞–Ω–∏—è –∑–∞–≤–µ–¥–µ–Ω–∏–π
zone                    # –ó–æ–Ω—ã –≤ –∑–∞–≤–µ–¥–µ–Ω–∏—è—Ö
city                    # –ì–æ—Ä–æ–¥–∞
building                # –¢–∏–ø—ã –∑–¥–∞–Ω–∏–π
user_road              # –¶–µ–ø–æ—á–∫–∞ (audit, scenario, report_type, building)
```

---

## 10. –û–°–ù–û–í–ù–´–ï –ú–û–î–ï–õ–ò –î–ê–ù–ù–´–•

### 10.1 User State (FSM)

```python
user_states[chat_id] = {
    "step": str,                    # –¢–µ–∫—É—â–∏–π —à–∞–≥ FSM
    "mode": "interview" | "design", # –°—Ü–µ–Ω–∞—Ä–∏–π
    "conversation_id": str,         # UUID —á–∞—Ç–∞
    "deep_search": bool,            # –†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞
    "data": {                       # –°–æ–±–∏—Ä–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
        "employee": str,
        "date": "YYYY-MM-DD",
        "place_name": str,
        "building_type": str,
        "zone_name": str,
        "city": str,
        "client": str,
        "audio_number": str,
        "audio_file_name": str
    }
}
```

### 10.2 Conversation (–∏–∑ conversations.py)

```python
class ConversationMessage(BaseModel):
    message_id: str                  # UUID
    type: "user_question" | "bot_answer"
    text: str
    timestamp: str                   # ISO format
    tokens: int
    sent_as: "text" | "file"
    search_type: "fast" | "deep"
    file_path: Optional[str]         # –ü—É—Ç—å –∫ MD —Ñ–∞–π–ª—É

class ConversationMetadata(BaseModel):
    conversation_id: str             # UUID
    user_id: int                     # Telegram ID
    username: str
    title: str                       # –ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞
    created_at: str                  # ISO format
    updated_at: str
    is_active: bool
    message_count: int
    total_tokens: int
    chat_number: int                 # –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –Ω–æ–º–µ—Ä (auto-increment)

class Conversation(BaseModel):
    metadata: ConversationMetadata
    messages: List[ConversationMessage]
```

### 10.3 User (–∏–∑ auth_models.py)

```python
class User(BaseModel):
    user_id: str                     # UUID
    telegram_id: int
    username: str
    password_hash: str               # SHA256 (–≤—Ä–µ–º–µ–Ω–Ω–æ, –ø–æ–∑–∂–µ bcrypt)
    role: str                        # super_admin, admin, user, guest
    is_active: bool
    is_blocked: bool
    must_change_password: bool       # –§–ª–∞–≥ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π —Å–º–µ–Ω—ã
    temp_password_expires_at: Optional[datetime]  # TTL 3 –¥–Ω—è
    created_at: datetime
    updated_at: datetime
    created_by_user_id: Optional[str]
    last_login: Optional[datetime]
    login_count: int
    failed_login_attempts: int
    last_failed_login: Optional[datetime]
    password_changed_at: Optional[datetime]
    settings: UserSettings
    metadata: UserMetadata
```

---

## 11. –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –ü–ê–¢–¢–ï–†–ù–´ –ò –ú–ï–•–ê–ù–ò–ó–ú–´

### 11.1 Race Condition Protection

```python
# –í config.py
user_locks: Dict[int, asyncio.Lock] = {}

def get_user_lock(chat_id: int) -> asyncio.Lock:
    if chat_id not in user_locks:
        user_locks[chat_id] = asyncio.Lock()
    return user_locks[chat_id]

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ handlers:
async with get_user_lock(chat_id):
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–∫—Ü–∏—è (view report, rename, delete)
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ó–∞—â–∏—Ç–∞ –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –æ–¥–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

### 11.2 Testing Environment Detection

```python
# –í config.py
def is_testing_environment() -> bool:
    if os.getenv("PYTEST_CURRENT_TEST") is not None:
        return True
    if "pytest" in sys.modules:
        return True
    if os.getenv("IS_TESTING", "false").lower() == "true":
        return True
    if os.getenv("RUN_MODE", "").upper() == "TEST":
        return True
    return False
```

### 11.3 Atomic File Operations

```python
# –í conversation_manager.py
# –î–≤—É—Ö—Ñ–∞–∑–Ω—ã–π commit –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏:

1. –ó–∞–ø–∏—Å—å –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª: {conversation_id}.json.tmp
2. –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ: .tmp ‚Üí .json
3. –ü—Ä–∏ –æ—à–∏–±–∫–µ: –æ—Ç–∫–∞—Ç (—É–¥–∞–ª–µ–Ω–∏–µ .tmp —Ñ–∞–π–ª–æ–≤)
```

### 11.4 Transactional Message Addition

```python
def add_message(user_id, conversation_id, message):
    try:
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–±–æ–∏—Ö —Ñ–∞–π–ª–æ–≤:
        with open(conv_temp, 'w'): json.dump(conversation_data)
        with open(index_temp, 'w'): json.dump(index_data)
        
        # –ê–¢–û–ú–ê–†–ù–û–ï –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –í–°–ï—Ö —Ñ–∞–π–ª–æ–≤:
        conv_temp.replace(conversation_file)
        index_temp.replace(index_file)
        
        return True
    except Exception as e:
        # –û—Ç–∫–∞—Ç –≤—Å–µ—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        cleanup_temp_files([conv_temp, index_temp])
        return False
```

---

## 12. –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ –ò –ê–£–î–ò–¢

### 12.1 –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ RBAC

- –ü–∞—Ä–æ–ª–∏ —Ö–µ—à–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ SHA256 (TODO: bcrypt –≤ T09)
- –°–µ—Å—Å–∏–∏ –∏–º–µ—é—Ç TTL 24 —á–∞—Å–∞
- –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –∏–º–µ—é—Ç TTL 48 —á–∞—Å–æ–≤
- –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `audit_log.json`

### 12.2 Roles & Permissions

**–†–æ–ª–∏:**
- `super_admin` - –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
- `admin` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- `user` - –±–∞–∑–æ–≤—ã–π –¥–æ—Å—Ç—É–ø
- `guest` - —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ

**–ü—Ä–∞–≤–∞** (—Ñ–æ—Ä–º–∞—Ç: `resource.action`):
- `users.*` (create, read, update, delete, block, unblock, change_role)
- `files.*` (upload, download, delete, read)
- `conversations.*` (create, read, update, delete)
- `invitations.*` (create_admin, create_user, read, revoke, list)
- `audit.*` (read)

### 12.3 Menu Crawler Protection

```python
# –î–ª—è TEST_USER_ID –æ—Ç–∫–ª—é—á–µ–Ω—ã –æ–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:
TEST_USER_ID = int(os.getenv('TEST_USER_ID', 0))

if TEST_USER_ID and callback.from_user.id == TEST_USER_ID:
    # –ó–∞–≥—Ä—É–∑–∏—Ç—å config –∏–∑ menu_crawler/config/crawler_config.json
    safe_navigation = ["menu_main", "menu_chats", "menu_system", ...]
    forbidden_actions = ["delete_", "confirm_delete", "upload_", ...]
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã: whitelist > blacklist
```

---

## 13. –ì–õ–ê–í–ù–´–ï –¢–ò–ü–´ –û–ü–ï–†–ê–¶–ò–ô

### 13.1 –ò–Ω—Ç–µ—Ä–≤—å—é (Interview Flow)

```
1. –í—ã–±–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è "–ò–Ω—Ç–µ—Ä–≤—å—é"
2. –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞
3. –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è + assign_roles
4. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö:
   - –ù–æ–º–µ—Ä —Ñ–∞–π–ª–∞ (audio_number)
   - –î–∞—Ç–∞ (date)
   - –§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (employee)
   - –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è (place_name)
   - –¢–∏–ø –∑–∞–≤–µ–¥–µ–Ω–∏—è (building_type)
   - –ó–æ–Ω–∞ (zone_name)
   - –§–ò–û –∫–ª–∏–µ–Ω—Ç–∞ (client) [—Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω—Ç–µ—Ä–≤—å—é]
5. –í—ã–±–æ—Ä –æ—Ç—á–µ—Ç–∞:
   - –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –∏–Ω—Ç–µ—Ä–≤—å—é
   - –°–≤—è–∑–∫–∏
   - –û–±—â–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã
   - –§–∞–∫—Ç–æ—Ä—ã –≤ —ç—Ç–æ–º –∑–∞–≤–µ–¥–µ–Ω–∏–∏
6. –ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ RAG + Claude
7. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –≤ MD
```

### 13.2 –î–∏–∑–∞–π–Ω (Design Flow)

```
–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –Ω–æ –±–µ–∑ "–§–ò–û –∫–ª–∏–µ–Ω—Ç–∞" –∏ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –ø–æ–ª–µ–º "–ì–æ—Ä–æ–¥"
–û—Ç—á–µ—Ç—ã:
- –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –∞—É–¥–∏—Ç–∞
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–µ –∞—É–¥–∏—Ç–∞
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç –∞—É–¥–∏—Ç–∞
```

### 13.3 –ú—É–ª—å—Ç–∏—á–∞—Ç—ã (Multi-Chat Flow)

```
1. –ù–∞–∂–∞—Ç—å "üì± –ß–∞—Ç—ã"
2. "–ù–æ–≤—ã–π —á–∞—Ç" –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
3. –í—ã–±—Ä–∞—Ç—å —Ä–µ–∂–∏–º –ø–æ–∏—Å–∫–∞ (‚ö° –±—ã—Å—Ç—Ä—ã–π –∏–ª–∏ üî¨ –≥–ª—É–±–æ–∫–∏–π)
4. –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å (—Ç–µ–∫—Å—Ç–æ–º)
5. RAG –∞–Ω–∞–ª–∏–∑ + Claude
6. –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:
   - –¢–µ–∫—Å—Ç–æ–º (–µ—Å–ª–∏ < 1200 —Å–∏–º–≤–æ–ª–æ–≤)
   - –§–∞–π–ª–æ–º (–µ—Å–ª–∏ > 1200 —Å–∏–º–≤–æ–ª–æ–≤)
7. –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ conversations/{user_id}/{conversation_id}.json
```

---

## 14. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –°–ö–†–ò–ü–¢–´ –ò –£–¢–ò–õ–ò–¢–´

### 14.1 –°–∫—Ä–∏–ø—Ç—ã –≤ `/scripts`

- `auth_migration.py` - –ú–∏–≥—Ä–∞—Ü–∏—è AUTH —Å–∏—Å—Ç–µ–º—ã
- –î—Ä—É–≥–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

### 14.2 Menu Crawler (–¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

**–ü—É—Ç—å:** `menu_crawler/`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫—Ä–∞—É–ª–µ—Ä –º–µ–Ω—é –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è UI

**–ö–æ–Ω—Ñ–∏–≥:** `menu_crawler/config/crawler_config.json`
```json
{
  "safe_navigation": ["menu_main", "menu_chats", ...],
  "forbidden_actions": ["delete_", "confirm_delete", ...]
}
```

---

## 15. –ì–õ–ê–í–ù–´–ï –û–¢–õ–ò–ß–ò–Ø –ò –û–°–û–ë–ï–ù–ù–û–°–¢–ò

### 15.1 ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

- ‚úÖ –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–ø–∞—Ä–æ–ª—å + —Å–µ—Å—Å–∏—è)
- ‚úÖ RBAC —Å 4 —Ä–æ–ª—è–º–∏
- ‚úÖ –ú—É–ª—å—Ç–∏—á–∞—Ç—ã —Å JSON —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º
- ‚úÖ RAG —Å–∏—Å—Ç–µ–º–∞ —Å 9 –∏–Ω–¥–µ–∫—Å–∞–º–∏
- ‚úÖ Auto-send –¥–ª—è —Ñ–∞–π–ª–æ–≤ > 1200 —Å–∏–º–≤–æ–ª–æ–≤
- ‚úÖ Message Tracker –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ MinIO –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤
- ‚úÖ Atomic file operations —Å –¥–≤—É—Ö—Ñ–∞–∑–Ω—ã–π commit
- ‚úÖ Race condition protection —á–µ—Ä–µ–∑ asyncio.Lock
- ‚úÖ Auth audit log

### 15.2 üîÑ –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ / TODO

- üîÑ –ó–∞–º–µ–Ω–∞ SHA256 –Ω–∞ bcrypt –≤ T09
- üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è SMTP –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
- üîÑ Web UI –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- üîÑ –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- üîÑ Rate limiting –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

### 15.3 üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

| –†–µ—à–µ–Ω–∏–µ | –í—ã–±–æ—Ä | –ü–æ—á–µ–º—É |
|---------|-------|--------|
| –•—Ä–∞–Ω–∏–ª–∏—â–µ —á–∞—Ç–æ–≤ | JSON | KISS, –ø—Ä–æ—Å—Ç–æ—Ç–∞, –Ω–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ—Ç –ë–î |
| –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è | JSON —Ñ–∞–π–ª—ã | –ü—Ä–æ—Å—Ç–æ—Ç–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ë–î |
| –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | –í –ø–∞–º—è—Ç–∏ (config.py) | –°–∫–æ—Ä–æ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ—Ç–∞ –¥–ª—è FSM |
|Êä•Âëä—Ö—Ä–∞–Ω–∏–ª–∏—â–µ | Markdown + JSON –∏–Ω–¥–µ–∫—Å | –ß–∏—Ç–∞–µ–º–æ, –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä—É–µ–º–æ, –ø—Ä–æ—Å—Ç–æ |
| –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è | –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ | –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ—Ä—Ä—É–ø—Ç–æ–≤ |

---

## 16. –ë–´–°–¢–†–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø –ü–û –§–ê–ô–õ–ê–ú

```
–ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏...                              –ò—â–∏—Ç–µ –≤...
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ì–ª–∞–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π        src/handlers.py
–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                   src/auth_manager.py
–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –≤ handler'–µ          src/auth_filters.py
–ú–µ–Ω–µ–¥–∂–µ—Ä –º—É–ª—å—Ç–∏—á–∞—Ç–æ–≤                       src/conversation_manager.py
–†–∞–±–æ—Ç–∞ —Å –æ—Ç—á–µ—Ç–∞–º–∏ (v2)                     src/handlers_my_reports_v2.py
–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ UI                          src/menus.py + src/markups.py
–†–∞–±–æ—Ç–∞ —Å –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞–º–∏                      src/audio_utils.py
–û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ                         src/minio_manager.py
–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π                     src/message_tracker.py
–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö                   src/validators.py
–ö–æ–Ω—Ñ–∏–≥ –∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ              src/config.py
PostgreSQL –æ–ø–µ—Ä–∞—Ü–∏–∏                        src/db_handler/db.py
RAG –∏–Ω–¥–µ–∫—Å—ã (–∑–∞–≥—Ä—É–∑–∫–∞/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)          src/rag_persistence.py
–ú–∞–ø–ø–∏–Ω–≥–∏ (—Å—Ü–µ–Ω–∞—Ä–∏–∏, —Ç–∏–ø—ã –æ—Ç—á–µ—Ç–æ–≤)          src/datamodels.py
–ú–æ–¥–µ–ª–∏ —á–∞—Ç–æ–≤ (Pydantic)                    src/conversations.py
–ú–æ–¥–µ–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (Pydantic)              src/auth_models.py
CRUD –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏                           src/auth_storage.py
Security —Ñ—É–Ω–∫—Ü–∏–∏                           src/auth_security.py
–°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã                        src/constants.py
```

---

## 17. –†–ï–ó–Æ–ú–ï

**–¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞:** Telegram Bot –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤—å—é –∏ –∞—É–¥–∏—Ç–æ–≤  
**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** FSM (Finite State Machine) + RAG (Retrieval Augmented Generation)  
**–ë–î:** PostgreSQL + JSON —Ñ–∞–π–ª—ã + MinIO S3  
**–Ø–∑—ã–∫:** Python 3.10.11  
**Framework:** Pyrogram (Telegram), LangChain (RAG), Pydantic (validation)  

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
1. ‚úÖ –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (AUTH —Å–∏—Å—Ç–µ–º–∞)
2. ‚úÖ RBAC —Å 4 —Ä–æ–ª—è–º–∏ –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
3. ‚úÖ –ú—É–ª—å—Ç–∏—á–∞—Ç—ã —Å JSON —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º
4. ‚úÖ RAG —Å–∏—Å—Ç–µ–º–∞ —Å 9 –∏–Ω–¥–µ–∫—Å–∞–º–∏
5. ‚úÖ MinIO –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤
6. ‚úÖ Message Tracker –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
7. ‚úÖ Atomic file operations –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
8. ‚úÖ Race condition protection
9. ‚úÖ –ü–æ–ª–Ω—ã–π audit log –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π

**–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:**
- FSM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- Singleton pattern –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ (conversation_manager, etc)
- Atomic operations –¥–ª—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- Async/await –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

---

**–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω:** 4 –Ω–æ—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ READY FOR PRODUCTION (—Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ TODO)
