# MD Cleanup Implementation Report

## üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ö–∞–Ω–∏–∑–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è MD —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Ç–æ–≤, –∞ —Ç–∞–∫–∂–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∏ "–æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏—Ö" MD –æ—Ç—á–µ—Ç–æ–≤.

## üîß –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. **conversation_manager.py**

#### –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `delete_conversation` (—Å—Ç—Ä–æ–∫–∏ 336-410)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- Docstring –æ–±–Ω–æ–≤–ª–µ–Ω: —Ç–µ–ø–µ—Ä—å —É–∫–∞–∑—ã–≤–∞–µ—Ç "–£–¥–∞–ª—è–µ—Ç —á–∞—Ç **–∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ MD —Ñ–∞–π–ª—ã**"
- –î–æ–±–∞–≤–ª–µ–Ω cleanup MD —Ñ–∞–π–ª–æ–≤ –ü–ï–†–ï–î —É–¥–∞–ª–µ–Ω–∏–µ–º JSON —á–∞—Ç–∞

**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:**
```python
def delete_conversation(self, user_id: int, conversation_id: str) -> bool:
    try:
        # 1. –°–ù–ê–ß–ê–õ–ê –∑–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è file_path
        conversation = self.load_conversation(user_id, conversation_id)
        
        md_files_deleted = 0
        if conversation:
            # 2. –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ MD —Ñ–∞–π–ª—ã –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
            md_files_to_delete = [
                msg.file_path
                for msg in conversation.messages
                if msg.file_path and msg.sent_as == "file"
            ]
            
            # 3. –£–¥–∞–ª—è–µ–º MD —Ñ–∞–π–ª—ã
            for file_path in md_files_to_delete:
                try:
                    full_path = Path(file_path)
                    if full_path.exists():
                        full_path.unlink()
                        md_files_deleted += 1
                        logger.info(f"Deleted MD file: {file_path}")
                except Exception as e:
                    logger.warning(f"Failed to delete MD file {file_path}: {e}")
            
            if md_files_deleted > 0:
                logger.info(f"Deleted {md_files_deleted} MD files for conversation {conversation_id}")
        
        # 4. –î–∞–ª–µ–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞ (JSON —Ñ–∞–π–ª, index.json –∏ —Ç.–¥.)
        ...
```

**–ì–∞—Ä–∞–Ω—Ç–∏–∏:**
- ‚úÖ MD —Ñ–∞–π–ª—ã —É–¥–∞–ª—è—é—Ç—Å—è –ü–ï–†–ï–î —É–¥–∞–ª–µ–Ω–∏–µ–º JSON
- ‚úÖ –ö–∞–∂–¥–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –æ–±–µ—Ä–Ω—É—Ç–æ –≤ try-except
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
- ‚úÖ –ü–æ–¥—Å—á–µ—Ç —É–¥–∞–ª–µ–Ω–Ω—ã—Ö MD —Ñ–∞–π–ª–æ–≤

### 2. **md_storage.py**

#### –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã (—Å—Ç—Ä–æ–∫–∏ 326-417)

##### 2.1 `find_orphaned_reports(user_id: int) -> List[str]`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ù–∞—Ö–æ–¥–∏—Ç MD –æ—Ç—á–µ—Ç—ã –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∏ —Å –æ–¥–Ω–∏–º —á–∞—Ç–æ–º

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ MD —Ñ–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ `get_user_reports(user_id, limit=None)`
2. –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ `conversation_manager.list_conversations(user_id)`
3. –°–æ–±–∏—Ä–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –≤—Å–µ—Ö `file_path` –∏–∑ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤—Å–µ—Ö —á–∞—Ç–æ–≤
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ MD —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –º–Ω–æ–∂–µ—Å—Ç–≤–µ linked_files

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `List[str]` - —Å–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π –∫ –æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏–º —Ñ–∞–π–ª–∞–º

##### 2.2 `cleanup_orphaned_reports(user_id: int) -> int`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–¥–∞–ª—è–µ—Ç –æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏–µ MD –æ—Ç—á–µ—Ç—ã

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –í—ã–∑—ã–≤–∞–µ—Ç `find_orphaned_reports(user_id)` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞
2. –£–¥–∞–ª—è–µ—Ç –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
3. –í—ã–∑—ã–≤–∞–µ—Ç `_remove_from_index(orphaned)` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è index.json
4. –õ–æ–≥–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `int` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

##### 2.3 `_remove_from_index(file_paths: List[str])` (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ –æ–± —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö –∏–∑ index.json

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç `md_reports/index.json`
2. –§–∏–ª—å—Ç—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –æ—Ç—á–µ—Ç–æ–≤, —É–¥–∞–ª—è—è –∑–∞–ø–∏—Å–∏ —Å file_path –∏–∑ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
3. –ê—Ç–æ–º–∞—Ä–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å
4. –õ–æ–≥–∏—Ä—É–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

#### –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `get_user_reports`
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –°–∏–≥–Ω–∞—Ç—É—Ä–∞: `limit: int = 10` ‚Üí `limit: Optional[int] = 10`
- –õ–æ–≥–∏–∫–∞: `return user_reports[:limit]` ‚Üí `return user_reports if limit is None else user_reports[:limit]`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –í–°–ï–• –æ—Ç—á–µ—Ç–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ orphaned —Ñ–∞–π–ª–æ–≤

### 3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ –≤ utils.py**

–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ, —á—Ç–æ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–ª–∏–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ `file_path` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ conversations:

```python
# utils.py, —Å—Ç—Ä–æ–∫–∞ 443
if conversation_id:
    success = await asyncio.to_thread(
        _save_to_conversation_with_retry,
        chat_id, conversation_id, sent_file_msg.id, "bot_answer", text,
        sent_as="file", 
        file_path=file_path,  # ‚úÖ file_path –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è
        search_type=search_type
    )
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è:

1. **–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Ç–∞:**
   - ‚úÖ MD —Ñ–∞–π–ª—ã —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –∫–∞–∂–¥–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
   - ‚úÖ –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
   - ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞

2. **–ú–µ—Ç–æ–¥ –ø–æ–∏—Å–∫–∞ orphaned —Ñ–∞–π–ª–æ–≤:**
   - ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ —á–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

3. **Cleanup –º–µ—Ö–∞–Ω–∏–∑–º:**
   - ‚úÖ –£–¥–∞–ª—è–µ—Ç orphaned —Ñ–∞–π–ª—ã
   - ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç index.json
   - ‚úÖ –õ–æ–≥–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
   - ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö

4. **–ù–µ—Ç "–º—É—Å–æ—Ä–Ω—ã—Ö" MD —Ñ–∞–π–ª–æ–≤:**
   - ‚úÖ –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Ç–∞
   - ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä—É—á–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ —á–µ—Ä–µ–∑ `cleanup_orphaned_reports()`

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç: `src/test_md_cleanup.py`

**–ó–∞–ø—É—Å–∫:**
```bash
cd /home/voxpersona_user/VoxPersona/src
python test_md_cleanup.py
```

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç:**
1. –ü–æ–∏—Å–∫ –æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏—Ö MD —Ñ–∞–π–ª–æ–≤
2. Cleanup –æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏—Ö —Ñ–∞–π–ª–æ–≤
3. –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —É–¥–∞–ª–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö MD —Ñ–∞–π–ª–æ–≤

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –§–∞–π–ª | –°—Ç—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–æ | –ú–µ—Ç–æ–¥–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–æ | –ú–µ—Ç–æ–¥–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ |
|------|-----------------|-------------------|------------------|
| conversation_manager.py | ~40 | 0 | 1 (delete_conversation) |
| md_storage.py | ~95 | 3 | 1 (get_user_reports) |
| **–ò–¢–û–ì–û** | **~135** | **3** | **2** |

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è –æ–±–µ—Ä–Ω—É—Ç—ã –≤ try-except
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ index.json
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
- ‚úÖ –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É–¥–∞–ª–∏—Ç—å "–∂–∏–≤—ã–µ" —Ñ–∞–π–ª—ã (—Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —á–∞—Ç–∞–º–∏)

## üìù –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞:**
   - –î–æ–±–∞–≤–∏—Ç—å cron job –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ orphaned —Ñ–∞–π–ª–æ–≤
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ systemd timer

2. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
   - –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ orphaned —Ñ–∞–π–ª–æ–≤

3. **–ú–µ—Ç—Ä–∏–∫–∏:**
   - –î–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤ Prometheus

---

**–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 5 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ  
**–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** Python 3.11+, VoxPersona v1.0+
