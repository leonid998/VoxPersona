# –°–∏—Å—Ç–µ–º–∞ —É–º–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∏—Å—Ç–æ—Ä–∏–µ–π –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ñ–∞–π–ª–æ–≤

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —É–º–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ Telegram –±–æ—Ç–∞ VoxPersona —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤—ã–±–æ—Ä–æ–º —Ñ–æ—Ä–º–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏, –≤–µ–¥–µ–Ω–∏–µ–º –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤ –∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—Ç—á–µ—Ç–æ–≤. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ—à–∞–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –∫–∞–∫ MD-—Ñ–∞–π–ª –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–ª–∏–Ω—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞.

## –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### ü§ñ –£–º–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (Smart Send)
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞**: –°–æ–æ–±—â–µ–Ω–∏—è –¥–æ 1200 —Å–∏–º–≤–æ–ª–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–∞–∫ —Ç–µ–∫—Å—Ç, –¥–ª–∏–Ω–Ω—ã–µ - –∫–∞–∫ MD-—Ñ–∞–π–ª—ã
- **Preview –¥–ª—è —Ñ–∞–π–ª–æ–≤**: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—ã–µ 300 —Å–∏–º–≤–æ–ª–æ–≤ —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
- **Fallback –º–µ—Ö–∞–Ω–∏–∑–º**: –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–±–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –∏ –∞—Ä—Ö–∏–≤ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π

### üìö –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤
- **–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã**: –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö JSON —Ñ–∞–π–ª–∞—Ö –ø–æ –¥–Ω—è–º
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Å—á–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤, –æ—Ç–≤–µ—Ç–æ–≤, —Ç–æ–∫–µ–Ω–æ–≤, —Ç–∏–ø–æ–≤ –ø–æ–∏—Å–∫–∞
- **–ö–æ–º–∞–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: `/history [–¥–∞—Ç–∞]`, `/stats` –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏

### üìÅ –ê—Ä—Ö–∏–≤ MD-–æ—Ç—á–µ—Ç–æ–≤
- **–ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ**: –í—Å–µ –¥–ª–∏–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ MD-—Ñ–∞–π–ª—ã
- **–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è**: –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º (–¥–∞—Ç–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –≤–æ–ø—Ä–æ—Å, —Ç–∏–ø –ø–æ–∏—Å–∫–∞)
- **–ö–æ–º–∞–Ω–¥–∞ `/reports`**: –ü—Ä–æ—Å–º–æ—Ç—Ä –∏ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–º**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **`src/utils.py`** - –§—É–Ω–∫—Ü–∏–∏ —É–º–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
   - `smart_send_text_sync()` - –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —É–º–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
   - `create_preview_text()` - –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–≤—å—é –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
   - `get_username_from_chat()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

2. **`src/chat_history.py`** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π —á–∞—Ç–æ–≤
   - `ChatHistoryManager` - –û—Å–Ω–æ–≤–Ω–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
   - –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö: `Message`, `DayStats`, `DayHistory`
   - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

3. **`src/md_storage.py`** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–æ–º –æ—Ç—á–µ—Ç–æ–≤
   - `MDStorageManager` - –ú–µ–Ω–µ–¥–∂–µ—Ä MD —Ñ–∞–π–ª–æ–≤
   - `ReportMetadata` - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–æ–≤
   - –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤

4. **`src/handlers.py`** - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - `handle_history_command()` - –ö–æ–º–∞–Ω–¥–∞ `/history`
   - `handle_stats_command()` - –ö–æ–º–∞–Ω–¥–∞ `/stats`
   - `handle_reports_command()` - –ö–æ–º–∞–Ω–¥–∞ `/reports`

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

–°–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –±–æ—Ç–∞:
- **`run_analysis.py`**: –ó–∞–º–µ–Ω–µ–Ω—ã –≤—ã–∑–æ–≤—ã `split_and_send_long_text()` –Ω–∞ `smart_send_text_sync()`
- **`handlers.py`**: –î–æ–±–∞–≤–ª–µ–Ω—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥
- **`config.py`**: –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–æ–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1200)
TELEGRAM_MESSAGE_THRESHOLD=1200

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤
CHAT_HISTORY_DIR=/home/voxpersona_user/VoxPersona/chat_history

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è MD –æ—Ç—á–µ—Ç–æ–≤
MD_REPORTS_DIR=/home/voxpersona_user/VoxPersona/md_reports

# –î–ª–∏–Ω–∞ –ø—Ä–µ–≤—å—é —Ç–µ–∫—Å—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 300)
PREVIEW_TEXT_LENGTH=300
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

```
chat_history/
‚îú‚îÄ‚îÄ user_123456/
‚îÇ   ‚îú‚îÄ‚îÄ 2025-10-02.json
‚îÇ   ‚îú‚îÄ‚îÄ 2025-10-03.json
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ user_789012/
    ‚îî‚îÄ‚îÄ ...

md_reports/
‚îú‚îÄ‚îÄ user_123456/
‚îÇ   ‚îú‚îÄ‚îÄ voxpersona_20251002_143520.md
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ user_789012/
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ index.json
```

## –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã

### `/history [–¥–∞—Ç–∞]`
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –¥–µ–Ω—å (–∏–ª–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è, –µ—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞).

**–ü—Ä–∏–º–µ—Ä—ã:**
- `/history` - –∏—Å—Ç–æ—Ä–∏—è –∑–∞ —Å–µ–≥–æ–¥–Ω—è
- `/history 2025-01-15` - –∏—Å—Ç–æ—Ä–∏—è –∑–∞ 15 —è–Ω–≤–∞—Ä—è 2025
- `/history 15.01.2025` - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã

**–í—ã–≤–æ–¥:**
```
üìä –ò—Å—Ç–æ—Ä–∏—è –∑–∞ 02.10.2025

ü§î –í–æ–ø—Ä–æ—Å—ã: 3
ü§ñ –û—Ç–≤–µ—Ç—ã: 3
‚ö° –ë—ã—Å—Ç—Ä—ã—Ö –ø–æ–∏—Å–∫–æ–≤: 2
üîç –ì–ª—É–±–æ–∫–∏—Ö –ø–æ–∏—Å–∫–æ–≤: 1
üìù –¢–æ–∫–µ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: 1,250

**–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:**
üë§ 14:35: –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å MinIO?
‚ö° 14:36: –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å MinIO...
```

### `/stats`
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π.

**–í—ã–≤–æ–¥:**
```
üìà **–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–∑–∞ 30 –¥–Ω–µ–π):**

üìÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö –¥–Ω–µ–π: 15
ü§î –í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: 127
ü§ñ –í—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤: 127
‚ö° –ë—ã—Å—Ç—Ä—ã—Ö –ø–æ–∏—Å–∫–æ–≤: 89
üîç –ì–ª—É–±–æ–∫–∏—Ö –ø–æ–∏—Å–∫–æ–≤: 38
üìù –í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤: 45,670
üìé –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: 23

üí° –°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ –≤–æ–ø—Ä–æ—Å–∞: 359.6 —Ç–æ–∫–µ–Ω–æ–≤
üéØ –ì–ª—É–±–æ–∫–∏—Ö –ø–æ–∏—Å–∫–æ–≤: 29.9%
```

### `/reports`
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏.

**–§—É–Ω–∫—Ü–∏–∏:**
- –ü–æ–∫–∞–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 –æ—Ç—á–µ—Ç–æ–≤ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
- –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –æ—Ç—á–µ—Ç—ã" –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –æ—Ç—á–µ—Ç–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã Smart Send

### –ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π

```python
if len(text) <= TELEGRAM_MESSAGE_THRESHOLD:
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    send_message(text)
    save_to_history(sent_as="message")
else:
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Ñ–∞–π–ª
    send_preview(text[:PREVIEW_TEXT_LENGTH] + "...")
    save_md_file(text)
    send_document(md_file)
    save_to_history(sent_as="file", file_path=md_file)
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

1. **–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞** ‚Üí Fallback –∫ `split_and_send_long_text()`
2. **–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è MD** ‚Üí –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É
3. **–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é** ‚Üí –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É

## –§–æ—Ä–º–∞—Ç MD-—Ñ–∞–π–ª–æ–≤

```markdown
# –û—Ç—á–µ—Ç VoxPersona
**–î–∞—Ç–∞:** 02.10.2025 14:35
**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** @username (ID: 123456)
**–ó–∞–ø—Ä–æ—Å:** –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö?
**–¢–∏–ø –ø–æ–∏—Å–∫–∞:** deep

---

[–ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –±–æ—Ç–∞]
```

## –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### Message (–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π)
```python
@dataclass
class Message:
    timestamp: str          # ISO 8601 timestamp
    message_id: int         # ID —Å–æ–æ–±—â–µ–Ω–∏—è Telegram
    type: str              # "user_question" | "bot_answer"
    text: str              # –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    tokens: int            # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤
    sent_as: Optional[str] # "message" | "file" (—Ç–æ–ª—å–∫–æ –¥–ª—è bot_answer)
    file_path: Optional[str] # –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É (–µ—Å–ª–∏ sent_as="file")
    search_type: Optional[str] # "fast" | "deep" (—Ç–æ–ª—å–∫–æ –¥–ª—è bot_answer)
```

### ReportMetadata (–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–æ–≤)
```python
@dataclass
class ReportMetadata:
    file_path: str      # –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
    user_id: int        # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    username: str       # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    timestamp: str      # –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
    question: str       # –ò—Å—Ö–æ–¥–Ω—ã–π –≤–æ–ø—Ä–æ—Å
    size_bytes: int     # –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
    tokens: int         # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤
    search_type: str    # –¢–∏–ø –ø–æ–∏—Å–∫–∞
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –∏ –∞—Ä—Ö–∏–≤ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É
- **–õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞**: –ú–µ–Ω–µ–¥–∂–µ—Ä—ã —Å–æ–∑–¥–∞—é—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ò–Ω–¥–µ–∫—Å—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **–ò–∑–æ–ª—è—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**: –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø—É—Ç–µ–π**: –ó–∞—â–∏—Ç–∞ –æ—Ç path traversal –∞—Ç–∞–∫
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤**: –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞–∑–º–µ—Ä–æ–≤ —Ñ–∞–π–ª–æ–≤ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:
- `test_chat_history.py` - –¢–µ—Å—Ç—ã —Å–∏—Å—Ç–µ–º—ã –∏—Å—Ç–æ—Ä–∏–∏
- `test_md_storage.py` - –¢–µ—Å—Ç—ã –∞—Ä—Ö–∏–≤–∞ –æ—Ç—á–µ—Ç–æ–≤  
- `test_smart_send.py` - –¢–µ—Å—Ç—ã —É–º–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏

–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:
```bash
pytest test_chat_history.py test_md_storage.py test_smart_send.py -v
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ —É—Ä–æ–≤–Ω—è–º–∏:
- `INFO`: –£—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- `ERROR`: –û—à–∏–±–∫–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- `DEBUG`: –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```python
# –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
md_storage_manager.cleanup_old_reports(days_old=30)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∞—Ä—Ö–∏–≤–∞
integrity = md_storage_manager.validate_integrity()
```

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**: –ì—Ä–∞—Ñ–∏–∫–∏ –∏ —Ç—Ä–µ–Ω–¥—ã –ø–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
2. **–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
3. **–ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏**: –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏—è–º
4. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Ä–æ–≥–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
5. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞–º–∏**: S3, Google Drive –¥–ª—è –∞—Ä—Ö–∏–≤–∞

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —É–º–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
- ‚úÖ –ü–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –≤—Å–µ—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
- ‚úÖ –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤
- ‚úÖ –£–¥–æ–±–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –í—ã—Å–æ–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç—É –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–∏–∑–∞–π–Ω—É –∏ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–Ω-—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é.