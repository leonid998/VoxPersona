# –ß–µ–∫–ª–∏—Å—Ç –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Retry –ú–µ—Ö–∞–Ω–∏–∑–º–∞

## ‚úÖ Pre-Deployment Checklist

### 1. –ö–æ–¥
- [x] –ò–º–ø–æ—Ä—Ç `functools.wraps` –¥–æ–±–∞–≤–ª–µ–Ω
- [x] –î–µ–∫–æ—Ä–∞—Ç–æ—Ä `retry_on_failure` —Å–æ–∑–¥–∞–Ω
- [x] –°–∏–≥–Ω–∞—Ç—É—Ä–∞ `_save_to_conversation` –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ `-> bool`
- [x] Return values –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `_save_to_conversation`
- [x] –§—É–Ω–∫—Ü–∏—è `_save_to_conversation_with_retry` —Å–æ–∑–¥–∞–Ω–∞
- [x] –í—ã–∑–æ–≤—ã –≤ `smart_send_text_unified` –æ–±–Ω–æ–≤–ª–µ–Ω—ã (2 –º–µ—Å—Ç–∞)
- [x] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [x] –°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω (Python AST)

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞
- [x] –í—Å–µ –∫–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
- [ ] Unit —Ç–µ—Å—Ç—ã –¥–ª—è retry –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] Integration —Ç–µ—Å—Ç—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [x] `RETRY_MECHANISM_CHANGES.md` —Å–æ–∑–¥–∞–Ω
- [x] `RETRY_FIX_SUMMARY.txt` —Å–æ–∑–¥–∞–Ω
- [x] `RETRY_EXAMPLE.md` —Å–æ–∑–¥–∞–Ω
- [x] –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Å–æ–∑–¥–∞–Ω—ã

### 4. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] `utils.py.backup` - –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
- [x] `utils_original.py` - –¥—É–±–ª–∏–∫–∞—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞

---

## üöÄ Deployment Steps

### –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å–æ–∑–¥–∞—Ç—å backup —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
ssh root@172.237.73.207 "cp /root/bots/voxpersona/src/utils.py /root/bots/voxpersona/src/utils.py.pre-retry-backup"
```

### –®–∞–≥ 2: –î–µ–ø–ª–æ–π
```bash
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä
scp C:/Users/l0934/Projects/VoxPersona/src/utils.py root@172.237.73.207:/root/bots/voxpersona/src/
```

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
ssh root@172.237.73.207 "docker restart voxpersona-bot"
```

### –®–∞–≥ 4: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
ssh root@172.237.73.207 "docker logs -f voxpersona-bot"
```

---

## üîç Post-Deployment Verification

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
docker ps | grep voxpersona-bot
# –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å RUNNING —Å—Ç–∞—Ç—É—Å
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –Ω–∞ –æ—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞
```bash
# –ò—Å–∫–∞—Ç—å ImportError –∏–ª–∏ SyntaxError
docker logs voxpersona-bot 2>&1 | grep -E "ImportError|SyntaxError|Error"
# –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å utils.py
```

### 3. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç
- [ ] –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è –≤ conversation
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ "Saved to conversation"

### 4. –¢–µ—Å—Ç retry –º–µ—Ö–∞–Ω–∏–∑–º–∞ (—Å–∏–º—É–ª—è—Ü–∏—è)
–í—Ä–µ–º–µ–Ω–Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–¥:
```python
# –í _save_to_conversation –¥–ª—è —Ç–µ—Å—Ç–∞
if random.random() < 0.7:  # 70% —à–∞–Ω—Å –Ω–∞ –ø—Ä–æ–≤–∞–ª
    return False
```
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ retry —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ "Retry 1/3", "Retry 2/3"
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ø–µ—à–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ retry

### 5. –¢–µ—Å—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏
–í—Ä–µ–º–µ–Ω–Ω–æ:
```python
# –í _save_to_conversation –¥–ª—è —Ç–µ—Å—Ç–∞
return False  # –í—Å–µ–≥–¥–∞ False
```
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ "CRITICAL: Failed to save conversation"

---

## üìä Monitoring Metrics

### –ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:
1. **–ß–∞—Å—Ç–æ—Ç–∞ retry**
   - –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –¥–µ–Ω—å —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç retry?
   - –ù–∞ –∫–∞–∫–æ–º attempt –æ–±—ã—á–Ω–æ —É—Å–ø–µ—Ö?

2. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏**
   - –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—Å–µ 3 –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å?
   - –ö–∞–∫–∏–µ error messages?

3. **Performance**
   - –î–æ–±–∞–≤–ª–µ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç retry (max 3s)
   - –í–ª–∏—è–Ω–∏–µ –Ω–∞ –æ–±—â—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ê–ª–µ—Ä—Ç–∏–Ω–≥
–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –ø—Ä–∏:
- –ë–æ–ª–µ–µ 10 CRITICAL –æ—à–∏–±–æ–∫ –≤ —á–∞—Å
- –ë–æ–ª–µ–µ 50% —Å–æ–æ–±—â–µ–Ω–∏–π —Ç—Ä–µ–±—É—é—Ç retry
- –õ—é–±—ã–µ SyntaxError/ImportError

---

## üîÑ Rollback Plan

### –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

#### –í–∞—Ä–∏–∞–Ω—Ç 1: –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–∫–∞—Ç
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤–µ—Ä–Ω—É—Ç—å backup
ssh root@172.237.73.207 "cp /root/bots/voxpersona/src/utils.py.pre-retry-backup /root/bots/voxpersona/src/utils.py"
ssh root@172.237.73.207 "docker restart voxpersona-bot"
```

#### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Ç–∫–∞—Ç —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –∫–æ–ø–∏–∏
```bash
# –ó–∞–ª–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
scp C:/Users/l0934/Projects/VoxPersona/src/utils.py.backup root@172.237.73.207:/root/bots/voxpersona/src/utils.py
ssh root@172.237.73.207 "docker restart voxpersona-bot"
```

#### –í–∞—Ä–∏–∞–Ω—Ç 3: Git revert (–µ—Å–ª–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏)
```bash
ssh root@172.237.73.207 "cd /root/bots/voxpersona && git checkout utils.py && docker restart voxpersona-bot"
```

---

## üìù Notes

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã:
1. **asyncio.to_thread()** —Ç—Ä–µ–±—É–µ—Ç Python 3.9+
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Python >= 3.9
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: `python --version`

2. **functools.wraps** - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
   - –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

3. **Event loop**
   - Retry –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –±–ª–∞–≥–æ–¥–∞—Ä—è asyncio.to_thread()
   - –¢–µ—Å—Ç—ã –Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è

### –û–∂–∏–¥–∞–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–æ–≤–µ–¥–µ–Ω–∏–∏:
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è debugging

---

## ‚úÖ Sign-off

- [ ] –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–µ–Ω –∏ –≥–æ—Ç–æ–≤
- [ ] Backup —Å–æ–∑–¥–∞–Ω
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
- [ ] Deployment plan —É—Ç–≤–µ—Ä–∂–¥–µ–Ω
- [ ] Rollback plan –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] –ö–æ–º–∞–Ω–¥–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∞

**–î–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** 5 –æ–∫—Ç—è–±—Ä—è 2025  
**Responsible:** Backend Developer  
**Approver:** _____________  
**Deployed by:** _____________  
**Deployment date:** _____________

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ Ready for Production Deployment
