# 🎨 VoxPersona UI - Быстрый справочник

## 📊 Все меню одним взглядом

```
┌─────────────────────────────────────────────────────────────┐
│                    🏠 ГЛАВНОЕ МЕНЮ                          │
├─────────────────────────────────────────────────────────────┤
│  📱 Чаты/Диалоги                                            │
│  ⚙️ Системная                      ❓ Помощь                │
└─────────────────────────────────────────────────────────────┘
         │                               │
         │                               └─→ [Текст инструкций]
         │                                   [« Назад]
         │
         ├─→ 📱 МЕНЮ ЧАТОВ
         │   ┌────────────────────────────────────────────┐
         │   │ [🆕 Новый чат]         [« Назад]           │
         │   │ [📊 Статистика]        [📄 Мои отчеты]     │
         │   ├────────────────────────────────────────────┤
         │   │ [📝 1. Активный чат...] [✏️] [🗑️]          │
         │   │ [💬 2. Другой чат...]   [✏️] [🗑️]          │
         │   │ [💬 3. Ещё один...]     [✏️] [🗑️]          │
         │   └────────────────────────────────────────────┘
         │        │         │        │
         │        │         │        └─→ [Подтверждение удаления]
         │        │         │            [🗑️ Да, удалить] [❌ Отмена]
         │        │         │
         │        │         └─→ [Ввод нового названия]
         │        │
         │        └─→ 🔍 РЕЖИМ ДИАЛОГА
         │            ┌────────────────────────────────────┐
         │            │ [⚡ Быстрый] [🔬 Глубокое]          │
         │            │ [📱 Чаты/Диалоги]                  │
         │            └────────────────────────────────────┘
         │
         └─→ ⚙️ СИСТЕМНАЯ
             ┌────────────────────────┐
             │ [📁 Хранилище]         │
             │ [« Назад]              │
             └────────────────────────┘
                  │
                  └─→ [ИНТЕРВЬЮ] [ДИЗАЙН] [« Назад]
                       │          │
                       │          └─→ 📄 ОТЧЁТЫ ДИЗАЙНА
                       │              [1) Оценка методологии]
                       │              [2) Соответствие программе]
                       │              [3) Структурированный отчет]
                       │              [« Назад]
                       │
                       └─→ 📄 ОТЧЁТЫ ИНТЕРВЬЮ
                           [1) Оценка методологии]
                           [2) Отчет о связках]
                           [3) Общие факторы]
                           [4) Факторы в заведении]
                           [« Назад]
```

---

## 🎯 Основные UI паттерны

### 1. Формат кнопки чата
```
┌──────────────────────┬──────────┬─────────┐
│ 📝 1. Название...    │ ✏️ Измен │ 🗑️ Удал │  ← 50% / 25% / 25%
└──────────────────────┴──────────┴─────────┘
```

### 2. Типичное двухуровневое меню
```
Строка 1: [Действие 1]     [Действие 2]
Строка 2: [« Назад]        или [Главное меню]
```

### 3. Подтверждающее диалог
```
Текст предупреждения/вопроса

[✅ Да/Подтвердить]  [❌ Отмена/Назад]
```

---

## 🔄 Жизненный цикл меню

```
1. Пользователь нажимает кнопку
   ↓
2. callback_query_handler получает callback_data
   ↓
3. Обработчик вызывает send_menu()
   ↓
4. MenuManager:
   • Удаляет старое меню (delete_messages)
   • Отправляет новое меню (send_message)
   • Сохраняет message_id в _last_menu_ids
   ↓
5. Пользователь видит ТОЛЬКО новое меню внизу чата
```

---

## 📋 Callback паттерны

### Простые (без параметров)
```python
"menu_main"       → Главное меню
"menu_chats"      → Меню чатов
"new_chat"        → Создать чат
"show_stats"      → Статистика
"mode_fast"       → Быстрый поиск
"mode_deep"       → Глубокое исследование
```

### С параметрами (через ||)
```python
"switch_chat||uuid-123"        → Переключиться на чат
"rename_chat||uuid-123"        → Переименовать чат
"delete_chat||uuid-123"        → Удалить чат
"send_report||path/to/file"    → Отправить отчёт
"choose_building||hotel"       → Выбрать тип заведения
```

---

## 🎨 Все эмодзи

### Навигация и структура
```
🏠 Главное меню      ⚙️ Системная       ❓ Помощь
📱 Чаты             📁 Хранилище       📄 Отчёты
« Назад             ⬅️ Назад
```

### Чаты и действия
```
📝 Активный чат     💬 Неактивный      🆕 Новый
✏️ Изменить         🗑️ Удалить        📊 Статистика
🔄 Переключить      ✨ Создан
```

### Режимы и типы
```
⚡ Быстрый поиск    🔬 Глубокое        🔍 Поиск в отчётах
ИНТЕРВЬЮ           ДИЗАЙН
```

### Статусы и обратная связь
```
✅ Да/Готово        ❌ Нет/Ошибка      ⚠️ Предупреждение
⏳ Загрузка         🎙️ Аудио          🤖 Бот  👤 Пользователь
```

### Анимация спиннера
```
⠋ ⠙ ⠹ ⠸ ⠼ ⠴ ⠦ ⠧ ⠇ ⠏  (циклически)
```

---

## 🔑 Состояние пользователя (user_states)

```python
user_states[chat_id] = {
    "conversation_id": "uuid-123",  # Текущий чат
    "step": "dialog_mode",          # Этап взаимодействия
    "deep_search": False,           # Режим поиска
    "mode": "interview",            # Сценарий (interview/design)
    "data": {                       # Собранные данные
        "audio_number": 42,
        "date": "2025-01-15",
        "employee": "Иванов И.И.",
        "place_name": "Отель Москва",
        "building_type": "Отель",
        "zone_name": "VIP",
        "city": "Москва"  # только для design
        # или "client": "Петров П.П."  # только для interview
    }
}
```

### Возможные значения `step`:
```
"dialog_mode"       → Готов к вопросам
"renaming_chat"     → Ожидание ввода нового названия
"edit_*"            → Редактирование поля (edit_date, edit_employee...)
"ask_*"             → Сбор данных (ask_employee, ask_place_name...)
"confirm_data"      → Подтверждение данных
"inputing_fields"   → Начало ввода полей
```

---

## 🚀 Частые сценарии

### Создать новый чат
```
Главное → Чаты → 🆕 Новый чат → [Режим] → Вопрос
```

### Переключиться на другой чат
```
Главное → Чаты → Клик на чат → ✅ Перейти → [История] → Вопрос
```

### Переименовать чат
```
Главное → Чаты → ✏️ Изменить → Ввод текста → [Меню чатов с новым названием]
```

### Удалить чат
```
Главное → Чаты → 🗑️ Удалить → 🗑️ Да, удалить → [Меню чатов без этого чата]
```

### Получить статистику
```
Главное → Чаты → 📊 Статистика → [Текст статистики + меню чатов]
```

### Посмотреть отчёты
```
Главное → Чаты → 📄 Мои отчеты → [Список] → Клик на отчёт → [Файл отправлен]
```

### Обработать аудио (Интервью)
```
Главное → Системная → Хранилище → ИНТЕРВЬЮ → [Отправить аудио] →
→ [Транскрипция] → [Расстановка ролей] → [Ввод полей] →
→ [Подтверждение] → [Выбор отчёта] → [Получение отчёта]
```

---

## 🧩 Структура файлов

```
src/
├── markups.py              # 16 функций генерации меню
│   ├── main_menu_markup()
│   ├── chats_menu_markup_dynamic()  ← Динамическая!
│   ├── make_dialog_markup()
│   ├── switch_chat_confirmation_markup()
│   └── ...
│
├── handlers.py             # Основной callback_query_handler
│   ├── @app.on_callback_query()
│   ├── handle_menu_chats()
│   ├── handle_show_stats()
│   ├── handle_mode_fast()
│   └── ...
│
├── menu_manager.py         # MenuManager класс
│   ├── send_menu_with_cleanup()    ← Главная функция!
│   ├── _remove_old_menu_buttons()
│   └── clear_menu_history()
│
├── conversation_handlers.py  # Обработчики мультичатов
│   ├── handle_new_chat()
│   ├── handle_switch_chat_confirm()
│   ├── handle_rename_chat_input()
│   └── handle_delete_chat_confirm()
│
└── constants.py            # Константы текстов
    ├── BUTTON_BACK
    ├── COMMAND_HISTORY
    └── ...
```

---

## 📐 Размеры и пропорции

### Кнопки чатов
```
Название:  50% (24 символа)  → "📝 1. Очень длинное на..."
Изменить:  25% (10 символов) → "✏️ Изменить"
Удалить:   25% (9 символов)  → "🗑️ Удалить"
```

### Превью текста
```
Вопрос в отчёте:  40 символов + "..."
Сообщение в истории: 100 символов + "..."
Название чата: динамическое обрезание
```

---

## 🧪 Как протестировать

### 1. Проверить удаление старого меню
```python
# Отправить меню 1
await send_menu(chat_id, app, "Меню 1", markup1)
# Отправить меню 2
await send_menu(chat_id, app, "Меню 2", markup2)

# Ожидание: Меню 1 полностью удалено, видно только Меню 2
```

### 2. Проверить очистку истории
```python
# Создать новый чат
await handle_new_chat(chat_id, app)

# Проверить: MenuManager._last_menu_ids[chat_id] не содержит старые ID
```

### 3. Проверить динамическую генерацию
```python
# Создать несколько чатов
conversation_manager.create_conversation(...)
conversation_manager.create_conversation(...)

# Открыть меню чатов
await handle_menu_chats(chat_id, app)

# Проверить: Активный чат имеет 📝, остальные 💬
# Проверить: Чаты отсортированы по updated_at DESC
```

---

## 💡 Подсказки для разработчиков

### ✅ DO:
```python
# Всегда используй send_menu() для отправки меню
await send_menu(chat_id, app, text, markup)

# Объединяй текст и меню в одно сообщение
text = f"Результат: {result}\n\nВыберите действие:"
await send_menu(chat_id, app, text, markup)

# Используй clear_menus() при смене контекста
clear_menus(chat_id)
await send_menu(...)
```

### ❌ DON'T:
```python
# НЕ отправляй меню напрямую через app.send_message
app.send_message(chat_id, text, reply_markup=markup)  # ❌

# НЕ отправляй несколько сообщений подряд
app.send_message(chat_id, "Результат")  # ❌
app.send_message(chat_id, "Меню", reply_markup=markup)  # ❌

# НЕ забывай удалять старые меню
# (send_menu делает это автоматически!)
```

---

## 📊 Метрики

```
Всего меню:              16 типов
Callback обработчиков:   ~30+
Строк кода UI:           ~2268
Эмодзи в использовании:  ~25+
Файлов с UI логикой:     5
Тестов:                  8 (MenuManager + handlers)
```

---

## 🔗 Ссылки на код

**Главные файлы:**
- `src/markups.py:7-294` - Все генераторы меню
- `src/handlers.py:1169-1288` - Callback query handler
- `src/menu_manager.py:21-136` - MenuManager класс
- `src/conversation_handlers.py` - Обработчики чатов
- `src/constants.py` - Константы текстов

**Тесты:**
- `src/test_menu_manager.py` - Юнит-тесты MenuManager

**Документация:**
- `INTERACTIVE_UI_REPORT.md` - Полный детальный отчёт (этот файл)
- `menu_analysis.md` - Анализ всех меню
- `MENU_FIX_GUIDE.md` - Руководство по рефакторингу

---

**Обновлено:** 4 октября 2025
