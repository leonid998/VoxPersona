# üå≥ Menu Graph Configuration

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥—Ä–∞—Ñ –º–µ–Ω—é VoxPersona**

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| **–£–∑–ª–æ–≤ (nodes)** | 104 |
| **–°–≤—è–∑–µ–π (edges)** | 123 |
| **–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö callback_data** | 101 |
| **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —É–∑–ª–æ–≤** | 11 |
| **FSM —É–∑–ª–æ–≤** | 25 |
| **–£—Å–ª–æ–≤–Ω—ã—Ö —Å–≤—è–∑–µ–π (super_admin)** | 62 |

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

### nodes

–£–∑–ª—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–æ–±–æ–π —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–Ω—é –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è:

```json
{
  "node_id": {
    "type": "menu|action|view",
    "depth": 0-7,
    "description": "–û–ø–∏—Å–∞–Ω–∏–µ —É–∑–ª–∞",
    "dynamic": true,  // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —É–∑–ª—ã
    "fsm": true       // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - FSM —É–∑–ª—ã
  }
}
```

**–¢–∏–ø—ã —É–∑–ª–æ–≤:**
- `menu` (22 —à—Ç) - –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–µ–Ω—é
- `action` (66 —à—Ç) - –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `view` (16 —à—Ç) - –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

**–ì–ª—É–±–∏–Ω–∞ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏:**
- Depth 0: 1 —É–∑–µ–ª (menu_main)
- Depth 1: 6 —É–∑–ª–æ–≤
- Depth 2: 14 —É–∑–ª–æ–≤
- Depth 3: 12 —É–∑–ª–æ–≤
- Depth 4: 36 —É–∑–ª–æ–≤
- Depth 5: 24 —É–∑–ª–∞
- Depth 6: 7 —É–∑–ª–æ–≤
- Depth 7: 4 —É–∑–ª–∞

### edges

–°–≤—è–∑–∏ –º–µ–∂–¥—É —É–∑–ª–∞–º–∏ (–ø–µ—Ä–µ—Ö–æ–¥—ã):

```json
{
  "from": "source_node",
  "to": "target_node",
  "callback_data": "callback_value",
  "button_text": "–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏",
  "condition": "user_role == super_admin"  // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
}
```

---

## üîê –£—Å–ª–æ–≤–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å

**62 —Å–≤—è–∑–∏** –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è `super_admin`:

- –í—Å–µ —É–∑–ª—ã –ø–æ–¥ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞" (`menu_access`)
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (`access_users_menu`)
- –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è (`access_invitations_menu`)
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (`access_security_menu`)

**–£—Å–ª–æ–≤–∏–µ:** `user_role == super_admin`

---

## üîó –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —É–∑–ª—ã

**11 —É–∑–ª–æ–≤** –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç:

| –£–∑–µ–ª | –û–ø–∏—Å–∞–Ω–∏–µ | Callback –ø–∞—Ç—Ç–µ—Ä–Ω |
|------|----------|------------------|
| `chat_actions` | –î–µ–π—Å—Ç–≤–∏—è —Å —á–∞—Ç–æ–º | `chat_actions||{conversation_id}` |
| `send_report` | –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ | `send_report||{report_id}` |
| `access_user_details` | –î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | `access_user_details||{user_id}` |
| `access_invite_details` | –î–µ—Ç–∞–ª–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è | `access_invite_details||{invite_code}` |
| `access_list_users||page` | –ü–∞–≥–∏–Ω–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | `access_list_users||page||{n}` |
| `access_list_invites||page` | –ü–∞–≥–∏–Ω–∞—Ü–∏—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π | `access_list_invites||page||{n}` |
| `view||audio` | –ü—Ä–æ—Å–º–æ—Ç—Ä –∞—É–¥–∏–æ | `view||audio` |
| `select||audio` | –í—ã–±–æ—Ä –∞—É–¥–∏–æ | `select||{filename}` |
| `delete||audio` | –£–¥–∞–ª–µ–Ω–∏–µ –∞—É–¥–∏–æ | `delete||{filename}` |
| `access_edit_user` | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | `access_edit_user||{user_id}` |
| `access_set_role` | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–æ–ª–∏ | `access_set_role||{user_id}||{role}` |
| `access_set_user_cleanup` | –û—á–∏—Å—Ç–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | `access_set_user_cleanup||{user_id}` |

---

## ü§ñ FSM —É–∑–ª—ã

**25 —É–∑–ª–æ–≤** —Ç—Ä–µ–±—É—é—Ç FSM (Finite State Machine) –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö:

### –û—Å–Ω–æ–≤–Ω—ã–µ FSM —É–∑–ª—ã:

| –£–∑–µ–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `new_chat` | –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ |
| `rename_chat` | –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —á–∞—Ç–∞ |
| `report_rename` | –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ |
| `upload||audio` | –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞ |

### Auth FSM —É–∑–ª—ã:

| –£–∑–µ–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `invite_password_input` | –í–≤–æ–¥ –ø–∞—Ä–æ–ª—è –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ |
| `invite_password_confirm` | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è |
| `change_password_current` | –í–≤–æ–¥ —Ç–µ–∫—É—â–µ–≥–æ –ø–∞—Ä–æ–ª—è |
| `change_password_new` | –í–≤–æ–¥ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è |
| `change_password_confirm` | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è |

### Access FSM —É–∑–ª—ã:

| –£–∑–µ–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `access_search_user` | –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `access_set_cleanup` | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏ |
| `access_create_invite_admin` | –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞ |
| `access_create_invite_user` | –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `access_set_invite_expiry` | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è |
| `access_set_cleanup_hours` | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ—á–∏—Å—Ç–∫–∏ |
| `access_set_user_cleanup` | –û—á–∏—Å—Ç–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `access_set_min_length` | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è |
| `access_set_password_ttl` | –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø–∞—Ä–æ–ª—è |

### Audio processing FSM —É–∑–ª—ã:

| –£–∑–µ–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `edit_audio_number` | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ |
| `edit_date` | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã |
| `edit_employee` | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–ò–û |
| `edit_place_name` | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è |
| `edit_city` | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ |
| `edit_zone_name` | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–æ–Ω—ã |
| `edit_client` | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ |

---

## üìå Entry Points

### –û—Å–Ω–æ–≤–Ω–æ–π entry point
- `menu_main` (depth 0) - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é, –¥–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ `/start`

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ entry points
- `confirm_menu` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ (–ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞)
- `invite_password_input` - –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è (–ø—Ä–∏ `/start {INVITE_CODE}`)
- `change_password_current` - –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è (–ø—Ä–∏ `/change_password`)

---

## üîç –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É–∑–ª—ã

**14 —É–∑–ª–æ–≤** –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∞ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ):

| –£–∑–µ–ª | –ü—Ä–∏—á–∏–Ω–∞ –∏–∑–æ–ª—è—Ü–∏–∏ |
|------|------------------|
| `confirm_menu` | Entry point –¥–ª—è –∞—É–¥–∏–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| `confirm_data` | –ü–æ–¥–º–µ–Ω—é –∞—É–¥–∏–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| `edit_data` | –ü–æ–¥–º–µ–Ω—é –∞—É–¥–∏–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| `edit_menu` | –ü–æ–¥–º–µ–Ω—é –∞—É–¥–∏–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| `building_type_menu` | –ü–æ–¥–º–µ–Ω—é –∞—É–¥–∏–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| `interview_menu` | –ü–æ–¥–º–µ–Ω—é –∞—É–¥–∏–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| `design_menu` | –ü–æ–¥–º–µ–Ω—é –∞—É–¥–∏–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| `choose_building||*` | –î–µ–π—Å—Ç–≤–∏—è –∞—É–¥–∏–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| `mode_fast`, `mode_deep` | –î–µ–π—Å—Ç–≤–∏—è –∞—É–¥–∏–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| `edit_building_type` | –î–µ–π—Å—Ç–≤–∏—è –∞—É–¥–∏–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| `edit_mode` | –î–µ–π—Å—Ç–≤–∏—è –∞—É–¥–∏–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| `back_to_confirm` | –î–µ–π—Å—Ç–≤–∏—è –∞—É–¥–∏–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ |

–≠—Ç–∏ —É–∑–ª—ã –≤—ã–∑—ã–≤–∞—é—Ç—Å—è **–æ—Ç–¥–µ–ª—å–Ω—ã–º workflow** –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤, –∞ –Ω–µ —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.

---

## üõ†Ô∏è –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### Python

```python
import json

# –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∞
with open('menu_graph.json', encoding='utf-8') as f:
    graph = json.load(f)

# –ü–æ–ª—É—á–µ–Ω–∏–µ —É–∑–ª–∞
node = graph['nodes']['menu_main']
print(f"Type: {node['type']}, Depth: {node['depth']}")

# –ü–æ–∏—Å–∫ —Å–≤—è–∑–µ–π –æ—Ç —É–∑–ª–∞
edges_from_main = [
    e for e in graph['edges']
    if e['from'] == 'menu_main'
]

for edge in edges_from_main:
    print(f"-> {edge['to']} ({edge['button_text']})")
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è callback_data

```python
def validate_callback(callback_data: str, graph: dict) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è callback_data –≤ –≥—Ä–∞—Ñ–µ"""
    # –û—á–∏—Å—Ç–∫–∞ –æ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    clean_callback = callback_data.split('||')[0]

    # –ü–æ–∏—Å–∫ –≤ edges
    for edge in graph['edges']:
        edge_clean = edge['callback_data'].split('||')[0]
        if edge_clean == clean_callback:
            return True

    return False
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É—Ç–∏ –∫ —É–∑–ª—É

```python
def find_path(graph: dict, target: str, start: str = 'menu_main') -> list:
    """BFS –ø–æ–∏—Å–∫ –ø—É—Ç–∏ –æ—Ç start –¥–æ target"""
    from collections import deque

    queue = deque([(start, [start])])
    visited = {start}

    while queue:
        node, path = queue.popleft()

        if node == target:
            return path

        for edge in graph['edges']:
            if edge['from'] == node and edge['to'] not in visited:
                visited.add(edge['to'])
                queue.append((edge['to'], path + [edge['to']]))

    return None  # –ü—É—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω (–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É–∑–µ–ª)
```

---

## üìù –ì–µ–Ω–µ—Ä–∞—Ü–∏—è

**–§–∞–π–ª —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**
- **–°–∫—Ä–∏–ø—Ç:** `menu_crawler/scripts/build_menu_graph_v3.py`
- **–ò—Å—Ç–æ—á–Ω–∏–∫:** `TASKS/00005_20251014_HRYHG/Implemt/menu_crawler/COMPLETE_MENU_TREE.md`
- **–î–∞—Ç–∞:** 22 –æ–∫—Ç—è–±—Ä—è 2025

**–î–ª—è —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:**

```bash
cd menu_crawler/scripts
python build_menu_graph_v3.py
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ (Definition of Done)

- ‚úÖ **101 callback_data** (–æ–∂–∏–¥–∞–ª–æ—Å—å 81+) - **–ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –Ω–∞ 24%**
- ‚úÖ –ì—Ä–∞—Ñ —Å–≤—è–∑–∞–Ω –æ—Ç `menu_main` (–∫—Ä–æ–º–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö entry points)
- ‚úÖ JSON —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –≤–∞–ª–∏–¥–µ–Ω
- ‚úÖ –í—Å–µ —É–∑–ª—ã —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω—ã (`menu`, `action`, `view`)
- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —É–∑–ª—ã –ø–æ–º–µ—á–µ–Ω—ã (`dynamic: true`)
- ‚úÖ FSM —É–∑–ª—ã –ø–æ–º–µ—á–µ–Ω—ã (`fsm: true`)
- ‚úÖ –£—Å–ª–æ–≤–Ω—ã–µ —É–∑–ª—ã (`super_admin`) –ø–æ–º–µ—á–µ–Ω—ã (`condition`)
- ‚úÖ –ì–ª—É–±–∏–Ω–∞ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ (0-7 —É—Ä–æ–≤–Ω–µ–π)

---

**–ö–æ–Ω–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**
