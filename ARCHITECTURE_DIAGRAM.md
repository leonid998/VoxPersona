# 🏗️ Архитектура решения: Умная отправка сообщений

## 📊 Общая схема работы

```
┌─────────────────────────────────────────────────────────────┐
│                      TELEGRAM BOT                            │
│                   (VoxPersona Project)                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     АНАЛИЗ ДАННЫХ                            │
│  - Транскрипция аудио (Whisper)                             │
│  - Анализ текста (Claude)                                   │
│  - Генерация отчетов                                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                 РЕЗУЛЬТАТ АНАЛИЗА (ТЕКСТ)                    │
│              Длина: N символов                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ smart_send_text()│
                    └─────────────────┘
                              │
                ┌─────────────┴─────────────┐
                │                           │
                ▼                           ▼
        ┌───────────────┐           ┌──────────────┐
        │  N ≤ 3000?    │           │  N > 3000?   │
        │  (короткий)   │           │  (длинный)   │
        └───────────────┘           └──────────────┘
                │                           │
                ▼                           ▼
    ┌───────────────────────┐   ┌──────────────────────────┐
    │   app.send_message()  │   │  Создать temp файл       │
    │                       │   │  app.send_document()     │
    │   Отправка в чат      │   │  Удалить temp файл       │
    └───────────────────────┘   └──────────────────────────┘
                │                           │
                └─────────────┬─────────────┘
                              ▼
                    ┌─────────────────┐
                    │  ПОЛЬЗОВАТЕЛЬ   │
                    │  получает:      │
                    │  - сообщение или│
                    │  - файл .md     │
                    └─────────────────┘
```

---

## 🔄 Детальная блок-схема smart_send_text()

```
START
  │
  ▼
┌──────────────────────┐
│ Получить параметры:  │
│ - text               │
│ - chat_id            │
│ - app (Client)       │
│ - threshold (3000)   │
│ - parse_mode         │
│ - file_format ("md") │
└──────────────────────┘
  │
  ▼
┌──────────────────────┐
│ Вычислить            │
│ text_length = len(text)│
└──────────────────────┘
  │
  ▼
┌──────────────────────┐
│ IF text_length       │
│    ≤ threshold?      │
└──────────────────────┘
  │
  ├─── ДА ──────────────────┐
  │                          │
  │                          ▼
  │              ┌───────────────────────┐
  │              │ app.send_message(     │
  │              │   chat_id,            │
  │              │   text,               │
  │              │   parse_mode          │
  │              │ )                     │
  │              └───────────────────────┘
  │                          │
  │                          ▼
  │              ┌───────────────────────┐
  │              │ Логирование:          │
  │              │ "Отправлено сообщение"│
  │              └───────────────────────┘
  │                          │
  │                          ▼
  │                        RETURN
  │
  └─── НЕТ ───────────────┐
                          │
                          ▼
              ┌───────────────────────┐
              │ Создать имя файла:    │
              │ report_YYYYMMDD_      │
              │ HHMMSS.{file_format}  │
              └───────────────────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │ tempfile.             │
              │ NamedTemporaryFile(   │
              │   mode='w',           │
              │   encoding='utf-8',   │
              │   suffix=extension,   │
              │   delete=False        │
              │ )                     │
              └───────────────────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │ Записать текст в файл │
              │ tmp_file.write(text)  │
              └───────────────────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │ TRY:                  │
              │   app.send_document(  │
              │     chat_id,          │
              │     document=tmp_path,│
              │     file_name,        │
              │     caption           │
              │   )                   │
              └───────────────────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │ Логирование:          │
              │ "Отправлен файл"      │
              └───────────────────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │ FINALLY:              │
              │   os.unlink(tmp_path) │
              │   (удалить temp файл) │
              └───────────────────────┘
                          │
                          ▼
                        RETURN
```

---

## 🔀 Схема интеграции с существующим кодом

```
ТЕКУЩАЯ АРХИТЕКТУРА:
┌─────────────────────────────────────────┐
│         run_analysis.py                 │
│                                         │
│  run_analysis_with_spinner()            │
│    │                                    │
│    ├─→ analyze_methodology()            │
│    │     └─→ Claude API                 │
│    │                                    │
│    └─→ split_and_send_long_text()       │
│          └─→ app.send_message() x N     │
└─────────────────────────────────────────┘

НОВАЯ АРХИТЕКТУРА:
┌─────────────────────────────────────────┐
│         run_analysis.py                 │
│                                         │
│  run_analysis_with_spinner()            │
│    │                                    │
│    ├─→ analyze_methodology()            │
│    │     └─→ Claude API                 │
│    │                                    │
│    └─→ smart_send_text()                │
│          │                              │
│          ├─→ короткий: send_message()   │
│          └─→ длинный: send_document()   │
└─────────────────────────────────────────┘
```

---

## 📁 Файловая структура

```
VoxPersona/
│
├── src/
│   ├── smart_send_implementation.py  ← НОВЫЙ МОДУЛЬ
│   │   ├── smart_send_text()
│   │   ├── smart_send_with_preview()
│   │   ├── smart_send_text_safe()
│   │   └── вспомогательные функции
│   │
│   ├── utils.py                      ← ОБНОВИТЬ
│   │   ├── split_and_send_long_text() (старый)
│   │   └── smart_send_text() (добавить или импортировать)
│   │
│   ├── run_analysis.py               ← ОБНОВИТЬ
│   │   ├── run_dialog_mode()
│   │   │   └── smart_send_text() (строка 142)
│   │   └── run_analysis_pass()
│   │       └── smart_send_text() (строка 188)
│   │
│   ├── config.py                     ← ОПЦИОНАЛЬНО
│   │   ├── LONG_TEXT_THRESHOLD = 3000
│   │   ├── PREVIEW_LINES = 20
│   │   └── REPORT_FILE_FORMAT = "md"
│   │
│   └── [другие файлы без изменений]
│
└── [документация - см. FILE_INDEX.md]
```

---

## 🔄 Поток данных

```
┌─────────────┐
│ Пользователь│
│ отправляет  │
│ аудио/текст │
└──────┬──────┘
       │
       ▼
┌──────────────────┐
│ Обработка входа  │
│ (handlers.py)    │
└──────┬───────────┘
       │
       ▼
┌─────────────────────┐
│ Транскрипция        │
│ (Whisper API)       │
│ → processed_texts[] │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│ Выбор типа отчета   │
│ (callback_query)    │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────────┐
│ Анализ текста           │
│ (Claude API)            │
│ analyze_methodology()   │
│ → audit_text            │
└──────┬──────────────────┘
       │
       ▼
┌─────────────────────────┐
│ ТОЧКА ИНТЕГРАЦИИ:       │
│                         │
│ БЫЛО:                   │
│ split_and_send_long_text│
│                         │
│ СТАЛО:                  │
│ smart_send_text()       │
└──────┬──────────────────┘
       │
       ├─── N ≤ 3000 ────┐
       │                  │
       │                  ▼
       │         ┌────────────────┐
       │         │ send_message() │
       │         │ (Telegram API) │
       │         └────────────────┘
       │
       └─── N > 3000 ────┐
                         │
                         ▼
                ┌─────────────────────┐
                │ Создать temp файл   │
                │ send_document()     │
                │ (Telegram API)      │
                │ Удалить temp файл   │
                └─────────────────────┘
                         │
                         ▼
                 ┌───────────────┐
                 │ Пользователь  │
                 │ получает      │
                 │ результат     │
                 └───────────────┘
```

---

## 🛠️ Компоненты системы

### 1. Основной модуль (smart_send_implementation.py)

```
┌─────────────────────────────────────────┐
│     smart_send_implementation.py        │
├─────────────────────────────────────────┤
│                                         │
│  smart_send_text()                      │
│  ├─ Параметры:                          │
│  │  - text: str                         │
│  │  - chat_id: int                      │
│  │  - app: Client                       │
│  │  - threshold: int = 3000             │
│  │  - parse_mode: Optional              │
│  │  - file_format: str = "md"           │
│  └─ Возврат: None                       │
│                                         │
│  smart_send_with_preview()              │
│  ├─ Дополнительно:                      │
│  │  - preview_lines: int = 20           │
│  └─ Логика: превью + файл               │
│                                         │
│  smart_send_text_safe()                 │
│  ├─ Fallback механизм                   │
│  └─ Возврат: bool (успех/неудача)       │
│                                         │
│  Вспомогательные:                       │
│  ├─ check_file_size_limit()             │
│  └─ estimate_send_method()              │
└─────────────────────────────────────────┘
```

### 2. Интеграция с Telegram API

```
┌─────────────────────────────────────────┐
│           Pyrogram Client               │
├─────────────────────────────────────────┤
│                                         │
│  app.send_message()                     │
│  ├─ Для коротких текстов (≤ threshold)  │
│  ├─ Параметры:                          │
│  │  - chat_id                           │
│  │  - text                              │
│  │  - parse_mode (Markdown/HTML)        │
│  └─ Лимит: 4096 символов                │
│                                         │
│  app.send_document()                    │
│  ├─ Для длинных текстов (> threshold)   │
│  ├─ Параметры:                          │
│  │  - chat_id                           │
│  │  - document (путь к файлу)           │
│  │  - file_name                         │
│  │  - caption (до 1024 символов)        │
│  └─ Лимит: 50 MB                        │
└─────────────────────────────────────────┘
```

### 3. Временные файлы (tempfile)

```
┌─────────────────────────────────────────┐
│     Управление временными файлами       │
├─────────────────────────────────────────┤
│                                         │
│  tempfile.NamedTemporaryFile()          │
│  ├─ mode='w'         (запись)           │
│  ├─ encoding='utf-8' (кодировка)        │
│  ├─ suffix='.md'     (расширение)       │
│  ├─ delete=False     (ручное удаление)  │
│  └─ Путь: /tmp/tmpXXXXXX.md             │
│                                         │
│  Жизненный цикл:                        │
│  1. Создание   → with открытие          │
│  2. Запись     → write(text)            │
│  3. Отправка   → send_document()        │
│  4. Удаление   → os.unlink()            │
│                                         │
│  Безопасность:                          │
│  ✓ Уникальное имя                       │
│  ✓ Автоматические права доступа         │
│  ✓ Гарантированное удаление (finally)   │
└─────────────────────────────────────────┘
```

---

## 🔐 Безопасность и обработка ошибок

```
┌─────────────────────────────────────────────┐
│         Многоуровневая защита               │
├─────────────────────────────────────────────┤
│                                             │
│  Уровень 1: Проверка входных данных         │
│  ├─ Проверка типа text (str)                │
│  ├─ Проверка длины (не превышает лимит)     │
│  └─ Проверка валидности chat_id             │
│                                             │
│  Уровень 2: Безопасная работа с файлами     │
│  ├─ tempfile.NamedTemporaryFile()           │
│  ├─ UTF-8 кодировка                         │
│  └─ Автоматические права доступа            │
│                                             │
│  Уровень 3: Обработка исключений            │
│  ├─ try-except для send_document()          │
│  ├─ finally для удаления файла              │
│  └─ Логирование всех ошибок                 │
│                                             │
│  Уровень 4: Fallback механизм               │
│  ├─ smart_send_text_safe()                  │
│  ├─ Откат к split_and_send_long_text()      │
│  └─ Уведомление пользователя об ошибке      │
│                                             │
│  Уровень 5: Мониторинг                      │
│  ├─ Логирование каждой операции             │
│  ├─ Счетчики успешных/неуспешных отправок   │
│  └─ Алерты при критических ошибках          │
└─────────────────────────────────────────────┘
```

---

## ⚙️ Конфигурация

```
┌─────────────────────────────────────────┐
│       Настройка системы                 │
├─────────────────────────────────────────┤
│                                         │
│  .env (переменные окружения)            │
│  ├─ LONG_TEXT_THRESHOLD=3000            │
│  ├─ PREVIEW_LINES=20                    │
│  ├─ REPORT_FILE_FORMAT=md               │
│  └─ MAX_FILE_SIZE_MB=50                 │
│                                         │
│         ↓ загрузка                      │
│                                         │
│  config.py (константы)                  │
│  ├─ LONG_TEXT_THRESHOLD: int            │
│  ├─ PREVIEW_LINES: int                  │
│  ├─ REPORT_FILE_FORMAT: str             │
│  └─ MAX_FILE_SIZE_MB: int               │
│                                         │
│         ↓ использование                 │
│                                         │
│  run_analysis.py (код)                  │
│  └─ smart_send_text(                    │
│       ...,                              │
│       threshold=LONG_TEXT_THRESHOLD,    │
│       file_format=REPORT_FILE_FORMAT    │
│     )                                   │
└─────────────────────────────────────────┘
```

---

## 📊 Метрики и мониторинг

```
┌─────────────────────────────────────────────┐
│         Система мониторинга                 │
├─────────────────────────────────────────────┤
│                                             │
│  Логирование:                               │
│  ├─ INFO: Успешные отправки                 │
│  │   "Отправлен файл report_*.md (5000 sym)"│
│  ├─ WARNING: Неудачное удаление temp файлов │
│  └─ ERROR: Ошибки отправки                  │
│                                             │
│  Метрики (опционально):                     │
│  ├─ Счетчик: messages_sent_total            │
│  ├─ Счетчик: files_sent_total               │
│  ├─ Гистограмма: message_size_bytes         │
│  ├─ Гистограмма: send_duration_seconds      │
│  └─ Gauge: temp_files_count                 │
│                                             │
│  Алерты:                                    │
│  ├─ Критический: Не удалось отправить       │
│  ├─ Предупреждение: Много temp файлов       │
│  └─ Информация: Превышен threshold          │
└─────────────────────────────────────────────┘
```

---

## 🔄 Альтернативные сценарии

### Сценарий 1: Отправка с превью

```
START
  │
  ▼
┌───────────────────────┐
│ smart_send_with_preview│
│ (text, chat_id, ...)  │
└───────────────────────┘
  │
  ├─── N ≤ threshold ───→ send_message() → END
  │
  └─── N > threshold ───┐
                        │
                        ▼
              ┌─────────────────────┐
              │ Извлечь первые      │
              │ preview_lines строк │
              └─────────────────────┘
                        │
                        ▼
              ┌─────────────────────┐
              │ Отправить превью    │
              │ send_message()      │
              └─────────────────────┘
                        │
                        ▼
              ┌─────────────────────┐
              │ Создать полный файл │
              │ send_document()     │
              └─────────────────────┘
                        │
                        ▼
                       END
```

### Сценарий 2: Fallback при ошибке

```
START
  │
  ▼
┌───────────────────────┐
│ smart_send_text_safe  │
└───────────────────────┘
  │
  ▼
┌───────────────────────┐
│ TRY:                  │
│   smart_send_text()   │
└───────────────────────┘
  │
  ├─── SUCCESS ──→ return True → END
  │
  └─── ERROR ────┐
                 │
                 ▼
       ┌──────────────────────┐
       │ FALLBACK:            │
       │ split_and_send_long_ │
       │ text()               │
       └──────────────────────┘
                 │
                 ├─── SUCCESS ──→ return True → END
                 │
                 └─── ERROR ────┐
                                │
                                ▼
                      ┌─────────────────────┐
                      │ send_message(       │
                      │   "❌ Ошибка..."    │
                      │ )                   │
                      └─────────────────────┘
                                │
                                ▼
                          return False → END
```

---

## 📈 Производительность

### Сравнение методов

```
СТАРЫЙ МЕТОД (split_and_send_long_text):
┌────────────────────────────────────────┐
│ Текст 10,000 символов                  │
│                                        │
│ → Разбивка на 3 сообщения              │
│ → 3 x send_message() API вызова        │
│ → Время: ~0.9 сек (3 x 0.3 сек)        │
│ → Трафик: 10KB + overhead x 3          │
└────────────────────────────────────────┘

НОВЫЙ МЕТОД (smart_send_text):
┌────────────────────────────────────────┐
│ Текст 10,000 символов                  │
│                                        │
│ → Создание temp файла                  │
│ → 1 x send_document() API вызов        │
│ → Время: ~0.4 сек (1 вызов)            │
│ → Трафик: 10KB + overhead x 1          │
│ → Удаление temp файла                  │
└────────────────────────────────────────┘

ВЫИГРЫШ:
✓ Скорость: ~55% быстрее
✓ API вызовы: 66% меньше
✓ Удобство: 100% лучше (один файл)
```

---

## 🎯 Итоговая архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                     ПОЛЬЗОВАТЕЛЬ                            │
│              (получает сообщение или файл)                  │
└─────────────────────────────────────────────────────────────┘
                              ▲
                              │
                ┌─────────────┴────────────┐
                │                          │
        ┌───────────────┐          ┌──────────────┐
        │ send_message()│          │send_document()│
        │  (короткий)   │          │  (длинный)   │
        └───────────────┘          └──────────────┘
                │                          │
                └─────────────┬────────────┘
                              │
                    ┌─────────────────┐
                    │smart_send_text()│
                    │  (умный выбор)  │
                    └─────────────────┘
                              ▲
                              │
        ┌─────────────────────┴─────────────────────┐
        │                                           │
┌───────────────┐                          ┌────────────────┐
│run_dialog_mode│                          │run_analysis_   │
│  (диалоги)    │                          │  pass (отчеты) │
└───────────────┘                          └────────────────┘
        │                                           │
        └─────────────────────┬─────────────────────┘
                              │
                    ┌─────────────────┐
                    │  АНАЛИЗ ДАННЫХ  │
                    │  (Claude API)   │
                    └─────────────────┘
                              ▲
                              │
                    ┌─────────────────┐
                    │   ТРАНСКРИПЦИЯ  │
                    │   (Whisper API) │
                    └─────────────────┘
                              ▲
                              │
                    ┌─────────────────┐
                    │  АУДИО/ТЕКСТ    │
                    │  (пользователь) │
                    └─────────────────┘
```

---

**Создано:** 02.10.2025
**Версия:** 1.0
**Статус:** Готово к использованию
