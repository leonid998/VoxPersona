# üìä –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï MENU CRAWLER - –ü–û–î–†–û–ë–ù–´–ô –û–¢–ß–ï–¢

**–°—Ç–∞—Ç—É—Å**: –ó–∞–≤–µ—Ä—à–µ–Ω–æ VERY THOROUGH –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
**–î–∞—Ç–∞**: 4 –Ω–æ—è–±—Ä—è 2025
**–£—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏**: –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô

---

## ‚ö†Ô∏è –ö–õ–Æ–ß–ï–í–û–ï –£–¢–û–ß–ù–ï–ù–ò–ï

**Menu Crawler - —ç—Ç–æ –ù–ï –ø–∞—Ä—Å–µ—Ä –º–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤!**

VoxPersona - —ç—Ç–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è **–∞–Ω–∞–ª–∏–∑–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π** (AUDIO ANALYSIS), –∞ Menu Crawler - —ç—Ç–æ **–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è UI-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ Telegram –±–æ—Ç–∞**.

---

## üìÅ 1. –°–¢–†–£–ö–¢–£–†–ê MENU CRAWLER

### –û—Å–Ω–æ–≤–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
```
C:\Users\l0934\Projects\VoxPersona\menu_crawler/
‚îú‚îÄ‚îÄ config/                          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è crawler
‚îÇ   ‚îú‚îÄ‚îÄ crawler_config.json          # Whitelist/blacklist –¥–µ–π—Å—Ç–≤–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ menu_graph.json              # –û–∂–∏–¥–∞–µ–º—ã–π –≥—Ä–∞—Ñ –º–µ–Ω—é (104 nodes, 123 edges)
‚îÇ   ‚îî‚îÄ‚îÄ README.md                    # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞
‚îú‚îÄ‚îÄ src/                             # –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
‚îÇ   ‚îú‚îÄ‚îÄ main.py                      # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (–æ—Ä–∫–µ—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤–µ—Å—å —Ü–∏–∫–ª)
‚îÇ   ‚îú‚îÄ‚îÄ navigator.py                 # BFS –æ–±—Ö–æ–¥ –º–µ–Ω—é + Pyrogram –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ coverage_verifier.py         # –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–∫—Ä—ã—Ç–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ report_builder.py            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JSON/Markdown –æ—Ç—á–µ—Ç–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ utils/                       # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏
‚îÇ       ‚îú‚îÄ‚îÄ checkpoint_manager.py    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
‚îÇ       ‚îú‚îÄ‚îÄ circuit_breaker.py       # Circuit breaker –ø–∞—Ç—Ç–µ—Ä–Ω
‚îÇ       ‚îú‚îÄ‚îÄ cleanup.py               # Cleanup —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚îÇ       ‚îú‚îÄ‚îÄ fsm_handler.py           # FSM –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö
‚îÇ       ‚îú‚îÄ‚îÄ logging_config.py        # Structured logging (structlog)
‚îÇ       ‚îî‚îÄ‚îÄ cleanup_old.py           # –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è cleanup
‚îú‚îÄ‚îÄ scripts/                         # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ build_menu_graph_v3.py       # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è menu_graph.json –∏–∑ markdown
‚îÇ   ‚îú‚îÄ‚îÄ create_user_session.py       # –°–æ–∑–¥–∞–Ω–∏–µ Pyrogram —Å–µ—Å—Å–∏–∏ (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ)
‚îÇ   ‚îú‚îÄ‚îÄ create_user_session_with_code.py  # –° –≤–≤–æ–¥–æ–º –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ create_session_stdin.py      # STDIN –≤–µ—Ä—Å–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ generate_test_data.py        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ set_test_user_super_admin.py # –í—ã–¥–∞—á–∞ –∞–¥–º–∏–Ω—Å–∫–∏—Ö –ø—Ä–∞–≤ —Ç–µ—Å—Ç–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
‚îÇ   ‚îú‚îÄ‚îÄ parse_menu_tree.py           # –ü–∞—Ä—Å–∏–Ω–≥ –º–µ–Ω—é-–¥–µ—Ä–µ–≤–∞
‚îÇ   ‚îî‚îÄ‚îÄ build_menu_graph_v2.py       # –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è
‚îú‚îÄ‚îÄ LAUNCH_INSTRUCTIONS.md           # –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞
‚îî‚îÄ‚îÄ TASK_COMPLETION_REPORT.md        # –û—Ç—á–µ—Ç –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏
```

### –ö–æ—Ä–Ω–µ–≤–æ–π —Ñ–∞–π–ª
```
C:\Users\l0934\Projects\VoxPersona\menu_crawler.py   # –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è (standalone)
```

---

## üéØ 2. –ß–¢–û –î–ï–õ–ê–ï–¢ MENU CRAWLER?

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
Menu Crawler - —ç—Ç–æ **–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç–µ—Ä –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ UI** –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π:

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Pyrogram –∫–ª–∏–µ–Ω—Ç** (user-account –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
2. **–ó–∞–ø—É—Å–∫–∞–µ—Ç BFS –æ–±—Ö–æ–¥** –≤—Å–µ—Ö –º–µ–Ω—é –∏ –∫–Ω–æ–ø–æ–∫ –±–æ—Ç–∞
3. **–°–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏**: –ø–æ—Å–µ—â–µ–Ω–Ω—ã–µ —É–∑–ª—ã, –æ—à–∏–±–∫–∏, –≥–ª—É–±–∏–Ω—É –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏
4. **–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç—ã**: JSON + Markdown —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
5. **–û—á–∏—â–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ** –∏–∑ –ë–î –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –û—Å–Ω–æ–≤–Ω–æ–π workflow
```
1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (load config + init Pyrogram)
    ‚Üì
2. BFS –æ–±—Ö–æ–¥ –º–µ–Ω—é (—Å throttling + circuit breaker)
    ‚Üì
3. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–∫—Ä—ã—Ç–∏—è (expected vs actual)
    ‚Üì
4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤ (JSON + Markdown)
    ‚Üì
5. Cleanup —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î
```

---

## üîë 3. –ö–õ–Æ–ß–ï–í–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´ –ò –ö–õ–ê–°–°–´

### 3.1 MenuNavigator (navigator.py)
**–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –¥–ª—è –æ–±—Ö–æ–¥–∞ –º–µ–Ω—é**

```python
class MenuNavigator:
    """BFS –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä –ø–æ –º–µ–Ω—é –±–æ—Ç–∞"""
    
    def __init__(self, config_path: Path):
        # –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –≥—Ä–∞—Ñ
        self.config = self._load_config()          # safe_navigation, forbidden_actions
        self.expected_graph = self._load_menu_graph()  # 104 nodes, 123 edges
        self.client = Client(...)                  # Pyrogram –∫–ª–∏–µ–Ω—Ç
        
    async def init_crawler(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Pyrogram –∫–ª–∏–µ–Ω—Ç–∞"""
        
    async def crawl(self):
        """–ó–∞–ø—É—Å–∫ BFS –æ–±—Ö–æ–¥–∞ –≤—Å–µ–≥–æ –º–µ–Ω—é"""
        
    async def _send_callback(self, callback_data: str) -> Message:
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å callback_query –±–æ—Ç—É"""
        
    def _is_safe_navigation(self, callback_data: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å whitelist/blacklist"""
```

**–ö–ª—é—á–µ–≤—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã:**
- `config`: Whitelist (safe_navigation) + Blacklist (forbidden_actions)
- `expected_graph`: –û–∂–∏–¥–∞–µ–º—ã–π –≥—Ä–∞—Ñ –∏–∑ menu_graph.json
- `visited_edges`: –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ—Å–µ—â–µ–Ω–Ω—ã—Ö —Ä–µ–±–µ—Ä (from, to)
- `actual_graph`: –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≥—Ä–∞—Ñ, —Å–æ–±—Ä–∞–Ω–Ω—ã–π –≤–æ –≤—Ä–µ–º—è –æ–±—Ö–æ–¥–∞
- `current_message`: –ê–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞ (–¥–ª—è message_id)
- `current_node`: –¢–µ–∫—É—â–∏–π —É–∑–µ–ª –≤ –≥—Ä–∞—Ñ–µ

### 3.2 CoverageVerifier (coverage_verifier.py)
**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é**

```python
class CoverageVerifier:
    """–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–∫—Ä—ã—Ç–∏—è –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –≥—Ä–∞—Ñ–∞"""
    
    def verify(self, expected_graph, actual_graph) -> Dict:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        {
            "status": "PASS" | "FAIL",
            "coverage_percent": 100.0,
            "total_expected": 104,
            "total_visited": 104,
            "missing_nodes": [],
            "unreachable_nodes": [],
            "max_depth": 7,
            "deep_nodes": [],  # Nodes –≥–ª—É–±–∂–µ 4 –∫–ª–∏–∫–æ–≤
            "nodes_without_back_button": []
        }
        """
```

### 3.3 ReportBuilder (report_builder.py)
**–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤**

```python
class ReportBuilder:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è JSON + Markdown –æ—Ç—á–µ—Ç–æ–≤"""
    
    def build_json(self) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON –æ—Ç—á–µ—Ç —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏"""
        
    def build_markdown(self) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Markdown –æ—Ç—á–µ—Ç –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞"""
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç—á–µ—Ç–∞:**
```json
{
  "timestamp": "2025-10-22T16:30:00",
  "session_id": "test_20251022_163000",
  "status": "PASS",
  "coverage": {
    "total_expected": 104,
    "total_visited": 104,
    "coverage_percent": 100.0
  },
  "issues": {
    "critical": [],
    "warnings": [],
    "info": []
  },
  "ux_metrics": {
    "max_depth": 4,
    "deep_nodes_count": 0,
    "nodes_without_back_count": 2
  }
}
```

### 3.4 CheckpointManager (utils/checkpoint_manager.py)
**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –æ–±—Ö–æ–¥–∞**

```python
class CheckpointManager:
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞"""
    
    def save_checkpoint(self, visited_edges, queue):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ progress.json"""
        
    def load_checkpoint(self):
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–∑ progress.json (–¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ—è)"""
```

**–§–∞–π–ª checkpoint:**
```json
{
  "timestamp": "2025-10-22T16:25:00",
  "visited_edges": [
    ["menu_main", "menu_chats"],
    ["menu_chats", "chat_actions"]
  ],
  "queue": [
    ["menu_main", "menu_system"]
  ]
}
```

### 3.5 CircuitBreaker (utils/circuit_breaker.py)
**–ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç rate limiting**

```python
class CircuitBreaker:
    """–ó–∞—â–∏—Ç–∞ –æ—Ç Telegram rate limits"""
    
    async def call(self, callback_data: str):
        """
        –õ–æ–≥–∏–∫–∞:
        - CLOSED: –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        - OPEN: —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ ‚Üí –∂–¥–µ–º –ø–∞—É–∑—É
        - HALF_OPEN: –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
        """
```

### 3.6 Utils

#### logging_config.py
```python
setup_logging()  # Structured logging —Å structlog (JSON format)
get_logger(name)  # –ü–æ–ª—É—á–∏—Ç—å logger
```

#### cleanup.py
```python
async def cleanup_test_files(user_id: int, test_files: List[str]):
    """–£–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∏–∑ –ë–î"""
    
async def cleanup_test_data(user_id: int):
    """–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
```

#### fsm_handler.py
```python
class FSMHandler:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ FSM —É–∑–ª–æ–≤ (–≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö)"""
    
    async def handle_fsm_node(self, fsm_name: str, inputs: Dict):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ FSM"""
```

---

## üìä 4. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### crawler_config.json
```json
{
  "safe_navigation": [
    "menu_",        // –í—Å–µ —É–∑–ª—ã –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å "menu_"
    "chat_actions",
    "send_report",
    "view||",
    "select||",
    "delete||",
    "access_"       // –í—Å–µ —É–∑–ª—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
  ],
  "forbidden_actions": [
    "delete||all",
    "reset_database",
    "dangerous_action"
  ],
  "throttle_delay": 2.0,      // 2 —Å–µ–∫ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
  "callback_timeout": 10       // 10 —Å–µ–∫ timeout –Ω–∞ callback
}
```

**–õ–æ–≥–∏–∫–∞:**
1. ‚úÖ –ï—Å–ª–∏ callback –≤ `safe_navigation` ‚Üí —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
2. ‚ùå –ï—Å–ª–∏ callback –≤ `forbidden_actions` ‚Üí –∑–∞–ø—Ä–µ—â–µ–Ω–æ
3. ‚úÖ –ï—Å–ª–∏ callback –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞ –∏–∑ safe ‚Üí —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
4. ‚ùå –ò–Ω–∞—á–µ ‚Üí –∑–∞–ø—Ä–µ—â–µ–Ω–æ (–æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–π –ø–æ–¥—Ö–æ–¥)

### menu_graph.json
```json
{
  "nodes": {
    "menu_main": {
      "type": "menu",
      "depth": 0,
      "description": "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
    },
    "chat_actions||123": {
      "type": "action",
      "depth": 4,
      "dynamic": true,
      "description": "–î–µ–π—Å—Ç–≤–∏—è —Å —á–∞—Ç–æ–º"
    }
  },
  "edges": [
    {
      "from": "menu_main",
      "to": "menu_chats",
      "callback_data": "menu_chats",
      "button_text": "üí¨ –ß–∞—Ç—ã",
      "condition": null  // null –∏–ª–∏ "user_role == super_admin"
    }
  ]
}
```

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—Ä–∞—Ñ–∞:**
- **Nodes**: 104 (22 menu, 66 action, 16 view)
- **Edges**: 123
- **Depth**: 0-7 —É—Ä–æ–≤–Ω–µ–π
- **Dynamic nodes**: 11 (—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ç–∏–ø–∞ `||{id}`)
- **FSM nodes**: 25 (—Ç—Ä–µ–±—É—é—Ç –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö)
- **Conditional edges**: 62 (—Ç–æ–ª—å–∫–æ –¥–ª—è super_admin)

---

## üîó 5. –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° BOT –ò –ë–î

### 5.1 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram –±–æ—Ç–æ–º

**–¢–æ—á–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:**
```python
# –í —Ñ–∞–π–ª–µ: src/bot.py
app = Client("session_name")  # Pyrogram –∫–ª–∏–µ–Ω—Ç –¥–ª—è –±–æ—Ç–∞

# –í —Ñ–∞–π–ª–µ: src/handlers.py, src/handlers_my_reports_v2.py
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback_query –∏ message

# Menu Crawler –∏—Å–ø–æ–ª—å–∑—É–µ—Ç user-–∞–∫–∫–∞—É–Ω—Ç (–Ω–µ –±–æ—Ç–∞!)
# –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
client = Client("menu_crawler_session", ...)  # User session!
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. Menu Crawler - —ç—Ç–æ user-–∞–∫–∫–∞—É–Ω—Ç (—ç–º—É–ª–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç callback_query –±–æ—Ç—É (–∫–∞–∫ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏)
3. –ë–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤ handlers.py —á–µ—Ä–µ–∑ callbacks
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –º–µ–Ω—é –æ–±—Ä–∞—Ç–Ω–æ

### 5.2 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

**–¢–∞–±–ª–∏—Ü—ã (–∏–∑ db_handler/db.py):**
```sql
-- –ë–∞–∑–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã
CREATE TABLE client (
    client_id SERIAL PRIMARY KEY,
    client_name VARCHAR
);

CREATE TABLE employee (
    employee_id SERIAL PRIMARY KEY,
    employee_name VARCHAR
);

CREATE TABLE zone (
    zone_id SERIAL PRIMARY KEY,
    zone_name VARCHAR
);

CREATE TABLE place (
    place_id SERIAL PRIMARY KEY,
    place_name VARCHAR,
    building_type VARCHAR  -- 'hotel', 'spa', 'restaurant', 'non-building'
);

CREATE TABLE place_zone (
    place_id INT REFERENCES place,
    zone_id INT REFERENCES zone
);

-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –∞—É–¥–∏–æ–¥–∞–Ω–Ω—ã—Ö
CREATE TABLE transcription (
    id SERIAL PRIMARY KEY,
    user_telegram_id BIGINT,  -- TEST_USER_ID –¥–ª—è —Ç–µ—Å—Ç–æ–≤
    audio_file_path VARCHAR,
    transcription_text TEXT,
    analysis_results TEXT,
    created_at TIMESTAMP,
    mode VARCHAR  -- 'design' –∏–ª–∏ 'interview'
);

-- –¢–∞–±–ª–∏—Ü–∞ –æ—Ç—á–µ—Ç–æ–≤
CREATE TABLE reports (
    report_id SERIAL PRIMARY KEY,
    user_telegram_id BIGINT,
    report_type VARCHAR,
    content TEXT,
    created_at TIMESTAMP
);
```

**Cleanup –ª–æ–≥–∏–∫–∞ (utils/cleanup.py):**
```python
# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≥–¥–µ user_telegram_id = TEST_USER_ID
DELETE FROM transcription WHERE user_telegram_id = 155894817;
DELETE FROM reports WHERE user_telegram_id = 155894817;
DELETE FROM place WHERE place_id NOT IN (
    SELECT DISTINCT place_id FROM transcription
);
```

---

## üöÄ 6. WORKFLOW –ó–ê–ü–£–°–ö–ê

### –õ–æ–∫–∞–ª—å–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞

```bash
# 1. –°–æ–∑–¥–∞—Ç—å Pyrogram user session
python menu_crawler/scripts/create_user_session.py
# ‚Üí –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
# ‚Üí –°–æ–∑–¥–∞–µ—Ç: C:\Users\l0934\Projects\VoxPersona\menu_crawler\menu_crawler_session.session

# 2. –ó–∞–≥—Ä—É–∑–∏—Ç—å session –Ω–∞ —Å–µ—Ä–≤–µ—Ä
scp menu_crawler/menu_crawler_session.session root@172.237.73.207:/home/voxpersona_user/VoxPersona/menu_crawler/

# 3. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ TEST_USER_ID –≤ .env —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å Telegram ID –∏–∑ session
grep TEST_USER_ID .env
# TEST_USER_ID=155894817
```

### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ

```bash
# 1. –ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ–µ–∫—Ç
cd /home/voxpersona_user/VoxPersona

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å Menu Crawler
python3 -m menu_crawler.src.main

# –ò–õ–ò
cd menu_crawler/src
python3 navigator.py
```

### –í—ã—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã

```
menu_crawler/
‚îú‚îÄ‚îÄ progress.json                    # Checkpoint (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 10 —É–∑–ª–æ–≤)
‚îú‚îÄ‚îÄ reports/
‚îÇ   ‚îî‚îÄ‚îÄ report_20251022_163000.json  # JSON –æ—Ç—á–µ—Ç
‚îÇ   ‚îî‚îÄ‚îÄ report_20251022_163000.md    # Markdown –æ—Ç—á–µ—Ç
‚îî‚îÄ‚îÄ actual_callbacks_analysis.json   # –ê–Ω–∞–ª–∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö callback_data
```

---

## üéØ 7. –ö–õ–Æ–ß–ï–í–´–ï –ú–ï–¢–†–ò–ö–ò –ò –ü–û–ö–ê–ó–ê–¢–ï–õ–ò

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—Ä–∞—Ñ–∞ (–∏–∑ menu_graph.json)

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –í—Å–µ–≥–æ —É–∑–ª–æ–≤ | 104 |
| –í—Å–µ–≥–æ —Å–≤—è–∑–µ–π | 123 |
| –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö callback_data | 101 |
| –¢–∏–ø—ã —É–∑–ª–æ–≤ | menu (22), action (66), view (16) |
| –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ | 7 —É—Ä–æ–≤–Ω–µ–π |
| –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —É–∑–ª–æ–≤ | 11 |
| FSM —É–∑–ª–æ–≤ | 25 |
| –£—Å–ª–æ–≤–Ω—ã—Ö —Å–≤—è–∑–µ–π (super_admin) | 62 |

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∫—Ä—ã—Ç–∏—è

```
Coverage: 100.0%
  - Total expected: 104 nodes
  - Total visited: 104 nodes
  
UX Metrics:
  - Max depth: 4 clicks
  - Deep nodes (>4): 0
  - Nodes without back button: 2
```

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

```
Safe navigation actions: 21
  - menu_* (–≤—Å–µ –º–µ–Ω—é)
  - chat_actions
  - send_report
  - access_* (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—Å–∫–æ–µ)
  - view||* (–ø—Ä–æ—Å–º–æ—Ç—Ä)
  - select||* (–≤—ã–±–æ—Ä)
  - delete||* (—É–¥–∞–ª–µ–Ω–∏–µ)

Forbidden actions: 22
  - delete||all_reports
  - reset_database
  - dangerous_admin_action
  - –∏ –¥—Ä.
```

---

## üîÑ 8. INTEGRATION POINTS (–¢–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)

### –° –æ—Å–Ω–æ–≤–Ω—ã–º –±–æ—Ç–æ–º (src/)

```
Menu Crawler ‚Üí Pyrogram Client (user session)
            ‚Üí Telegram Bot API
            ‚Üì
src/bot.py (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–æ—Ç–∞)
src/handlers.py (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback_query)
src/markups.py (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–Ω–æ–ø–∫–∏)
src/menus.py (–ª–æ–≥–∏–∫–∞ –º–µ–Ω—é)
src/message_tracker.py (–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è)
            ‚Üì
src/db_handler/db.py (—Ä–∞–±–æ—Ç–∞ —Å –ë–î)
```

### –° –¥–∞–Ω–Ω—ã–º–∏

```
Menu Crawler (test user)
        ‚Üì
PostgreSQL (bot_db)
        ‚Üì
–¢–∞–±–ª–∏—Ü—ã:
- transcription (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞—É–¥–∏–æ)
- reports (–æ—Ç—á–µ—Ç—ã)
- place, zone, employee, client (—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏)
        ‚Üì
Cleanup: —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –≥–¥–µ user_telegram_id = TEST_USER_ID
```

### –° —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π

```
Menu Crawler
        ‚Üì
menu_crawler/config/
  ‚îú‚îÄ‚îÄ menu_graph.json (–æ–∂–∏–¥–∞–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
  ‚îî‚îÄ‚îÄ crawler_config.json (whitelist/blacklist)
        ‚Üì
menu_crawler/src/
  ‚îî‚îÄ‚îÄ navigator.py (BFS –æ–±—Ö–æ–¥)
        ‚Üì
menu_crawler/reports/
  ‚îú‚îÄ‚îÄ report_*.json (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
  ‚îî‚îÄ‚îÄ report_*.md (–æ—Ç—á–µ—Ç—ã)
```

---

## üìù 9. –§–ê–ô–õ–´ –ò –ú–û–î–£–õ–ò (–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫)

### –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥

| –§–∞–π–ª | –°—Ç—Ä–æ–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-------|-----------|
| `menu_crawler/src/main.py` | ~100 | –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è |
| `menu_crawler/src/navigator.py` | ~400+ | BFS –æ–±—Ö–æ–¥ –º–µ–Ω—é |
| `menu_crawler/src/coverage_verifier.py` | ~150 | –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–∫—Ä—ã—Ç–∏—è |
| `menu_crawler/src/report_builder.py` | ~200+ | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤ |

### –£—Ç–∏–ª–∏—Ç—ã

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----------|
| `utils/checkpoint_manager.py` | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ |
| `utils/circuit_breaker.py` | Rate limit protection |
| `utils/cleanup.py` | Cleanup —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö |
| `utils/fsm_handler.py` | FSM input handling |
| `utils/logging_config.py` | Structured logging |

### –°–∫—Ä–∏–ø—Ç—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏

| –°–∫—Ä–∏–ø—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|--------|-----------|
| `scripts/create_user_session.py` | –°–æ–∑–¥–∞–Ω–∏–µ Pyrogram session |
| `scripts/build_menu_graph_v3.py` | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è menu_graph.json |
| `scripts/generate_test_data.py` | –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î |
| `scripts/set_test_user_super_admin.py` | –í—ã–¥–∞—á–∞ admin-–ø—Ä–∞–≤ |

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----------|
| `config/crawler_config.json` | Whitelist/blacklist |
| `config/menu_graph.json` | –û–∂–∏–¥–∞–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–Ω—é |
| `config/README.md` | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞ |

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----------|
| `LAUNCH_INSTRUCTIONS.md` | –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ |
| `TASK_COMPLETION_REPORT.md` | –û—Ç—á–µ—Ç –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ |

---

## üîç 10. –ü–ê–†–°–ò–ù–ì –ò –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–•

### –ö–∞–∫ –ø–∞—Ä—Å–∏—Ç—Å—è –º–µ–Ω—é

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `TASKS/00005_20251014_HRYHG/Implemt/menu_crawler/COMPLETE_MENU_TREE.md`

```bash
cd menu_crawler/scripts
python build_menu_graph_v3.py
# ‚Üì
# –ß–∏—Ç–∞–µ—Ç markdown —Å –¥–µ—Ä–µ–≤–æ–º –º–µ–Ω—é
# ‚Üì
# –ü–∞—Ä—Å–∏—Ç nodes –∏ edges
# ‚Üì
# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç menu_graph.json
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** (markdown):
```markdown
## Menu Tree

- menu_main (–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)
  - menu_chats (–ß–∞—Ç—ã)
    - chat_actions||{id} (–î–µ–π—Å—Ç–≤–∏—è —Å —á–∞—Ç–æ–º) [dynamic]
```

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** (JSON):
```json
{
  "nodes": {
    "menu_main": {"type": "menu", "depth": 0},
    "menu_chats": {"type": "menu", "depth": 1},
    "chat_actions||{id}": {"type": "action", "depth": 2, "dynamic": true}
  },
  "edges": [
    {"from": "menu_main", "to": "menu_chats", "callback_data": "menu_chats"}
  ]
}
```

---

## ‚öôÔ∏è 11. –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö –ò –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï

### Circuit Breaker –ø–∞—Ç—Ç–µ—Ä–Ω

```
CLOSED ‚Üí Normal operation
  ‚Üì (if errors > threshold)
OPEN ‚Üí Block requests, wait timeout
  ‚Üì (after timeout)
HALF_OPEN ‚Üí Test single request
  ‚Üì (if success)
CLOSED ‚úì  OR  OPEN ‚úó
```

### Rate Limiting

```python
# –í navigator.py:
await asyncio.sleep(2.0)  # throttle_delay –º–µ–∂–¥—É callback_query
# ‚Üì
# –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ FloodWait ‚Üí –∂–¥–µ–º —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
try:
    await self._send_callback(callback_data)
except FloodWait as e:
    await asyncio.sleep(e.value)  # –ñ–¥–µ–º —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
```

### Checkpoint —Å–∏—Å—Ç–µ–º–∞

```python
# –ö–∞–∂–¥—ã–µ 10 —É–∑–ª–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è progress.json
checkpoint_manager.save_checkpoint(visited_edges, queue)

# –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è:
checkpoint = checkpoint_manager.load_checkpoint()
# –ò –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –ø—Ä–µ—Ä–≤–∞–Ω–Ω–æ–≥–æ –º–µ—Å—Ç–∞
```

---

## üõ°Ô∏è 12. –ó–ê–©–ò–¢–ê –ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨

### –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

```env
# –í .env —Ñ–∞–π–ª–µ
TEST_USER_ID=155894817

# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
1. –û—Ç–¥–µ–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö
2. Cleanup –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
3. –ü—Ä–æ–≤–µ—Ä–∫–∏ –≤ navigator.py –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º
```

### Whitelist/Blacklist

```
‚úÖ –†–ê–ó–†–ï–®–ï–ù–û:
- –í—Å–µ –º–µ–Ω—é (menu_*)
- –ü—Ä–æ—Å–º–æ—Ç—Ä (view||*)
- –í—ã–±–æ—Ä (select||*)
- –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (delete||*)
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (access_*)

‚ùå –ó–ê–ü–†–ï–©–ï–ù–û:
- delete||all_reports
- reset_database
- dangerous_operations
```

### Validation

```python
# –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π callback_query:
if not _is_safe_navigation(callback_data):
    logger.warning(f"Blocked unsafe navigation: {callback_data}")
    return

# –ü–µ—Ä–µ–¥ cleanup:
if user_id != TEST_USER_ID:
    raise ValueError("Cleanup only allowed for TEST_USER_ID")
```

---

## üìà 13. –ú–ï–¢–†–ò–ö–ò –ò –õ–û–ì–ò–†–û–í–ê–ù–ò–ï

### Structured Logging (structlog)

```python
from utils.logging_config import get_logger

logger = get_logger("navigator")

# Logs –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:
logger.info("node_visited", from_node="menu_main", to_node="menu_chats")
# ‚Üì
{"event": "node_visited", "from": "menu_main", "to": "menu_chats", "timestamp": "2025-10-22T16:20:00Z"}
```

### –°–æ–±–∏—Ä–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏

- **Coverage**: total_visited / total_expected
- **Depth**: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏
- **Errors**: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ–±—Ö–æ–¥–µ
- **Performance**: –≤—Ä–µ–º—è –æ–±—Ö–æ–¥–∞ –≤—Å–µ—Ö —É–∑–ª–æ–≤
- **UX**: —É–∑–ª—ã –±–µ–∑ –∫–Ω–æ–ø–∫–∏ "–Ω–∞–∑–∞–¥", –≥–ª—É–±–æ–∫–∏–µ —É–∑–ª—ã

---

## üîß 14. –¢–û–ß–ö–ò –î–õ–Ø –í–ù–ï–°–ï–ù–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —É–∑–ª–æ–≤ –º–µ–Ω—é

```bash
# –§–∞–π–ª: TASKS/00005_20251014_HRYHG/Implemt/menu_crawler/COMPLETE_MENU_TREE.md
# –î–æ–±–∞–≤–∏—Ç—å —É–∑–µ–ª –≤ markdown

# –ó–∞—Ç–µ–º:
cd menu_crawler/scripts
python build_menu_graph_v3.py

# –û–±–Ω–æ–≤–∏—Ç—Å—è: menu_crawler/config/menu_graph.json
```

### 2. –ò–∑–º–µ–Ω–µ–Ω–∏–µ safe/forbidden actions

```json
# –§–∞–π–ª: menu_crawler/config/crawler_config.json

{
  "safe_navigation": [
    "new_menu_prefix"  // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–µ—Ñ–∏–∫—Å
  ],
  "forbidden_actions": [
    "dangerous_action"  // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—Ä–µ—Ç
  ]
}
```

### 3. –ò–∑–º–µ–Ω–µ–Ω–∏–µ throttle/timeout

```json
// –§–∞–π–ª: menu_crawler/config/crawler_config.json

{
  "throttle_delay": 2.0,      // –£–≤–µ–ª–∏—á–∏—Ç—å –µ—Å–ª–∏ rate limit
  "callback_timeout": 10      // –£–≤–µ–ª–∏—á–∏—Ç—å –µ—Å–ª–∏ timeout –æ—à–∏–±–∫–∏
}
```

### 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ FSM —É–∑–ª–æ–≤

```python
# –§–∞–π–ª: menu_crawler/src/utils/fsm_handler.py

class FSMHandler:
    async def handle_fsm_node(self, fsm_name: str, inputs: Dict):
        if fsm_name == "new_fsm_node":
            await self._input_data("value1")
            await self._input_data("value2")
```

### 5. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

```python
# –§–∞–π–ª: menu_crawler/src/utils/logging_config.py

def setup_logging():
    # –ù–∞—Å—Ç—Ä–æ–∏—Ç—å structlog (JSON format, log level, etc.)
    structlog.configure(
        processors=[
            structlog.processors.JSONRenderer()  # –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç
        ]
    )
```

### 6. –ò–∑–º–µ–Ω–µ–Ω–∏–µ cleanup –ª–æ–≥–∏–∫–∏

```python
# –§–∞–π–ª: menu_crawler/src/utils/cleanup.py

async def cleanup_test_data(user_id: int):
    # –î–æ–±–∞–≤–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü
    await db.delete("new_table", {"user_telegram_id": user_id})
```

---

## üìö 15. RELATED FILES –í SRC/

**–§–∞–π–ª—ã –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è Menu Crawler:**

```
src/
‚îú‚îÄ‚îÄ bot.py                  # Telegram bot –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
‚îú‚îÄ‚îÄ config.py              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (DB_CONFIG, etc.)
‚îú‚îÄ‚îÄ handlers.py            # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback_query
‚îú‚îÄ‚îÄ menus.py              # –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–µ–Ω—é
‚îú‚îÄ‚îÄ markups.py            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è inline keyboards
‚îú‚îÄ‚îÄ db_handler/db.py      # –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –ë–î
‚îú‚îÄ‚îÄ message_tracker.py    # –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îú‚îÄ‚îÄ parser.py             # –ü–∞—Ä—Å–∏–Ω–≥ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ analysis.py           # –ê–Ω–∞–ª–∏–∑ –∞—É–¥–∏–æ
‚îú‚îÄ‚îÄ audio_utils.py        # –£—Ç–∏–ª–∏—Ç—ã —Ä–∞–±–æ—Ç—ã —Å audio
‚îú‚îÄ‚îÄ auth_manager.py       # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º
‚îú‚îÄ‚îÄ constants.py          # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ datamodels.py         # –ú–∞–ø–ø–∏–Ω–≥–∏ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
```

---

## üéì 16. –ü–†–ò–ú–ï–†–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø

### –ü—Ä–∏–º–µ—Ä 1: –ó–∞–ø—É—Å–∫ –æ–±—Ö–æ–¥–∞

```bash
cd /home/voxpersona_user/VoxPersona
python3 -m menu_crawler.src.main

# –í—ã–≤–æ–¥:
# üöÄ –ù–∞—á–∞–ª–æ –æ–±—Ö–æ–¥–∞ –º–µ–Ω—é...
# ‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–∑–ª–∞: menu_main
# ‚úÖ –ü–æ—Å–µ—â–µ–Ω–æ: menu_main ‚Üí menu_chats
# ‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–∑–ª–∞: menu_chats
# ... (5-10 –º–∏–Ω—É—Ç) ...
# ‚úÖ –û–±—Ö–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω. –ü–æ—Å–µ—â–µ–Ω–æ —Ä—ë–±–µ—Ä: 123
```

### –ü—Ä–∏–º–µ—Ä 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—á–µ—Ç–∞

```bash
cat menu_crawler/reports/report_20251022_163000.json | jq '.coverage'

# –í—ã–≤–æ–¥:
# {
#   "total_expected": 104,
#   "total_visited": 104,
#   "coverage_percent": 100.0
# }
```

### –ü—Ä–∏–º–µ—Ä 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ cleanup

```sql
-- –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ, –≤ PostgreSQL
docker exec -it voxpersona_postgres psql -U voxpersona_user -d bot_db

SELECT COUNT(*) FROM transcription WHERE user_telegram_id = 155894817;
-- –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 0
```

---

## üìä 17. –°–¢–ê–¢–£–° –ö–û–ú–ü–û–ù–ï–ù–¢–ê

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|-----------|--------|-----------|
| MenuNavigator | ‚úÖ –ì–æ—Ç–æ–≤ | BFS, circuit breaker, throttling |
| CoverageVerifier | ‚úÖ –ì–æ—Ç–æ–≤ | –ü–æ–ª–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–∫—Ä—ã—Ç–∏—è |
| ReportBuilder | ‚úÖ –ì–æ—Ç–æ–≤ | JSON + Markdown –æ—Ç—á–µ—Ç—ã |
| CheckpointManager | ‚úÖ –ì–æ—Ç–æ–≤ | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ |
| FSMHandler | ‚úÖ –ì–æ—Ç–æ–≤ | –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö |
| Cleanup | ‚úÖ –ì–æ—Ç–æ–≤ | –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö |
| Logging | ‚úÖ –ì–æ—Ç–æ–≤ | Structured JSON logs |
| Documentation | ‚úÖ –ì–æ—Ç–æ–≤ | LAUNCH_INSTRUCTIONS.md |

---

## üéØ 18. –ò–¢–û–ì–û–í–´–ï –í–´–í–û–î–´

### ‚úÖ –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Menu Crawler

1. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ UI-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ Telegram –±–æ—Ç–∞
2. **BFS –æ–±—Ö–æ–¥** –≤—Å–µ—Ö 104 —É–∑–ª–æ–≤ –º–µ–Ω—é —Å 123 —Å–≤—è–∑—è–º–∏
3. **–ü–æ–ª–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–∫—Ä—ã—Ç–∏—è** (expected vs actual)
4. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤** (JSON + Markdown)
5. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π cleanup** —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î
6. **–ó–∞—â–∏—Ç–∞ –æ—Ç rate limits** —á–µ—Ä–µ–∑ circuit breaker –∏ throttling
7. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞** –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ–µ–≤

### ‚ùå –ß—Ç–æ –ù–ï –¥–µ–ª–∞–µ—Ç Menu Crawler

- ‚ùå –ù–µ –ø–∞—Ä—Å–∏—Ç –º–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
- ‚ùå –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å –≤–µ–±-—Å–∞–π—Ç–æ–≤
- ‚ùå –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã (—ç—Ç–æ –¥–µ–ª–∞–µ—Ç analysis.py)
- ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å API —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
- ‚ùå –ù–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é (—ç—Ç–æ –¥–µ–ª–∞–µ—Ç OpenAI Whisper)

### üéØ –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å

**Menu Crawler** - —ç—Ç–æ **–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ä–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** UI –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –∏ –º–µ–Ω—é —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏ –≤—Å–µ —É–∑–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã.

---

**–ö–û–ù–ï–¶ –û–¢–ß–ï–¢–ê**

*–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ VERY THOROUGH –º–µ—Ç–æ–¥–æ–º* 
*–î–∞—Ç–∞: 4 –Ω–æ—è–±—Ä—è 2025*
*–û–±—ä–µ–º –∞–Ω–∞–ª–∏–∑–∞: 20+ —Ñ–∞–π–ª–æ–≤, 2000+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞*
